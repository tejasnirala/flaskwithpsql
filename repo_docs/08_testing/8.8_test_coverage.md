# 8.8 Test Coverage

> **Measuring How Much of Your Code is Tested**

This document explains code coverage - what it is, how to measure it, and how to interpret the results.

---

## Table of Contents

1. [What is Test Coverage?](#what-is-test-coverage)
2. [Running Coverage Reports](#running-coverage-reports)
3. [Understanding the Report](#understanding-the-report)
4. [Coverage Metrics](#coverage-metrics)
5. [Improving Coverage](#improving-coverage)
6. [Coverage Goals](#coverage-goals)

---

## What is Test Coverage?

### Definition

**Test coverage** measures which parts of your code are executed when tests run.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Coverage Visualization                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  def create_user(data):                                                  │
│ ✅    user = User(username=data.username)      ← Executed by tests      │
│ ✅    if user.email_exists():                  ← Executed by tests      │
│ ✅        raise UserExistsError()              ← Executed by tests      │
│ ❌    if some_rare_condition:                  ← NOT executed!          │
│ ❌        handle_rare_case()                   ← NOT executed!          │
│ ✅    db.session.add(user)                     ← Executed by tests      │
│ ✅    return user                              ← Executed by tests      │
│                                                                          │
│  Coverage: 6/8 lines = 75%                                              │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Why Coverage Matters

| Benefit                | Description                       |
| ---------------------- | --------------------------------- |
| **Find untested code** | Identify paths that have no tests |
| **Measure progress**   | Track test completeness over time |
| **Catch edge cases**   | Find branches that aren't tested  |
| **CI integration**     | Fail builds if coverage drops     |

### Coverage ≠ Quality

⚠️ **Important:** High coverage doesn't mean tests are good!

```python
# 100% coverage but useless test
def test_user_creation():
    create_user(data)  # Runs the code
    # No assertions! We don't check if it worked!
```

Coverage tells you what's **executed**, not what's **verified**.

---

## Running Coverage Reports

### Basic Coverage

```bash
# Run tests with coverage
pytest --cov=app

# Output:
# ---------- coverage: platform darwin, python 3.11 ----------
# Name                     Stmts   Miss  Cover
# --------------------------------------------
# app/__init__.py             45      0   100%
# app/models/user.py          68     12    82%
# app/services/user_service.py 98     15    85%
# --------------------------------------------
# TOTAL                      211     27    87%
```

### Detailed Report

```bash
# Show which lines are missing
pytest --cov=app --cov-report=term-missing

# Output:
# Name                     Stmts   Miss  Cover   Missing
# ------------------------------------------------------
# app/services/user_service.py  98     15    85%   42-45, 78, 92-98
```

### HTML Report

```bash
# Generate HTML report
pytest --cov=app --cov-report=html

# Open the report
open htmlcov/index.html
```

The HTML report provides an interactive interface:

-   Color-coded source files
-   Click to see which lines are covered/uncovered
-   Drill down into specific files

### Multiple Report Formats

```bash
# Generate multiple formats
pytest --cov=app \
    --cov-report=term-missing \
    --cov-report=html \
    --cov-report=xml
```

| Format         | Output                    | Use Case                 |
| -------------- | ------------------------- | ------------------------ |
| `term`         | Console summary           | Quick check              |
| `term-missing` | Console with line numbers | See missing lines        |
| `html`         | `htmlcov/index.html`      | Interactive review       |
| `xml`          | `coverage.xml`            | CI tools (Codecov, etc.) |

---

## Understanding the Report

### Terminal Report

```
Name                              Stmts   Miss  Cover   Missing
---------------------------------------------------------------
app/__init__.py                      45      0   100%
app/models/__init__.py                5      0   100%
app/models/user.py                   68     12    82%   45-47, 89-95, 112
app/services/__init__.py              3      0   100%
app/services/user_service.py         98     15    85%   42-45, 78, 92-98
app/routes/v1/__init__.py             8      0   100%
app/routes/v1/users.py               75      8    89%   67-72, 95-98
---------------------------------------------------------------
TOTAL                               302     35    88%
```

### Columns Explained

| Column    | Meaning                                 |
| --------- | --------------------------------------- |
| `Stmts`   | Total statements that could be executed |
| `Miss`    | Statements NOT executed by tests        |
| `Cover`   | Percentage of statements covered        |
| `Missing` | Line numbers not covered                |

### HTML Report

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    HTML Coverage Report                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  File: app/services/user_service.py                        Coverage: 85%│
│  ───────────────────────────────────────────────────────────────────────│
│                                                                          │
│  41 │     def authenticate(email: str, password: str):                  │
│  42 │ ███     user = User.query.filter_by(email=email).first()          │
│  43 │ ███     if not user:                                              │
│  44 │ ███         raise UserNotFoundError(email)                        │
│  45 │ ░░░     if user.is_locked:            ← Not covered!              │
│  46 │ ░░░         raise AccountLockedError()                            │
│  47 │ ███     if not user.check_password(password):                     │
│  48 │ ███         raise InvalidCredentialsError()                       │
│                                                                          │
│  ███ = Covered    ░░░ = Not covered                                     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Coverage Metrics

### Line Coverage (Default)

Measures which **lines** were executed.

```python
def process(value):
    if value > 0:        # Line 1
        return "positive" # Line 2
    else:                # Line 3
        return "negative" # Line 4

# Test only positive case
test_positive()  # Covers lines 1, 2
# Line coverage: 2/4 = 50%
```

### Branch Coverage

Measures which **branches** (if/else paths) were taken.

```bash
pytest --cov=app --cov-branch
```

```python
def process(value):
    if value > 0:        # Branch: True or False?
        return "positive"
    else:
        return "negative"

# Test only positive case
test_positive()
# Branch coverage: 1/2 branches = 50%
```

### Comparison

| Metric     | What it Measures    | Better for     |
| ---------- | ------------------- | -------------- |
| **Line**   | Lines executed      | Basic coverage |
| **Branch** | If/else paths taken | Logic coverage |

---

## Improving Coverage

### Step 1: Identify Uncovered Code

```bash
pytest --cov=app --cov-report=term-missing
```

Look at the `Missing` column.

### Step 2: Analyze Why It's Missing

| Reason                   | Example                 |
| ------------------------ | ----------------------- |
| **Error handling**       | Exception handling code |
| **Edge cases**           | Empty list, null values |
| **Rarely used features** | Admin-only functions    |
| **Dead code**            | Unused functions        |

### Step 3: Add Tests or Remove Code

```python
# Before: Line 45-47 not covered
def create_user(data):
    user = User(...)
    if user.is_admin:           # Line 45 - never tested
        log_admin_creation()    # Line 46 - never tested
        notify_security()       # Line 47 - never tested
    db.session.add(user)

# After: Add test for admin case
def test_create_admin_user(db):
    data = UserCreateSchema(is_admin=True, ...)
    user = UserService.create_user(data)
    # Now lines 45-47 are covered
```

### Step 4: Exclude Intentionally Uncovered Code

```python
# Exclude with pragma comment
if some_debug_condition:  # pragma: no cover
    debug_only_function()
```

Or configure in `pyproject.toml`:

```toml
[tool.coverage.run]
omit = [
    "tests/*",
    "migrations/*",
    "*/conftest.py",
]
```

---

## Coverage Goals

### Industry Standards

| Coverage Level | Description                             |
| -------------- | --------------------------------------- |
| **< 50%**      | Minimal coverage, high risk             |
| **50-70%**     | Basic coverage, some protection         |
| **70-80%**     | Good coverage, most paths tested        |
| **80-90%**     | High coverage, recommended target       |
| **> 90%**      | Excellent, may have diminishing returns |

### Our Recommendation

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Coverage Goals                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Target: 80% overall coverage                                           │
│                                                                          │
│  Critical paths (auth, payments): 90%+                                  │
│  Business logic (services):       85%+                                  │
│  Models:                          80%+                                  │
│  Routes:                          75%+                                  │
│  Utilities:                       70%+                                  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Setting Minimum Coverage in CI

```bash
# Fail if coverage drops below 80%
pytest --cov=app --cov-fail-under=80
```

In GitHub Actions:

```yaml
- name: Run tests with coverage
  run: pytest --cov=app --cov-fail-under=80
```

---

## Summary

### Quick Reference

| Command                                      | Purpose                 |
| -------------------------------------------- | ----------------------- |
| `pytest --cov=app`                           | Basic coverage          |
| `pytest --cov=app --cov-report=term-missing` | Show missing lines      |
| `pytest --cov=app --cov-report=html`         | HTML report             |
| `pytest --cov=app --cov-branch`              | Include branch coverage |
| `pytest --cov=app --cov-fail-under=80`       | Fail if below 80%       |

### Key Takeaways

1. **Coverage ≠ Quality** - Verify code, don't just execute it
2. **80% is a good target** - Diminishing returns beyond 90%
3. **Focus on critical paths** - Auth, payments need higher coverage
4. **Don't chase 100%** - Some code isn't worth testing
5. **Use HTML reports** - Easier to find gaps

---

## Next Steps

-   **[8.9 Testing Strategies](./8.9_testing_strategies.md)** - Unit vs Integration vs E2E
-   **[8.1 Testing Overview](./8.1_testing_overview.md)** - Testing fundamentals

---

> **Related Documentation:**
>
> -   [pytest-cov documentation](https://pytest-cov.readthedocs.io/)
> -   [Codecov](https://codecov.io/) - Coverage reporting service
