# 8.3 Fixtures Explained

> **Reusable Test Setup with pytest Fixtures**

This document explains pytest fixtures - a powerful mechanism for test setup and teardown that promotes code reuse.

---

## Table of Contents

1. [What Are Fixtures?](#what-are-fixtures)
2. [Basic Fixtures](#basic-fixtures)
3. [Fixture Scopes](#fixture-scopes)
4. [Fixture Dependencies](#fixture-dependencies)
5. [Teardown and Cleanup](#teardown-and-cleanup)
6. [Built-in Fixtures](#built-in-fixtures)
7. [Fixture Patterns](#fixture-patterns)

---

## What Are Fixtures?

### The Problem: Repeated Setup

```python
# Without fixtures - lots of repetition!

def test_create_user():
    # Setup
    app = create_app("testing")
    with app.app_context():
        db.create_all()

        # Test
        user = create_user("john")
        assert user.id is not None

        # Cleanup
        db.drop_all()

def test_update_user():
    # Same setup again!
    app = create_app("testing")
    with app.app_context():
        db.create_all()

        # Test
        user = create_user("john")
        updated = update_user(user.id, {"name": "Jane"})
        assert updated.name == "Jane"

        # Same cleanup again!
        db.drop_all()
```

### The Solution: Fixtures

```python
# With fixtures - clean and reusable!

@pytest.fixture
def app():
    """Create application for testing."""
    app = create_app("testing")
    yield app

@pytest.fixture
def db(app):
    """Set up database for each test."""
    with app.app_context():
        db.create_all()
        yield db
        db.drop_all()

# Tests are now clean!
def test_create_user(db):
    user = create_user("john")
    assert user.id is not None

def test_update_user(db):
    user = create_user("john")
    updated = update_user(user.id, {"name": "Jane"})
    assert updated.name == "Jane"
```

### Fixtures vs Jest's beforeEach

```javascript
// Jest - beforeEach runs before every test
let db;

beforeEach(() => {
    db = setupDatabase();
});

afterEach(() => {
    db.cleanup();
});

test("creates user", () => {
    // db is available
});
```

```python
# pytest - fixtures are injected as parameters
@pytest.fixture
def db():
    db = setup_database()
    yield db
    db.cleanup()

def test_creates_user(db):  # ← db is injected
    # db is available
    pass
```

---

## Basic Fixtures

### Defining a Fixture

```python
import pytest

@pytest.fixture
def sample_data():
    """Provide sample data for tests."""
    return {
        "username": "testuser",
        "email": "test@example.com",
        "password": "SecurePass123!"
    }
```

### Using a Fixture

```python
def test_user_registration(sample_data):
    """Test uses sample_data fixture."""
    user = register_user(**sample_data)
    assert user.username == sample_data["username"]
```

### Fixture Returning Objects

```python
@pytest.fixture
def sample_user(db):
    """Create and return a sample user."""
    user = User(
        username="testuser",
        email="test@example.com",
        first_name="Test",
        last_name="User"
    )
    user.set_password("TestPassword123!")

    db.session.add(user)
    db.session.commit()

    return user


def test_user_has_id(sample_user):
    """User fixture provides a User with ID."""
    assert sample_user.id is not None
    assert sample_user.username == "testuser"
```

---

## Fixture Scopes

### Scope Options

| Scope      | Lifetime                          | Use Case           |
| ---------- | --------------------------------- | ------------------ |
| `function` | Once per test function (default)  | Database cleanup   |
| `class`    | Once per test class               | Shared class state |
| `module`   | Once per test module (file)       | Expensive setup    |
| `package`  | Once per test package (directory) | Shared resources   |
| `session`  | Once per test session             | App creation       |

### Scope Examples

```python
@pytest.fixture(scope="session")
def app():
    """Create app once for entire test session."""
    app = create_app("testing")
    yield app

@pytest.fixture(scope="function")
def db(app):
    """Fresh database for each test function."""
    with app.app_context():
        _db.create_all()
        yield _db
        _db.session.remove()
        _db.drop_all()
```

### Scope Visualization

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Fixture Scopes                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  scope="session"                                                 │    │
│  │  ┌───────────────────────────────────────────────────────────┐  │    │
│  │  │  app fixture - created once                                │  │    │
│  │  └───────────────────────────────────────────────────────────┘  │    │
│  │                                                                  │    │
│  │  ┌───────────────────────────────────────────────────────────┐  │    │
│  │  │  scope="module" - once per test file                       │  │    │
│  │  │                                                            │  │    │
│  │  │  ┌─────────────────────────────────────────────────────┐  │  │    │
│  │  │  │  scope="function" - once per test                   │  │  │    │
│  │  │  │                                                     │  │  │    │
│  │  │  │  test_1  →  db created  →  test runs  →  db dropped│  │  │    │
│  │  │  │  test_2  →  db created  →  test runs  →  db dropped│  │  │    │
│  │  │  │  test_3  →  db created  →  test runs  →  db dropped│  │  │    │
│  │  │  │                                                     │  │  │    │
│  │  │  └─────────────────────────────────────────────────────┘  │  │    │
│  │  │                                                            │  │    │
│  │  └───────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Fixture Dependencies

### Fixtures Can Use Other Fixtures

```python
@pytest.fixture
def app():
    """Base app fixture."""
    app = create_app("testing")
    yield app

@pytest.fixture
def db(app):
    """Database depends on app."""
    with app.app_context():
        _db.create_all()
        yield _db
        _db.drop_all()

@pytest.fixture
def client(app, db):
    """Client depends on app and db."""
    with app.test_client() as client:
        yield client

@pytest.fixture
def sample_user(db):
    """Sample user depends on db."""
    user = User(username="test", email="test@example.com")
    user.set_password("password")
    db.session.add(user)
    db.session.commit()
    return user
```

### Dependency Chain

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Fixture Dependencies                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Test function: test_get_user(client, sample_user)                      │
│                                                                          │
│  Fixture resolution:                                                     │
│                                                                          │
│  1. client needs app and db                                             │
│  2. sample_user needs db                                                │
│  3. db needs app                                                        │
│  4. app needs nothing                                                   │
│                                                                          │
│  Resolution order:                                                       │
│                                                                          │
│      app                                                                │
│       │                                                                 │
│       ▼                                                                 │
│      db                                                                 │
│       │                                                                 │
│       ├──────────────┬──────────────┐                                   │
│       ▼              ▼              ▼                                   │
│    client      sample_user       test                                   │
│                                    │                                    │
│                                    ▼                                    │
│                            test_get_user()                              │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Teardown and Cleanup

### Using `yield` for Cleanup

```python
@pytest.fixture
def db(app):
    """Setup before yield, cleanup after."""
    with app.app_context():
        # SETUP - runs before test
        _db.create_all()

        yield _db  # ← Test runs here

        # TEARDOWN - runs after test
        _db.session.remove()
        _db.drop_all()
```

### Cleanup Visualization

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Fixture Lifecycle                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  1. Test function called                                                │
│      │                                                                   │
│      ▼                                                                   │
│  2. Fixtures resolved                                                    │
│      │                                                                   │
│      ▼                                                                   │
│  3. ┌────────────────────────────────────────────────────────────────┐  │
│     │  SETUP (before yield)                                          │  │
│     │  _db.create_all()                                              │  │
│     └────────────────────────────────────────────────────────────────┘  │
│      │                                                                   │
│      ▼                                                                   │
│  4. ┌────────────────────────────────────────────────────────────────┐  │
│     │  yield _db                                                     │  │
│     │                                                                │  │
│     │  TEST FUNCTION RUNS                                            │  │
│     │  (uses _db)                                                    │  │
│     │                                                                │  │
│     └────────────────────────────────────────────────────────────────┘  │
│      │                                                                   │
│      ▼                                                                   │
│  5. ┌────────────────────────────────────────────────────────────────┐  │
│     │  TEARDOWN (after yield)                                        │  │
│     │  _db.session.remove()                                          │  │
│     │  _db.drop_all()                                                │  │
│     └────────────────────────────────────────────────────────────────┘  │
│      │                                                                   │
│      ▼                                                                   │
│  6. Test complete                                                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Cleanup Even on Test Failure

```python
@pytest.fixture
def temp_file():
    """Create temp file, ensure cleanup even if test fails."""
    import tempfile
    import os

    # Setup
    fd, path = tempfile.mkstemp()
    os.close(fd)

    yield path

    # Teardown - ALWAYS runs, even if test fails!
    if os.path.exists(path):
        os.unlink(path)
```

---

## Built-in Fixtures

### Common pytest Fixtures

| Fixture       | Purpose                              |
| ------------- | ------------------------------------ |
| `tmp_path`    | Temporary directory (Path object)    |
| `tmpdir`      | Temporary directory (py.path object) |
| `capsys`      | Capture stdout/stderr                |
| `caplog`      | Capture log messages                 |
| `monkeypatch` | Mock/patch objects                   |
| `request`     | Fixture request information          |

### Examples

```python
def test_with_temp_file(tmp_path):
    """tmp_path provides a temporary directory."""
    file = tmp_path / "test.txt"
    file.write_text("hello")

    assert file.read_text() == "hello"

def test_print_output(capsys):
    """capsys captures print output."""
    print("Hello, World!")

    captured = capsys.readouterr()
    assert "Hello" in captured.out

def test_log_message(caplog):
    """caplog captures log messages."""
    import logging
    logger = logging.getLogger(__name__)

    logger.info("Test message")

    assert "Test message" in caplog.text

def test_with_mock(monkeypatch):
    """monkeypatch mocks objects."""
    monkeypatch.setenv("API_KEY", "test-key")

    import os
    assert os.environ["API_KEY"] == "test-key"
```

---

## Fixture Patterns

### Pattern 1: Factory Fixtures

Create multiple instances with different configurations:

```python
@pytest.fixture
def make_user(db):
    """Factory fixture to create users."""
    created_users = []

    def _make_user(username, email=None, **kwargs):
        email = email or f"{username}@example.com"
        user = User(username=username, email=email, **kwargs)
        user.set_password("password123")
        db.session.add(user)
        db.session.commit()
        created_users.append(user)
        return user

    yield _make_user

    # Cleanup all created users
    for user in created_users:
        db.session.delete(user)
    db.session.commit()


def test_multiple_users(make_user):
    """Create multiple users with factory."""
    alice = make_user("alice")
    bob = make_user("bob")
    admin = make_user("admin", is_admin=True)

    assert alice.username == "alice"
    assert bob.username == "bob"
    assert admin.is_admin is True
```

### Pattern 2: Request-Parameterized Fixtures

```python
@pytest.fixture(params=["sqlite", "postgres"])
def database(request):
    """Test with multiple database backends."""
    if request.param == "sqlite":
        db = create_sqlite_db()
    else:
        db = create_postgres_db()

    yield db
    db.cleanup()


def test_save_user(database):
    """This test runs twice - once for each database."""
    user = User(username="test")
    database.save(user)
    assert database.get(user.id) is not None
```

### Pattern 3: Fixture Composition

```python
@pytest.fixture
def admin_user(make_user):
    """Create an admin user."""
    return make_user("admin", is_admin=True)

@pytest.fixture
def regular_user(make_user):
    """Create a regular user."""
    return make_user("regular")

@pytest.fixture
def authenticated_client(client, regular_user):
    """Client with authentication."""
    # Login
    client.post("/login", json={
        "email": regular_user.email,
        "password": "password123"
    })
    return client
```

---

## Summary

### Key Concepts

| Concept           | Purpose                           |
| ----------------- | --------------------------------- |
| `@pytest.fixture` | Decorator to create a fixture     |
| `yield`           | Separates setup from teardown     |
| `scope`           | Controls fixture lifetime         |
| Dependencies      | Fixtures can use other fixtures   |
| `conftest.py`     | Shared fixtures across test files |

### Quick Reference

```python
# Basic fixture
@pytest.fixture
def sample_data():
    return {"key": "value"}

# Fixture with cleanup
@pytest.fixture
def db():
    db = create_db()
    yield db
    db.drop()

# Session-scoped fixture
@pytest.fixture(scope="session")
def app():
    return create_app("testing")

# Fixture depending on another
@pytest.fixture
def client(app):
    return app.test_client()
```

---

## Next Steps

-   **[8.4 Conftest File](./8.4_conftest_file.md)** - Our shared fixtures
-   **[8.5 Model Tests](./8.5_model_tests.md)** - Testing models

---

> **Related Documentation:**
>
> -   [tests/conftest.py](../../tests/conftest.py) - Our fixtures
> -   [pytest fixtures documentation](https://docs.pytest.org/en/latest/fixture.html)
