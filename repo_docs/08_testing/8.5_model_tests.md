# 8.5 Model Tests

> **Testing Database Models (Unit Tests)**

This document explains how we test our SQLAlchemy models, focusing on model behavior, validation, and serialization.

---

## Table of Contents

1. [What Are Model Tests?](#what-are-model-tests)
2. [What to Test](#what-to-test)
3. [Our Model Tests](#our-model-tests)
4. [Line-by-Line Examples](#line-by-line-examples)
5. [Best Practices](#best-practices)
6. [Common Patterns](#common-patterns)

---

## What Are Model Tests?

### Definition

Model tests verify that your ORM models work correctly:

-   Fields store data properly
-   Methods work as expected
-   Relationships are set up correctly
-   Serialization is correct

### Position in Testing Pyramid

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Model Tests in the Pyramid                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│                            /\                                            │
│                           /  \                                           │
│                          / E2E\                                          │
│                         /──────\                                         │
│                        /        \                                        │
│                       / Service  \                                       │
│                      /   Tests    \                                      │
│                     /──────────────\                                     │
│                    /                \                                    │
│                   /   Model Tests    \  ← We are here                   │
│                  /   (Unit Tests)     \                                  │
│                 /______________________\                                 │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## What to Test

### Test These ✅

| Category          | Examples                                       |
| ----------------- | ---------------------------------------------- |
| **Creation**      | Object creates with correct defaults           |
| **Methods**       | `set_password()`, `soft_delete()`, `to_dict()` |
| **Properties**    | Computed properties work correctly             |
| **Relationships** | Foreign keys, backrefs work                    |
| **Timestamps**    | `created_at`, `updated_at` are set             |
| **Constraints**   | Unique constraints, not null                   |

### Don't Test These ❌

| Category             | Why                                  |
| -------------------- | ------------------------------------ |
| SQLAlchemy internals | They're already tested by SQLAlchemy |
| Basic CRUD           | Save/load is SQLAlchemy's job        |
| Database schema      | Test via migrations, not model tests |

---

## Our Model Tests

### File: `tests/test_models/test_user.py`

```python
"""
Tests for User Model.

These tests verify the User model's functionality including:
- Password hashing and verification
- Soft delete functionality
- Serialization methods
"""

from app.models.user import User


class TestUserModel:
    """Test suite for User model."""

    def test_create_user(self, db):
        """Test creating a new user."""
        # ...

    def test_password_hashing(self, db):
        """Test that passwords are properly hashed."""
        # ...

    def test_password_verification(self, sample_user):
        """Test password verification works correctly."""
        # ...

    def test_soft_delete(self, sample_user, db):
        """Test soft delete functionality."""
        # ...

    def test_restore(self, sample_user, db):
        """Test restore after soft delete."""
        # ...

    def test_to_dict(self, sample_user):
        """Test to_dict serialization."""
        # ...

    def test_timestamps(self, sample_user):
        """Test that timestamps are set."""
        # ...

    def test_repr(self, sample_user):
        """Test string representation."""
        # ...
```

---

## Line-by-Line Examples

### Test 1: Create User

```python
def test_create_user(self, db):
    """Test creating a new user."""
    # ARRANGE - Create a User object
    user = User(
        username="newuser",
        email="new@example.com",
        first_name="New",
        last_name="User",
    )
    user.set_password("SecurePass123!")

    # ACT - Save to database
    db.session.add(user)
    db.session.commit()

    # ASSERT - Verify all fields
    assert user.id is not None           # ID assigned by database
    assert user.username == "newuser"    # Username saved
    assert user.email == "new@example.com"
    assert user.is_deleted is False      # Default value
    assert user.is_active is True        # Default value
```

**What this tests:**

-   User can be created with required fields
-   Default values are set correctly
-   Database assigns an ID

---

### Test 2: Password Hashing

```python
def test_password_hashing(self, db):
    """Test that passwords are properly hashed."""
    # ARRANGE
    user = User(
        username="passtest",
        email="pass@example.com",
        first_name="Pass",
    )
    password = "SecurePass123!"

    # ACT
    user.set_password(password)

    # ASSERT
    # Password should be hashed, not stored in plain text
    assert user.password_hash != password
    assert user.password_hash.startswith("pbkdf2:sha256:")
```

**What this tests:**

-   `set_password()` doesn't store plaintext
-   Correct hashing algorithm is used (PBKDF2 SHA256)
-   Hash format is correct

**Security check:** Never store passwords in plaintext!

---

### Test 3: Password Verification

```python
def test_password_verification(self, sample_user):
    """Test password verification works correctly."""
    # sample_user fixture has password "TestPassword123!"

    # Correct password should verify
    assert sample_user.check_password("TestPassword123!") is True

    # Wrong password should fail
    assert sample_user.check_password("WrongPassword123!") is False
```

**What this tests:**

-   `check_password()` returns True for correct password
-   `check_password()` returns False for incorrect password

---

### Test 4: Soft Delete

```python
def test_soft_delete(self, sample_user, db):
    """Test soft delete functionality."""
    # ARRANGE - Verify not deleted initially
    assert sample_user.is_deleted is False

    # ACT - Soft delete
    sample_user.soft_delete()
    db.session.commit()

    # ASSERT
    assert sample_user.is_deleted is True
```

**What this tests:**

-   `soft_delete()` sets `is_deleted` to True
-   Record stays in database (not actually deleted)

---

### Test 5: Restore

```python
def test_restore(self, sample_user, db):
    """Test restore after soft delete."""
    # ARRANGE - Soft delete first
    sample_user.soft_delete()
    db.session.commit()
    assert sample_user.is_deleted is True

    # ACT - Restore
    sample_user.restore()
    db.session.commit()

    # ASSERT
    assert sample_user.is_deleted is False
```

**What this tests:**

-   `restore()` reverses soft delete
-   User can be "undeleted"

---

### Test 6: Serialization

```python
def test_to_dict(self, sample_user):
    """Test to_dict serialization."""
    # ACT
    user_dict = sample_user.to_dict()

    # ASSERT - Expected fields present
    assert "id" in user_dict
    assert user_dict["username"] == "testuser"
    assert user_dict["email"] == "test@example.com"
    assert user_dict["first_name"] == "Test"

    # SECURITY ASSERT - Sensitive fields NOT present
    assert "password_hash" not in user_dict
    assert "password" not in user_dict
```

**What this tests:**

-   `to_dict()` includes expected fields
-   **Security:** Password hash is excluded from serialization

---

### Test 7: Timestamps

```python
def test_timestamps(self, sample_user):
    """Test that timestamps are set."""
    assert sample_user.created_at is not None
    assert sample_user.updated_at is not None
```

**What this tests:**

-   `created_at` is automatically set
-   `updated_at` is automatically set

---

### Test 8: String Representation

```python
def test_repr(self, sample_user):
    """Test string representation."""
    assert repr(sample_user) == "<User testuser>"
```

**What this tests:**

-   `__repr__` method returns expected format
-   Useful for debugging

---

## Best Practices

### 1. Use Fixtures for Setup

```python
# Good - Use fixture
def test_something(self, sample_user):
    assert sample_user.username == "testuser"

# Bad - Repeat setup in test
def test_something(self, db):
    user = User(username="testuser", ...)  # Repeated setup!
    db.session.add(user)
    db.session.commit()
    assert user.username == "testuser"
```

### 2. Test One Thing Per Test

```python
# Good - One assertion per concept
def test_password_verification_correct(self, sample_user):
    assert sample_user.check_password("TestPassword123!") is True

def test_password_verification_incorrect(self, sample_user):
    assert sample_user.check_password("wrong") is False

# OK - Related assertions together
def test_password_verification(self, sample_user):
    assert sample_user.check_password("TestPassword123!") is True
    assert sample_user.check_password("wrong") is False
```

### 3. Test Edge Cases

```python
def test_empty_password(self, db):
    """Empty password should still be handled."""
    user = User(username="test", email="test@example.com")
    user.set_password("")

    assert user.check_password("") is True
    assert user.check_password("anything") is False

def test_unicode_username(self, db):
    """Unicode characters in username."""
    user = User(username="用户", email="unicode@example.com")
    db.session.add(user)
    db.session.commit()

    assert user.username == "用户"
```

### 4. Test Security-Critical Behavior

```python
def test_password_not_in_serialization(self, sample_user):
    """Ensure password never leaks in serialization."""
    user_dict = sample_user.to_dict()

    # Check multiple possible field names
    assert "password" not in user_dict
    assert "password_hash" not in user_dict
    assert "_password" not in user_dict
```

---

## Common Patterns

### Pattern 1: Testing Relationships

```python
def test_user_has_posts(self, sample_user, db):
    """Test user-post relationship."""
    # Create a post for user
    post = Post(title="Test", user=sample_user)
    db.session.add(post)
    db.session.commit()

    # Test relationship from both sides
    assert post in sample_user.posts
    assert post.user == sample_user
```

### Pattern 2: Testing Unique Constraints

```python
def test_duplicate_email_fails(self, sample_user, db):
    """Test that duplicate emails are rejected."""
    duplicate = User(
        username="different",
        email=sample_user.email,  # Same email!
    )

    with pytest.raises(IntegrityError):
        db.session.add(duplicate)
        db.session.commit()
```

### Pattern 3: Testing Computed Properties

```python
def test_full_name_property(self, sample_user):
    """Test computed full_name property."""
    assert sample_user.full_name == "Test User"

def test_full_name_with_no_last_name(self, db):
    """Test full_name when last_name is None."""
    user = User(username="test", email="test@example.com", first_name="Only")
    assert user.full_name == "Only"
```

---

## Summary

### What Model Tests Cover

| Test               | Purpose                             |
| ------------------ | ----------------------------------- |
| `test_create_user` | Basic creation and defaults         |
| `test_password_*`  | Security-critical password handling |
| `test_soft_delete` | Soft delete behavior                |
| `test_restore`     | Restore behavior                    |
| `test_to_dict`     | Serialization and security          |
| `test_timestamps`  | Automatic timestamps                |
| `test_repr`        | String representation               |

### Key Takeaways

1. **Test methods, not SQLAlchemy** - Focus on your code
2. **Always test security** - Password handling, serialization
3. **Use fixtures** - Don't repeat setup code
4. **Test edge cases** - Empty values, special characters

---

## Next Steps

-   **[8.6 Service Tests](./8.6_service_tests.md)** - Testing business logic
-   **[8.7 Route Tests](./8.7_route_tests.md)** - Testing API endpoints

---

> **Related Documentation:**
>
> -   [tests/test_models/test_user.py](../../tests/test_models/test_user.py)
> -   [app/models/user.py](../../app/models/user.py)
