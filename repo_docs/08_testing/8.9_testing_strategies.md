# 8.9 Testing Strategies

> **Choosing the Right Type of Test for Each Situation**

This document compares unit, integration, and end-to-end testing strategies and provides guidance on when to use each.

---

## Table of Contents

1. [Testing Strategy Overview](#testing-strategy-overview)
2. [Unit Tests](#unit-tests)
3. [Integration Tests](#integration-tests)
4. [End-to-End Tests](#end-to-end-tests)
5. [Comparison Table](#comparison-table)
6. [When to Use What](#when-to-use-what)
7. [Our Testing Strategy](#our-testing-strategy)

---

## Testing Strategy Overview

### The Testing Pyramid

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    The Testing Pyramid                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│                            /\           Fewer tests                      │
│                           /E2E\         Slower                           │
│                          /Tests\        More expensive                   │
│                         /────────\      Tests full system               │
│                        /          \                                      │
│                       / Integration\    Medium tests                     │
│                      /    Tests     \   Tests components together       │
│                     /────────────────\                                   │
│                    /                  \                                  │
│                   /    Unit Tests      \  Most tests                    │
│                  /                      \ Fast, cheap                   │
│                 /  Tests isolated units  \ Tests single components      │
│                /________________________\_                              │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### The Diamond/Ice Cream Cone (Anti-Pattern)

```
       ❌ Don't do this:

           /\       ← Many E2E tests (slow, flaky)
          /  \
         /    \
        /      \
       /________\
          /\      ← Some integration
         /__\
          /\      ← Few unit tests
         /__\
```

---

## Unit Tests

### Definition

Test a single unit of code **in isolation** from dependencies.

```python
# Unit test - tests User model in isolation
def test_password_hashing():
    user = User(username="test", email="test@example.com")
    user.set_password("secret123")

    assert user.check_password("secret123") is True
    assert user.check_password("wrong") is False
```

### Characteristics

| Aspect           | Unit Tests                   |
| ---------------- | ---------------------------- |
| **Scope**        | Single function/method/class |
| **Speed**        | Very fast (milliseconds)     |
| **Dependencies** | Mocked/stubbed               |
| **Database**     | Not used (usually)           |
| **Reliability**  | Very high (no external deps) |

### Pros ✅

-   **Fast** - Run thousands in seconds
-   **Reliable** - No external dependencies
-   **Specific** - Pinpoint exact failures
-   **Cheap** - Easy to write and maintain

### Cons ❌

-   **Limited scope** - Miss integration issues
-   **Mocking overhead** - Can be complex
-   **False confidence** - Units work alone but not together

### When to Use

-   Pure functions
-   Model methods
-   Utility functions
-   Input validation
-   Business rules

---

## Integration Tests

### Definition

Test multiple components working **together**, including real dependencies.

```python
# Integration test - tests Service + Model + Database
def test_create_user_integration(db):
    data = UserCreateSchema(
        username="test",
        email="test@example.com",
        password="SecurePass123!"
    )

    user = UserService.create_user(data)

    # Verify it's actually in the database
    saved_user = db.session.get(User, user.id)
    assert saved_user.username == "test"
```

### Characteristics

| Aspect           | Integration Tests                |
| ---------------- | -------------------------------- |
| **Scope**        | Multiple components together     |
| **Speed**        | Slower (seconds)                 |
| **Dependencies** | Real (database, cache, etc.)     |
| **Database**     | Real (test database)             |
| **Reliability**  | Good (depends on test isolation) |

### Pros ✅

-   **Realistic** - Tests real interactions
-   **Catches integration bugs** - Components working together
-   **Confidence** - If it passes, system works

### Cons ❌

-   **Slower** - Real I/O operations
-   **Setup complexity** - Need test databases
-   **Harder to debug** - Where did it fail?
-   **Flakier** - Network, timing issues

### When to Use

-   Service layer methods
-   Repository patterns
-   Database queries
-   Cache interactions
-   External API clients

---

## End-to-End Tests

### Definition

Test the **complete application** from the user's perspective.

```python
# E2E test - tests full HTTP request/response cycle
def test_user_registration_flow(client):
    # Step 1: Register
    response = client.post("/api/v1/users/register", json={
        "username": "newuser",
        "email": "new@example.com",
        "password": "SecurePass123!"
    })
    assert response.status_code == 201

    # Step 2: Login with new account
    response = client.post("/api/v1/auth/login", json={
        "email": "new@example.com",
        "password": "SecurePass123!"
    })
    assert response.status_code == 200
    assert "access_token" in response.json["data"]

    # Step 3: Access protected resource
    token = response.json["data"]["access_token"]
    response = client.get(
        "/api/v1/auth/me",
        headers={"Authorization": f"Bearer {token}"}
    )
    assert response.status_code == 200
    assert response.json["data"]["email"] == "new@example.com"
```

### Characteristics

| Aspect           | E2E Tests                    |
| ---------------- | ---------------------------- |
| **Scope**        | Entire application           |
| **Speed**        | Slowest (seconds to minutes) |
| **Dependencies** | All real                     |
| **Database**     | Real                         |
| **Reliability**  | Lower (more moving parts)    |

### Pros ✅

-   **Most realistic** - Tests like a real user
-   **High confidence** - System actually works
-   **Catches edge cases** - Integration of everything

### Cons ❌

-   **Slowest** - Full request cycle
-   **Expensive** - Setup, teardown
-   **Flaky** - Many failure points
-   **Hard to debug** - Where did it break?
-   **Maintenance burden** - UI changes break tests

### When to Use

-   Critical user flows (registration, checkout)
-   API contracts
-   Smoke tests
-   Acceptance tests

---

## Comparison Table

| Aspect           | Unit         | Integration         | E2E             |
| ---------------- | ------------ | ------------------- | --------------- |
| **Speed**        | Milliseconds | Seconds             | Seconds-Minutes |
| **Scope**        | One function | Multiple components | Entire app      |
| **Dependencies** | Mocked       | Real                | All real        |
| **Quantity**     | Many         | Medium              | Few             |
| **Reliability**  | High         | Medium              | Lower           |
| **Debug ease**   | Easy         | Medium              | Hard            |
| **Maintenance**  | Low          | Medium              | High            |
| **Cost**         | Low          | Medium              | High            |

---

## When to Use What

### Decision Tree

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    What Type of Test?                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  What are you testing?                                                   │
│      │                                                                   │
│      ├── Pure function/method?                                          │
│      │   └── Unit Test ✅                                               │
│      │                                                                   │
│      ├── Database interaction?                                          │
│      │   └── Integration Test ✅                                        │
│      │                                                                   │
│      ├── API endpoint?                                                  │
│      │   ├── Request/response format → Integration Test                │
│      │   └── Full user flow → E2E Test                                  │
│      │                                                                   │
│      ├── External service?                                              │
│      │   ├── Your code → Unit Test (mock the service)                  │
│      │   └── Connection → Integration Test (test env)                  │
│      │                                                                   │
│      └── User workflow (login → action → logout)?                       │
│          └── E2E Test ✅                                                │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### By Feature Type

| Feature             | Unit       | Integration | E2E         |
| ------------------- | ---------- | ----------- | ----------- |
| Password hashing    | ✅ Primary | Optional    | ❌          |
| User creation       | ✅         | ✅ Primary  | Optional    |
| API response format | ❌         | ✅ Primary  | ✅          |
| Login flow          | ❌         | ✅          | ✅ Primary  |
| Payment flow        | ✅         | ✅          | ✅ Critical |

---

## Our Testing Strategy

### Test Distribution

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Our Test Distribution                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  test_models/   ← Unit tests (~40%)                                     │
│  • Model methods                                                        │
│  • Password handling                                                    │
│  • Serialization                                                        │
│                                                                          │
│  test_services/ ← Integration tests (~40%)                              │
│  • Business logic                                                       │
│  • Database operations                                                  │
│  • Exception handling                                                   │
│                                                                          │
│  test_routes/   ← API tests (~20%)                                      │
│  • Request/response                                                     │
│  • Authentication                                                       │
│  • Error responses                                                      │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### What We Test Where

| Location         | Focus          | Examples              |
| ---------------- | -------------- | --------------------- |
| `test_models/`   | Model behavior | Password, soft delete |
| `test_services/` | Business logic | CRUD, validation      |
| `test_routes/`   | HTTP interface | Status codes, auth    |

### Example: Testing User Registration

```python
# 1. Unit test - Model level
def test_password_is_hashed(db):
    user = User(username="test", email="test@example.com")
    user.set_password("plain")
    assert user.password_hash != "plain"

# 2. Integration test - Service level
def test_create_user_service(db):
    data = UserCreateSchema(username="test", email="test@example.com", password="pass")
    user = UserService.create_user(data)
    assert user.id is not None

# 3. API test - Route level
def test_register_endpoint(client):
    response = client.post("/api/v1/users/register", json={...})
    assert response.status_code == 201
```

---

## Summary

### Key Takeaways

1. **Follow the pyramid** - Many unit tests, fewer E2E
2. **Test at the right level** - Don't over-test or under-test
3. **Unit for logic** - Pure functions, calculations
4. **Integration for state** - Database, cache
5. **E2E for flows** - Critical user journeys

### Quick Reference

| Test Type       | When to Use                   | Location         |
| --------------- | ----------------------------- | ---------------- |
| **Unit**        | Pure functions, model methods | `test_models/`   |
| **Integration** | Services, database operations | `test_services/` |
| **E2E**         | API endpoints, user flows     | `test_routes/`   |

### Testing Philosophy

> "Write tests. Not too many. Mostly integration."
> — Kent C. Dodds

---

## Related Documentation

-   **[8.1 Testing Overview](./8.1_testing_overview.md)** - Testing fundamentals
-   **[8.5 Model Tests](./8.5_model_tests.md)** - Unit testing models
-   **[8.6 Service Tests](./8.6_service_tests.md)** - Integration testing
-   **[8.7 Route Tests](./8.7_route_tests.md)** - API testing

---

> **External Resources:**
>
> -   [The Practical Test Pyramid](https://martinfowler.com/articles/practical-test-pyramid.html)
> -   [Write tests. Not too many. Mostly integration.](https://kentcdodds.com/blog/write-tests)
