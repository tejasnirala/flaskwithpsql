# 8.7 Route Tests

> **Testing API Endpoints (End-to-End Tests)**

This document explains how we test our API endpoints using Flask's test client.

---

## Table of Contents

1. [What Are Route Tests?](#what-are-route-tests)
2. [Flask Test Client](#flask-test-client)
3. [Our Route Tests](#our-route-tests)
4. [Testing HTTP Methods](#testing-http-methods)
5. [Testing Authentication](#testing-authentication)
6. [Testing Error Responses](#testing-error-responses)
7. [Best Practices](#best-practices)

---

## What Are Route Tests?

### Definition

Route tests (API tests) verify the **complete request/response cycle**:

-   HTTP request handling
-   Authentication/Authorization
-   Request validation
-   Business logic execution
-   Response format

### Position in Testing Pyramid

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Route Tests in the Pyramid                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│                            /\                                            │
│                           /  \                                           │
│                          / E2E\  ← We are here                          │
│                         / Route\   (API Tests)                          │
│                        /  Tests \                                        │
│                       /──────────\                                       │
│                      /            \                                      │
│                     /  Service     \                                     │
│                    /    Tests       \                                    │
│                   /──────────────────\                                   │
│                  /    Model Tests     \                                  │
│                 /______________________\                                 │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Flask Test Client

### What is the Test Client?

Flask provides a built-in test client that simulates HTTP requests **without running a real server**.

```python
# The client fixture from conftest.py
@pytest.fixture
def client(app, db):
    with app.test_client() as client:
        yield client
```

### Basic Usage

```python
def test_health_endpoint(client):
    response = client.get("/health")

    assert response.status_code == 200
    assert response.json["status"] == "healthy"
```

### Key Attributes

| Attribute              | Description                       |
| ---------------------- | --------------------------------- |
| `response.status_code` | HTTP status code (200, 404, etc.) |
| `response.json`        | Parsed JSON response body         |
| `response.data`        | Raw response body (bytes)         |
| `response.headers`     | Response headers                  |

---

## Our Route Tests

### File: `tests/test_routes/test_users.py`

```python
"""Tests for User API Routes."""

class TestUserRoutes:
    """Test suite for user API endpoints."""

    def test_register_user(self, client): ...
    def test_register_duplicate_email(self, client, sample_user): ...
    def test_get_user(self, client, sample_user): ...
    def test_get_user_not_found(self, client): ...
    def test_list_users(self, client, sample_users): ...
    def test_update_user(self, client, sample_user): ...
    def test_delete_user(self, client, sample_user): ...
```

---

## Testing HTTP Methods

### GET Requests

```python
def test_get_user(self, client, sample_user):
    """Test getting a single user."""
    response = client.get(f"/api/v1/users/{sample_user.id}")

    assert response.status_code == 200
    assert response.json["success"] is True
    assert response.json["data"]["username"] == "testuser"

def test_get_user_not_found(self, client):
    """Test getting non-existent user."""
    response = client.get("/api/v1/users/99999")

    assert response.status_code == 404
    assert response.json["success"] is False
```

### POST Requests

```python
def test_register_user(self, client):
    """Test user registration."""
    response = client.post(
        "/api/v1/users/register",
        json={
            "username": "newuser",
            "email": "new@example.com",
            "password": "SecurePass123!",
            "first_name": "New",
            "last_name": "User"
        }
    )

    assert response.status_code == 201
    assert response.json["success"] is True
    assert response.json["data"]["username"] == "newuser"
    # Password should NOT be in response
    assert "password" not in response.json["data"]
```

### PUT/PATCH Requests

```python
def test_update_user(self, client, sample_user, auth_headers):
    """Test updating a user."""
    response = client.patch(
        f"/api/v1/users/{sample_user.id}",
        json={
            "first_name": "Updated",
            "bio": "New bio"
        },
        headers=auth_headers
    )

    assert response.status_code == 200
    assert response.json["data"]["first_name"] == "Updated"
    assert response.json["data"]["bio"] == "New bio"
```

### DELETE Requests

```python
def test_delete_user(self, client, sample_user, auth_headers):
    """Test deleting a user (soft delete)."""
    response = client.delete(
        f"/api/v1/users/{sample_user.id}",
        headers=auth_headers
    )

    assert response.status_code == 200
    assert response.json["success"] is True
    assert response.json["message"] == "User deleted successfully"
```

---

## Testing Authentication

### Login Endpoint

```python
def test_login_success(self, client, sample_user):
    """Test successful login."""
    response = client.post(
        "/api/v1/auth/login",
        json={
            "email": "test@example.com",
            "password": "TestPassword123!"
        }
    )

    assert response.status_code == 200
    assert "access_token" in response.json["data"]
    assert "refresh_token" in response.json["data"]

def test_login_wrong_password(self, client, sample_user):
    """Test login with wrong password."""
    response = client.post(
        "/api/v1/auth/login",
        json={
            "email": "test@example.com",
            "password": "WrongPassword!"
        }
    )

    assert response.status_code == 401
    assert response.json["success"] is False
```

### Protected Endpoints

```python
def test_protected_endpoint_without_token(self, client):
    """Test accessing protected endpoint without token."""
    response = client.get("/api/v1/auth/me")

    assert response.status_code == 401

def test_protected_endpoint_with_token(self, client, sample_user):
    """Test accessing protected endpoint with valid token."""
    # First login to get token
    login_response = client.post(
        "/api/v1/auth/login",
        json={
            "email": "test@example.com",
            "password": "TestPassword123!"
        }
    )
    token = login_response.json["data"]["access_token"]

    # Then access protected endpoint
    response = client.get(
        "/api/v1/auth/me",
        headers={"Authorization": f"Bearer {token}"}
    )

    assert response.status_code == 200
    assert response.json["data"]["email"] == "test@example.com"
```

### Auth Headers Fixture

```python
@pytest.fixture
def auth_headers(client, sample_user):
    """Get authentication headers for protected routes."""
    response = client.post(
        "/api/v1/auth/login",
        json={
            "email": sample_user.email,
            "password": "TestPassword123!"
        }
    )
    token = response.json["data"]["access_token"]
    return {"Authorization": f"Bearer {token}"}


def test_update_user(self, client, sample_user, auth_headers):
    """Test with pre-configured auth headers."""
    response = client.patch(
        f"/api/v1/users/{sample_user.id}",
        json={"first_name": "Updated"},
        headers=auth_headers
    )
    assert response.status_code == 200
```

---

## Testing Error Responses

### Validation Errors

```python
def test_register_missing_fields(self, client):
    """Test registration with missing required fields."""
    response = client.post(
        "/api/v1/users/register",
        json={
            "username": "test"
            # Missing email and password
        }
    )

    assert response.status_code == 422  # Validation error
    assert response.json["success"] is False
    assert "email" in str(response.json["error"])

def test_register_invalid_email(self, client):
    """Test registration with invalid email format."""
    response = client.post(
        "/api/v1/users/register",
        json={
            "username": "test",
            "email": "not-an-email",
            "password": "SecurePass123!"
        }
    )

    assert response.status_code == 422
```

### Conflict Errors

```python
def test_register_duplicate_email(self, client, sample_user):
    """Test registration with existing email."""
    response = client.post(
        "/api/v1/users/register",
        json={
            "username": "different",
            "email": sample_user.email,  # Already exists
            "password": "SecurePass123!"
        }
    )

    assert response.status_code == 409  # Conflict
    assert response.json["error"]["code"] == "USER_ALREADY_EXISTS"
```

### Not Found Errors

```python
def test_get_user_not_found(self, client):
    """Test getting non-existent user."""
    response = client.get("/api/v1/users/99999")

    assert response.status_code == 404
    assert response.json["error"]["code"] == "USER_NOT_FOUND"
```

### Testing Response Format

```python
def test_response_format(self, client, sample_user):
    """Verify standardized response format."""
    response = client.get(f"/api/v1/users/{sample_user.id}")

    # Check response structure
    assert "success" in response.json
    assert "data" in response.json
    assert "error" in response.json
    assert "meta" in response.json

    # Success case should have data, no error
    assert response.json["success"] is True
    assert response.json["data"] is not None
    assert response.json["error"] is None
```

---

## Best Practices

### 1. Test Complete Responses

```python
def test_user_response_structure(self, client, sample_user):
    """Verify all expected fields are present."""
    response = client.get(f"/api/v1/users/{sample_user.id}")

    data = response.json["data"]

    # Expected fields present
    assert "id" in data
    assert "username" in data
    assert "email" in data
    assert "first_name" in data
    assert "created_at" in data

    # Sensitive fields absent
    assert "password_hash" not in data
    assert "password" not in data
```

### 2. Use Query Parameters

```python
def test_list_users_pagination(self, client, sample_users):
    """Test pagination parameters."""
    response = client.get("/api/v1/users?page=1&per_page=2")

    assert len(response.json["data"]) == 2
    assert response.json["meta"]["total"] == 5
    assert response.json["meta"]["page"] == 1
    assert response.json["meta"]["per_page"] == 2

def test_list_users_search(self, client, sample_users):
    """Test search parameter."""
    response = client.get("/api/v1/users?search=testuser1")

    assert len(response.json["data"]) == 1
    assert response.json["data"][0]["username"] == "testuser1"
```

### 3. Test Both Content Types

```python
def test_json_request(self, client):
    """Test with JSON content type."""
    response = client.post(
        "/api/v1/users/register",
        json={"username": "test", ...},  # json= sets Content-Type automatically
    )
    assert response.status_code == 201

def test_invalid_content_type(self, client):
    """Test with invalid content type."""
    response = client.post(
        "/api/v1/users/register",
        data="not json",
        content_type="text/plain"
    )
    assert response.status_code == 415  # Unsupported Media Type
```

### 4. Test Edge Cases

```python
def test_empty_update(self, client, sample_user, auth_headers):
    """Update with empty body should work."""
    response = client.patch(
        f"/api/v1/users/{sample_user.id}",
        json={},
        headers=auth_headers
    )
    assert response.status_code == 200

def test_large_page_number(self, client, sample_users):
    """Test pagination with page beyond data."""
    response = client.get("/api/v1/users?page=999999")

    assert response.status_code == 200
    assert response.json["data"] == []
```

### 5. Follow AAA Pattern

```python
def test_update_user_complete(self, client, sample_user, auth_headers):
    """Complete AAA pattern example."""
    # ARRANGE
    user_id = sample_user.id
    original_name = sample_user.first_name
    new_name = "Updated"

    # ACT
    response = client.patch(
        f"/api/v1/users/{user_id}",
        json={"first_name": new_name},
        headers=auth_headers
    )

    # ASSERT
    assert response.status_code == 200
    assert response.json["data"]["first_name"] == new_name
    assert response.json["data"]["first_name"] != original_name
```

---

## Summary

### Route Test Checklist

| Category            | What to Test                          |
| ------------------- | ------------------------------------- |
| **Success cases**   | Valid requests return expected data   |
| **Error cases**     | Invalid requests return proper errors |
| **Auth**            | Protected routes require valid token  |
| **Validation**      | Invalid input returns 422             |
| **Response format** | Standardized structure                |
| **HTTP methods**    | GET, POST, PATCH, DELETE all work     |
| **Query params**    | Pagination, filtering, search         |

### Quick Reference

```python
# GET request
response = client.get("/api/v1/resource")

# POST with JSON
response = client.post("/api/v1/resource", json={"key": "value"})

# With auth header
response = client.get("/api/v1/protected", headers=auth_headers)

# With query params
response = client.get("/api/v1/resource?page=1&per_page=10")

# Check response
assert response.status_code == 200
assert response.json["success"] is True
```

---

## Next Steps

-   **[8.8 Test Coverage](./8.8_test_coverage.md)** - Measuring test coverage
-   **[8.9 Testing Strategies](./8.9_testing_strategies.md)** - Unit vs Integration vs E2E

---

> **Related Documentation:**
>
> -   [tests/test_routes/test_users.py](../../tests/test_routes/test_users.py)
> -   [Flask Test Client docs](https://flask.palletsprojects.com/en/latest/testing/)
