# 8.4 Conftest File Explained

> **Our Shared pytest Fixtures Configuration**

This document provides a line-by-line explanation of our `tests/conftest.py` file, which contains shared fixtures used across all test files.

---

## Table of Contents

1. [What is conftest.py?](#what-is-conftestpy)
2. [Our Fixtures](#our-fixtures)
3. [Line-by-Line Explanation](#line-by-line-explanation)
4. [Usage Examples](#usage-examples)
5. [Adding New Fixtures](#adding-new-fixtures)

---

## What is conftest.py?

### Purpose

`conftest.py` is a special pytest file that:

-   Provides fixtures available to **all test files** in the same directory and subdirectories
-   Is automatically discovered by pytest (no imports needed)
-   Can exist at multiple levels for scoped fixtures

### Location

```
tests/
├── conftest.py          ← Root conftest (fixtures for all tests)
├── test_models/
│   ├── conftest.py      ← Model-specific fixtures (optional)
│   └── test_user.py
├── test_services/
│   └── test_user_service.py
└── test_routes/
    └── test_users.py
```

### How Fixtures Are Found

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Fixture Discovery                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  When running: pytest tests/test_routes/test_users.py                   │
│                                                                          │
│  pytest searches for fixtures in:                                        │
│                                                                          │
│  1. tests/test_routes/test_users.py          (same file)                │
│  2. tests/test_routes/conftest.py            (same directory)           │
│  3. tests/conftest.py                        (parent directory)         │
│  4. Built-in pytest fixtures                 (tmp_path, capsys, etc.)   │
│                                                                          │
│  First match wins!                                                       │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Our Fixtures

### Fixture Overview

| Fixture        | Scope      | Purpose                 |
| -------------- | ---------- | ----------------------- |
| `app`          | `session`  | Create Flask app once   |
| `db`           | `function` | Fresh database per test |
| `client`       | `function` | HTTP test client        |
| `sample_user`  | `function` | Single test user        |
| `sample_users` | `function` | Multiple test users     |
| `auth_headers` | `function` | Authentication headers  |

### Fixture Dependencies

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Fixture Dependency Graph                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│                        app (session scope)                               │
│                             │                                            │
│                             ▼                                            │
│                        db (function scope)                               │
│                           / │ \                                          │
│                          /  │  \                                         │
│                         ▼   ▼   ▼                                        │
│                    client sample_user sample_users                       │
│                      │                                                   │
│                      ▼                                                   │
│              (used in tests)                                             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Line-by-Line Explanation

### File Header

```python
"""
Pytest Configuration and Fixtures.

This file is automatically loaded by pytest and provides fixtures
that can be used across all test files.

Fixtures Provided:
-----------------
- app: Flask application configured for testing
- client: Flask test client for making HTTP requests
- db: Database session for direct database access
- sample_user: A pre-created user for testing

Usage:
    def test_something(client, sample_user):
        response = client.get(f'/api/users/{sample_user.id}')
        assert response.status_code == 200
"""
```

**Purpose:** Document the fixtures and how to use them. This docstring appears in `pytest --fixtures`.

---

### Imports

```python
from typing import Generator

import pytest

from app import create_app
from app import db as _db
from app.models.user import User
```

**Explanation:**

| Import       | Purpose                                         |
| ------------ | ----------------------------------------------- |
| `Generator`  | Type hint for fixtures using `yield`            |
| `pytest`     | pytest framework                                |
| `create_app` | Our Flask app factory                           |
| `_db`        | SQLAlchemy instance (renamed to avoid conflict) |
| `User`       | User model for creating test users              |

**Why `_db`?**

We import `db` from app but rename it to `_db` to avoid conflict with our `db` fixture name.

---

### App Fixture

```python
@pytest.fixture(scope="session")
def app():
    """
    Create and configure a Flask application for testing.

    Scope is 'session' so the app is created once per test session.
    """
    app = create_app("testing")

    # Establish application context
    with app.app_context():
        yield app
```

**Explanation:**

| Part                     | Purpose                                       |
| ------------------------ | --------------------------------------------- |
| `scope="session"`        | Create app once for entire test run           |
| `create_app("testing")`  | Use testing configuration (in-memory DB, etc) |
| `with app.app_context()` | Ensure Flask context is available             |
| `yield app`              | Provide app to tests, cleanup after           |

**Why session scope?**

Creating a Flask app is relatively expensive. We create it once and reuse it for all tests.

---

### Database Fixture

```python
@pytest.fixture(scope="function")
def db(app) -> Generator:
    """
    Create database tables for each test function.

    This ensures each test starts with a clean database.
    Tables are created before the test and dropped after.
    """
    with app.app_context():
        # Create all tables
        _db.create_all()

        yield _db

        # Cleanup: remove session and drop all tables
        _db.session.remove()
        _db.drop_all()
```

**Explanation:**

| Part                   | Purpose                               |
| ---------------------- | ------------------------------------- |
| `scope="function"`     | Fresh database for EACH test function |
| `db(app)`              | Depends on `app` fixture              |
| `_db.create_all()`     | Create all tables (SETUP)             |
| `yield _db`            | Provide database to test              |
| `_db.session.remove()` | Clear session                         |
| `_db.drop_all()`       | Drop all tables (TEARDOWN)            |

**Why function scope?**

Each test gets a fresh database. This prevents test pollution where one test's data affects another.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Database Per Test                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  test_1:                                                                │
│    db.create_all()  → Empty tables                                      │
│    test runs        → Creates User(id=1)                                │
│    db.drop_all()    → Tables gone                                       │
│                                                                          │
│  test_2:                                                                │
│    db.create_all()  → Empty tables (fresh!)                             │
│    test runs        → Creates User(id=1) (not id=2!)                    │
│    db.drop_all()    → Tables gone                                       │
│                                                                          │
│  Tests are isolated from each other!                                    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### Client Fixture

```python
@pytest.fixture(scope="function")
def client(app, db):
    """
    Flask test client for making HTTP requests.

    Each test gets a fresh client with a clean database.
    """
    with app.test_client() as client:
        with app.app_context():
            yield client
```

**Explanation:**

| Part                | Purpose                             |
| ------------------- | ----------------------------------- |
| `client(app, db)`   | Depends on both app and db fixtures |
| `app.test_client()` | Create Flask's test client          |
| `app.app_context()` | Ensure Flask context available      |
| `yield client`      | Provide client to test              |

**Why depend on `db`?**

The `db` fixture is listed to ensure database is set up before routes are tested.

**Usage:**

```python
def test_register_user(client):
    response = client.post("/api/v1/users/register", json={
        "username": "test",
        "email": "test@example.com",
        "password": "SecurePass123!"
    })

    assert response.status_code == 201
```

---

### Sample User Fixture

```python
@pytest.fixture(scope="function")
def sample_user(db) -> User:
    """
    Create a sample user for testing.

    Returns a User object that has been committed to the database.
    """
    user = User(
        username="testuser",
        email="test@example.com",
        first_name="Test",
        last_name="User",
        bio="A test user for testing purposes",
    )
    user.set_password("TestPassword123!")

    db.session.add(user)
    db.session.commit()

    return user
```

**Explanation:**

| Part                    | Purpose                          |
| ----------------------- | -------------------------------- |
| `sample_user(db)`       | Depends on `db` fixture          |
| `-> User`               | Return type annotation           |
| `User(...)`             | Create user with known test data |
| `set_password(...)`     | Hash the test password           |
| `db.session.add/commit` | Save to database                 |
| `return user`           | Return the created user          |

**Usage:**

```python
def test_get_user(client, sample_user):
    response = client.get(f"/api/v1/users/{sample_user.id}")

    assert response.status_code == 200
    assert response.json["data"]["username"] == "testuser"
```

---

### Sample Users Fixture (Plural)

```python
@pytest.fixture(scope="function")
def sample_users(db) -> list:
    """
    Create multiple sample users for testing list operations.

    Returns a list of User objects.
    """
    users = []
    for i in range(5):
        user = User(
            username=f"testuser{i}",
            email=f"test{i}@example.com",
            first_name=f"Test{i}",
            last_name="User",
        )
        user.set_password("TestPassword123!")
        db.session.add(user)
        users.append(user)

    db.session.commit()
    return users
```

**Explanation:**

Creates 5 users for testing pagination and list operations.

**Usage:**

```python
def test_list_users(client, sample_users):
    response = client.get("/api/v1/users")

    assert response.status_code == 200
    assert len(response.json["data"]) == 5
```

---

### Auth Headers Fixture

```python
@pytest.fixture
def auth_headers():
    """
    Return authorization headers for authenticated requests.

    Note: Implement actual token generation when authentication is added.
    """
    return {"Authorization": "Bearer test-token"}
```

**Explanation:**

Placeholder for authentication headers.

**TODO:** Update this to generate real JWT tokens:

```python
@pytest.fixture
def auth_headers(client, sample_user):
    """Get real authentication headers."""
    response = client.post("/api/v1/auth/login", json={
        "email": sample_user.email,
        "password": "TestPassword123!"
    })
    token = response.json["data"]["access_token"]
    return {"Authorization": f"Bearer {token}"}
```

---

## Usage Examples

### Using Fixtures in Tests

```python
# tests/test_routes/test_users.py

def test_register_user(client):
    """Uses client fixture."""
    response = client.post("/api/v1/users/register", json={...})
    assert response.status_code == 201

def test_get_user(client, sample_user):
    """Uses client AND sample_user fixtures."""
    response = client.get(f"/api/v1/users/{sample_user.id}")
    assert response.status_code == 200
    assert response.json["data"]["username"] == sample_user.username

def test_list_users_pagination(client, sample_users):
    """Uses client AND sample_users fixtures."""
    response = client.get("/api/v1/users?page=1&per_page=2")
    assert len(response.json["data"]) == 2
    assert response.json["meta"]["total"] == 5

def test_delete_user(db, sample_user):
    """Uses db directly for service tests."""
    from app.services.user_service import UserService

    result = UserService.soft_delete(sample_user.id)
    assert result.is_deleted is True
```

---

## Adding New Fixtures

### Guidelines

1. **Add to conftest.py** for shared fixtures
2. **Add to test file** for test-specific fixtures
3. **Use appropriate scope**
4. **Clean up after yield**

### Example: Add Admin User Fixture

```python
# tests/conftest.py

@pytest.fixture(scope="function")
def admin_user(db) -> User:
    """Create an admin user for testing."""
    user = User(
        username="admin",
        email="admin@example.com",
        first_name="Admin",
        last_name="User",
    )
    user.set_password("AdminPass123!")
    # Assign admin role
    # user.roles.append(admin_role)

    db.session.add(user)
    db.session.commit()

    return user
```

### Example: Add Authenticated Client Fixture

```python
@pytest.fixture
def authenticated_client(client, sample_user):
    """Flask test client with valid authentication."""
    # Login
    response = client.post("/api/v1/auth/login", json={
        "email": sample_user.email,
        "password": "TestPassword123!"
    })

    token = response.json["data"]["access_token"]

    # Create a new client with auth header
    client.environ_base["HTTP_AUTHORIZATION"] = f"Bearer {token}"

    return client
```

---

## Summary

### Our Fixtures

| Fixture        | Returns            | Creates/Provides            |
| -------------- | ------------------ | --------------------------- |
| `app`          | Flask app          | App instance (session-wide) |
| `db`           | SQLAlchemy session | Fresh database per test     |
| `client`       | Test client        | HTTP client for requests    |
| `sample_user`  | User               | Pre-created user            |
| `sample_users` | List[User]         | 5 pre-created users         |

### Usage Pattern

```python
def test_something(client, sample_user):  # ← Request fixtures
    # client and sample_user are ready to use
    response = client.get(f"/api/v1/users/{sample_user.id}")
    assert response.status_code == 200
```

---

## Next Steps

-   **[8.5 Model Tests](./8.5_model_tests.md)** - Testing models
-   **[8.6 Service Tests](./8.6_service_tests.md)** - Testing services
-   **[8.7 Route Tests](./8.7_route_tests.md)** - Testing API endpoints

---

> **Related Documentation:**
>
> -   [tests/conftest.py](../../tests/conftest.py) - The actual file
> -   [pytest fixtures documentation](https://docs.pytest.org/en/latest/fixture.html)
