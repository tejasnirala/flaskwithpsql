# 5.9 RBAC Implementation - Code Flow Guide

> **How RBAC Works in Code: From Request to Response**

This document shows the **implementation details** of our RBAC system. We trace actual code paths from HTTP request to final response.

---

## Table of Contents

1. [File Structure Overview](#1-file-structure-overview)
2. [Request Entry Point](#2-request-entry-point)
3. [Decorator Flow](#3-decorator-flow)
4. [Service Layer Flow](#4-service-layer-flow)
5. [Model Layer Flow](#5-model-layer-flow)
    - 5.1 [Two Patterns for Defining Tables](#51-two-patterns-for-defining-tables)
6. [Success Flow](#6-success-flow)
7. [Error Handling Flow](#7-error-handling-flow)
8. [Complete Flow Diagrams](#8-complete-flow-diagrams)

---

## 1. File Structure Overview

```
app/
├── __init__.py                    # App factory - registers blueprints
│
├── models/
│   ├── __init__.py               # Exports: Permission, Role, User
│   ├── permission.py             # Permission model
│   ├── role.py                   # Role model with inheritance
│   ├── associations.py           # Junction tables
│   └── user.py                   # User with RBAC relationships
│
├── rbac/
│   ├── __init__.py               # Exports decorators, services
│   ├── decorators.py             # @permission_required, @role_required
│   ├── permissions.py            # PermissionRegistry (constants)
│   ├── services.py               # RBACService (business logic)
│   └── exceptions.py             # RBACError, PermissionDeniedError
│
├── schemas/
│   └── rbac.py                   # Pydantic schemas for API
│
├── routes/v1/admin/
│   ├── __init__.py               # admin_bp blueprint
│   ├── roles.py                  # Role management endpoints
│   └── permissions.py            # Permission endpoints
│
└── utils/
    ├── responses.py              # success_response, error_response
    └── error_handlers.py         # Global exception handlers
```

---

## 2. Request Entry Point

### Step 1: HTTP Request Arrives

```
DELETE /api/v1/users/123
Headers:
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
  Content-Type: application/json
```

### Step 2: Flask Routes the Request

```
┌─────────────────────────────────────────────────────────────────────────────┐
│   run.py                                                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   from app import create_app                                                 │
│   app = create_app()                                                         │
│                                                                              │
│   if __name__ == "__main__":                                                 │
│       app.run()  ←── Flask starts listening                                 │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│   app/__init__.py - create_app()                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   def create_app(config_name="default"):                                     │
│       app = OpenAPI(__name__, ...)                                           │
│                                                                              │
│       # Initialize extensions                                                │
│       db.init_app(app)                                                       │
│       init_jwt(app)  ←── JWT middleware installed                           │
│                                                                              │
│       # Register blueprints                                                  │
│       from app.routes.v1 import api_v1                                       │
│       app.register_api(api_v1)  ←── Routes registered                       │
│                                                                              │
│       # Register error handlers                                              │
│       from app.utils.error_handlers import register_error_handlers          │
│       register_error_handlers(app)  ←── Exception handlers installed        │
│                                                                              │
│       return app                                                             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│   app/routes/v1/__init__.py                                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   api_v1 = APIBlueprint("api_v1", __name__, url_prefix="/api/v1")           │
│                                                                              │
│   api_v1.register_api(users_bp_v1)   # /api/v1/users/*                      │
│   api_v1.register_api(admin_bp)      # /api/v1/admin/*  ←── RBAC routes     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│   app/routes/v1/users.py - THE TARGET ROUTE                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   @users_bp_v1.delete("/<int:user_id>")                                     │
│   @permission_required("users:delete")  ←── DECORATOR INTERCEPTS HERE       │
│   def delete_user(path: UserPath):                                          │
│       # This code only runs if decorator allows                             │
│       user = User.query.get_or_404(path.user_id)                            │
│       user.soft_delete()                                                     │
│       db.session.commit()                                                    │
│       return success_response(message="User deleted")                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Decorator Flow

### The @permission_required Decorator

```
┌─────────────────────────────────────────────────────────────────────────────┐
│   app/rbac/decorators.py                                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   def permission_required(*permissions, require_all=False, message=None):   │
│       """                                                                    │
│       Decorator to require specific permissions.                             │
│                                                                              │
│       Args:                                                                  │
│           *permissions: Permission strings like "users:delete"              │
│           require_all: If True, ALL permissions required                    │
│           message: Custom error message                                      │
│       """                                                                    │
│       def decorator(fn):                                                     │
│           @wraps(fn)                                                         │
│           def wrapper(*args, **kwargs):                                      │
│               # ┌─────────────────────────────────────────────────────────┐ │
│               # │ STEP 1: Verify JWT Token                                │ │
│               # └─────────────────────────────────────────────────────────┘ │
│               try:                                                           │
│                   verify_jwt_in_request()                                   │
│               except Exception:                                              │
│                   return error_response(                                     │
│                       code=ErrorCode.UNAUTHORIZED,                           │
│                       message="Authentication required",                     │
│                       status_code=401                                        │
│                   )                                                          │
│                                                                              │
│               # ┌─────────────────────────────────────────────────────────┐ │
│               # │ STEP 2: Get Current User from Token                     │ │
│               # └─────────────────────────────────────────────────────────┘ │
│               user = get_current_user()                                      │
│               if not user:                                                   │
│                   return error_response(                                     │
│                       code=ErrorCode.UNAUTHORIZED,                           │
│                       message="User not found",                              │
│                       status_code=401                                        │
│                   )                                                          │
│                                                                              │
│               # ┌─────────────────────────────────────────────────────────┐ │
│               # │ STEP 3: Check if User Account is Active                 │ │
│               # └─────────────────────────────────────────────────────────┘ │
│               if not user.is_active:                                         │
│                   return error_response(                                     │
│                       code=ErrorCode.FORBIDDEN,                              │
│                       message="Account deactivated",                         │
│                       status_code=403                                        │
│                   )                                                          │
│                                                                              │
│               # ┌─────────────────────────────────────────────────────────┐ │
│               # │ STEP 4: Check Permissions via RBACService               │ │
│               # └─────────────────────────────────────────────────────────┘ │
│               has_permission = False                                         │
│                                                                              │
│               if require_all:                                                │
│                   # Must have ALL permissions                                │
│                   has_permission = all(                                      │
│                       RBACService.user_has_permission(user, p)              │
│                       for p in permissions                                   │
│                   )                                                          │
│               else:                                                          │
│                   # Must have ANY permission                                 │
│                   has_permission = any(                                      │
│                       RBACService.user_has_permission(user, p)              │
│                       for p in permissions                                   │
│                   )                                                          │
│                                                                              │
│               # ┌─────────────────────────────────────────────────────────┐ │
│               # │ STEP 5: Return Error if No Permission                   │ │
│               # └─────────────────────────────────────────────────────────┘ │
│               if not has_permission:                                         │
│                   return error_response(                                     │
│                       code=ErrorCode.FORBIDDEN,                              │
│                       message=message or "Insufficient permissions",        │
│                       details={"required_permissions": list(permissions)},  │
│                       status_code=403                                        │
│                   )                                                          │
│                                                                              │
│               # ┌─────────────────────────────────────────────────────────┐ │
│               # │ STEP 6: Permission Granted - Execute Route              │ │
│               # └─────────────────────────────────────────────────────────┘ │
│               return fn(*args, **kwargs)                                     │
│                                                                              │
│           return wrapper                                                     │
│       return decorator                                                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Decorator Decision Flow

```
                        @permission_required("users:delete")
                                      │
                                      ▼
                    ┌─────────────────────────────────┐
                    │     verify_jwt_in_request()     │
                    └─────────────────┬───────────────┘
                                      │
                         ┌────────────┴────────────┐
                         │                         │
                      SUCCESS                    FAILURE
                         │                         │
                         ▼                         ▼
            ┌────────────────────┐      ┌────────────────────┐
            │  get_current_user()│      │  401 Unauthorized  │
            └─────────┬──────────┘      │  "Auth required"   │
                      │                 └────────────────────┘
         ┌────────────┴────────────┐
         │                         │
      USER FOUND              USER NOT FOUND
         │                         │
         ▼                         ▼
┌─────────────────┐      ┌────────────────────┐
│ Check is_active │      │  401 Unauthorized  │
└────────┬────────┘      │  "User not found"  │
         │               └────────────────────┘
    ┌────┴────┐
    │         │
  ACTIVE   INACTIVE
    │         │
    ▼         ▼
┌─────────┐  ┌────────────────────┐
│ Check   │  │  403 Forbidden     │
│ Perms   │  │  "Deactivated"     │
└────┬────┘  └────────────────────┘
     │
┌────┴────┐
│         │
HAS      LACKS
PERM     PERM
│         │
▼         ▼
┌─────────────┐  ┌────────────────────┐
│ Execute     │  │  403 Forbidden     │
│ Route fn()  │  │  "Insufficient     │
└─────────────┘  │   permissions"     │
                 └────────────────────┘
```

---

## 4. Service Layer Flow

### RBACService.user_has_permission()

```
┌─────────────────────────────────────────────────────────────────────────────┐
│   app/rbac/services.py - RBACService                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   class RBACService:                                                         │
│       @staticmethod                                                          │
│       def user_has_permission(user: User, permission: str) -> bool:         │
│           """                                                                │
│           Check if user has a specific permission.                           │
│                                                                              │
│           Checks in order:                                                   │
│           1. Direct permissions on user                                      │
│           2. Permissions from assigned roles                                 │
│           3. Permissions inherited from parent roles                        │
│           4. Wildcard matches (*:* and resource:*)                          │
│           """                                                                │
│           # ┌───────────────────────────────────────────────────────────┐   │
│           # │ Step 1: Get ALL effective permissions for user           │   │
│           # └───────────────────────────────────────────────────────────┘   │
│           all_permissions = user.get_all_permissions()                       │
│           # Returns: {"users:read", "users:update", "users:delete"}         │
│                                                                              │
│           # ┌───────────────────────────────────────────────────────────┐   │
│           # │ Step 2: Check exact match                                 │   │
│           # └───────────────────────────────────────────────────────────┘   │
│           if permission in all_permissions:                                  │
│               return True  # Direct match found!                            │
│                                                                              │
│           # ┌───────────────────────────────────────────────────────────┐   │
│           # │ Step 3: Check super wildcard (*:*)                        │   │
│           # └───────────────────────────────────────────────────────────┘   │
│           if "*:*" in all_permissions:                                       │
│               return True  # Super admin - has everything                   │
│                                                                              │
│           # ┌───────────────────────────────────────────────────────────┐   │
│           # │ Step 4: Check resource wildcard (users:*)                 │   │
│           # └───────────────────────────────────────────────────────────┘   │
│           resource = permission.split(":")[0]  # "users"                    │
│           if f"{resource}:*" in all_permissions:                            │
│               return True  # Has all permissions on this resource           │
│                                                                              │
│           # ┌───────────────────────────────────────────────────────────┐   │
│           # │ Step 5: No match - permission denied                      │   │
│           # └───────────────────────────────────────────────────────────┘   │
│           return False                                                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Model Layer Flow

### User.get_all_permissions()

```
┌─────────────────────────────────────────────────────────────────────────────┐
│   app/models/user.py - User Model                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   class User(BaseModel):                                                     │
│       # Relationships                                                        │
│       roles = relationship("Role", secondary="rbac.user_roles",             │
│                            back_populates="users")                          │
│       direct_permissions = relationship("Permission",                        │
│                                         secondary="rbac.user_permissions")  │
│                                                                              │
│       def get_all_permissions(self) -> set:                                 │
│           """                                                                │
│           Get ALL effective permissions (roles + direct).                    │
│           """                                                                │
│           permissions = set()                                                │
│                                                                              │
│           # ┌───────────────────────────────────────────────────────────┐   │
│           # │ 1. Collect permissions from all assigned roles           │   │
│           # └───────────────────────────────────────────────────────────┘   │
│           for role in self.roles:                                            │
│               # Get role's direct permissions                                │
│               for perm in role.permissions:                                  │
│                   permissions.add(perm.name)                                 │
│                                                                              │
│               # Get permissions from parent roles (inheritance)             │
│               parent = role.parent_role                                      │
│               while parent:                                                  │
│                   for perm in parent.permissions:                            │
│                       permissions.add(perm.name)                             │
│                   parent = parent.parent_role                                │
│                                                                              │
│           # ┌───────────────────────────────────────────────────────────┐   │
│           # │ 2. Add direct permissions (hybrid feature)               │   │
│           # └───────────────────────────────────────────────────────────┘   │
│           for perm in self.direct_permissions:                               │
│               permissions.add(perm.name)                                     │
│                                                                              │
│           return permissions                                                 │
│           # Returns: {"users:read", "users:update", "users:delete"}         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Permission Collection Visualization

```
                              User: alice
                                   │
             ┌─────────────────────┼─────────────────────┐
             │                     │                     │
             ▼                     ▼                     ▼
      ┌────────────┐       ┌────────────┐       ┌────────────┐
      │   Role:    │       │   Role:    │       │   Direct   │
      │ moderator  │       │  support   │       │   Perms    │
      └─────┬──────┘       └─────┬──────┘       └─────┬──────┘
            │                    │                    │
            ▼                    ▼                    ▼
      ┌────────────┐       ┌────────────┐       ┌────────────┐
      │users:update│       │tickets:read│       │users:delete│
      └─────┬──────┘       │tickets:upd │       └────────────┘
            │              └────────────┘
            ▼
      ┌────────────┐
      │ parent:    │
      │   user     │
      └─────┬──────┘
            │
            ▼
      ┌────────────┐
      │ users:read │
      └────────────┘

                    ─────────────────
                          UNION
                    ─────────────────
                           │
                           ▼
              ┌────────────────────────┐
              │  EFFECTIVE PERMISSIONS │
              │  ────────────────────  │
              │  • users:read          │
              │  • users:update        │
              │  • users:delete        │
              │  • tickets:read        │
              │  • tickets:update      │
              └────────────────────────┘
```

---

### 5.1 Two Patterns for Defining Tables

If you look at our models, you'll notice we use **two different patterns** for defining database tables. This is intentional and follows SQLAlchemy best practices.

#### Pattern 1: Class-Based Model (ORM)

Used for: `User`, `Role`, `Permission` (entity tables)

```python
# app/models/role.py

class Role(BaseModel):
    """Full ORM class with all features."""

    __tablename__ = "roles"
    __table_args__ = {"schema": "rbac"}

    # Columns
    name = Column(String(50), unique=True, nullable=False)
    display_name = Column(String(100), nullable=False)
    description = Column(Text, nullable=True)

    # Relationships
    permissions = relationship("Permission", secondary=role_permissions)
    users = relationship("User", secondary=user_roles)

    # Methods - business logic on the entity
    def to_dict(self):
        return {"name": self.name, "display_name": self.display_name}

    def has_permission(self, permission_name):
        return permission_name in self.get_all_permissions()
```

#### Pattern 2: Table Construct (Core)

Used for: `user_roles`, `role_permissions`, `user_permissions` (junction tables)

```python
# app/models/associations.py

user_roles = Table(
    "user_roles",
    db.Model.metadata,
    Column("user_id", Integer, ForeignKey("users.users.id"), primary_key=True),
    Column("role_id", Integer, ForeignKey("rbac.roles.id"), primary_key=True),
    Column("assigned_at", DateTime(timezone=True)),
    Column("assigned_by", Integer, ForeignKey("users.users.id")),
    schema="rbac",
)
# Note: No class, no methods - just a table definition
```

---

#### What Each Pattern Gives You

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    CLASS-BASED MODEL (ORM) FEATURES                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ✓ Object Creation:                                                         │
│     role = Role(name="admin", display_name="Administrator")                 │
│     db.session.add(role)                                                     │
│                                                                              │
│   ✓ Instance Methods:                                                        │
│     if role.has_permission("users:delete"):                                 │
│         print("Can delete!")                                                 │
│                                                                              │
│   ✓ Query Interface:                                                         │
│     Role.query.filter_by(name="admin").first()                              │
│                                                                              │
│   ✓ Relationships:                                                           │
│     role.permissions  # Access related objects                              │
│     role.users        # Navigate relationships                               │
│                                                                              │
│   ✓ Serialization:                                                           │
│     role.to_dict()  # Convert to JSON-serializable dict                     │
│                                                                              │
│   ✓ Inheritance:                                                             │
│     class Role(BaseModel):  # Inherit common fields                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                       TABLE CONSTRUCT FEATURES                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ✓ Defines table schema only                                                │
│   ✓ Lightweight - no Python class overhead                                   │
│   ✓ Used automatically by relationships                                      │
│                                                                              │
│   ✗ No object creation (can't do: UserRole(user_id=1, role_id=2))          │
│   ✗ No instance methods                                                      │
│   ✗ No direct queries (UserRole.query doesn't exist)                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

#### When to Use Each Pattern

| Use Case                        | Pattern             | Example                      |
| ------------------------------- | ------------------- | ---------------------------- |
| First-class domain entity       | **Class-Based**     | User, Role, Permission       |
| Need methods on the object      | **Class-Based**     | `role.has_permission()`      |
| Need direct queries             | **Class-Based**     | `Role.query.filter_by()`     |
| Need serialization              | **Class-Based**     | `role.to_dict()`             |
| Pure junction/linking table     | **Table Construct** | user_roles, role_permissions |
| No business logic needed        | **Table Construct** | Just foreign key links       |
| Accessed only via relationships | **Table Construct** | `user.roles` handles it      |

---

#### How Each Pattern is Used in Practice

**Class-Based Model Usage:**

```python
# Creating a role
admin_role = Role(
    name="admin",
    display_name="Administrator",
    description="Full access"
)
db.session.add(admin_role)
db.session.commit()

# Querying
admin = Role.query.filter_by(name="admin").first()

# Using methods
if admin.has_permission("users:delete"):
    print("Admin can delete users!")

# Serializing for API
return jsonify(admin.to_dict())
```

**Table Construct Usage:**

```python
# You DON'T do this:
# user_role = user_roles(user_id=1, role_id=2)  ← WRONG! Not a class!

# Instead, access via relationships:
user = User.query.get(1)
admin_role = Role.query.filter_by(name="admin").first()

# SQLAlchemy handles the junction table automatically!
user.roles.append(admin_role)  # Inserts into user_roles
db.session.commit()

# Or insert directly using the table:
from sqlalchemy import insert
stmt = insert(user_roles).values(
    user_id=1,
    role_id=2,
    assigned_at=datetime.now(timezone.utc)
)
db.session.execute(stmt)
db.session.commit()
```

---

#### Why We Made This Design Choice

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    DESIGN DECISION RATIONALE                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ENTITY TABLES (User, Role, Permission):                                    │
│   ─────────────────────────────────────────                                   │
│   • We query them directly: Role.query.filter_by(name="admin")              │
│   • We need methods: role.has_permission(), user.get_all_permissions()      │
│   • We need serialization: role.to_dict() for API responses                 │
│   • We need validation hooks and computed properties                         │
│   • We want inheritance from BaseModel for common fields                     │
│                                                                              │
│   → Use Class-Based Model ✓                                                  │
│                                                                              │
│   ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│   JUNCTION TABLES (user_roles, role_permissions, user_permissions):          │
│   ─────────────────────────────────────────────────────────────────          │
│   • We NEVER query them directly                                              │
│   • They have NO business logic                                               │
│   • They're just "glue" between two entities                                 │
│   • SQLAlchemy handles them via relationships                                 │
│   • Simpler code = less maintenance                                           │
│                                                                              │
│   → Use Table Construct ✓                                                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

#### Alternative: Association Object Pattern

You CAN use class-based models for junction tables. This is called the **Association Object Pattern**:

```python
# Alternative approach (NOT what we did)
class UserRole(db.Model):
    """Class-based junction table with behavior."""

    __tablename__ = "user_roles"
    __table_args__ = {"schema": "rbac"}

    user_id = Column(Integer, ForeignKey("users.users.id"), primary_key=True)
    role_id = Column(Integer, ForeignKey("rbac.roles.id"), primary_key=True)
    assigned_at = Column(DateTime(timezone=True))
    assigned_by = Column(Integer, ForeignKey("users.users.id"))

    # Now you CAN add methods!
    def is_expired(self):
        """Check if this role assignment has expired."""
        return (datetime.now(timezone.utc) - self.assigned_at).days > 365

    def was_assigned_by_admin(self):
        """Check if assigned by an admin."""
        assigner = User.query.get(self.assigned_by)
        return assigner and assigner.has_role("admin")
```

**When to use Association Object:**

-   Junction table has its own business logic
-   Need to query the junction directly
-   Need methods on the junction itself

**Why we didn't use it:**

-   Our junction tables are simple "glue" with just audit columns
-   We don't need methods on the junction
-   The Table() construct is cleaner for our use case

---

#### Pattern Comparison Summary

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         PATTERN COMPARISON                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                     ┌─────────────────────────────────────────┐              │
│                     │           ENTITY TABLES                 │              │
│                     │    (First-class domain objects)         │              │
│                     ├─────────────────────────────────────────┤              │
│                     │  User, Role, Permission                 │              │
│                     │  ─────────────────────                  │              │
│                     │  ✓ Class-based (inherits BaseModel)     │              │
│                     │  ✓ Has methods, relationships           │              │
│                     │  ✓ Queryable: Role.query.filter_by()    │              │
│                     │  ✓ Serializable: role.to_dict()         │              │
│                     └───────────────────┬─────────────────────┘              │
│                                         │                                    │
│                                         │ connected via                      │
│                                         │                                    │
│                     ┌───────────────────▼─────────────────────┐              │
│                     │          JUNCTION TABLES                │              │
│                     │    (Pure glue between entities)         │              │
│                     ├─────────────────────────────────────────┤              │
│                     │  user_roles, role_permissions,          │              │
│                     │  user_permissions                       │              │
│                     │  ───────────────────────────            │              │
│                     │  ✓ Table() construct (lightweight)      │              │
│                     │  ✓ No methods, no class                 │              │
│                     │  ✓ Accessed via relationships           │              │
│                     │  ✓ Just columns + foreign keys          │              │
│                     └─────────────────────────────────────────┘              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Key Takeaway:**

> **Use the simplest tool for the job.**  
> Entity tables need ORM features → Use **class-based models**  
> Junction tables are just glue → Use **Table() construct**

---

## 6. Success Flow

### When Permission is Granted

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        SUCCESS FLOW                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   Request: DELETE /api/v1/users/123                                         │
│   User: admin (has "users:delete" via admin role)                           │
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ 1. Decorator: verify_jwt_in_request() → ✓ Valid token              │   │
│   │ 2. Decorator: get_current_user() → ✓ User "admin" found           │   │
│   │ 3. Decorator: user.is_active → ✓ True                              │   │
│   │ 4. Service: user_has_permission("users:delete") → ✓ True          │   │
│   │ 5. Decorator: Execute route function                               │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                       │
│                                      ▼                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ Route Function Executes:                                            │   │
│   │                                                                      │   │
│   │   def delete_user(path: UserPath):                                  │   │
│   │       user = User.query.get_or_404(path.user_id)                   │   │
│   │       user.soft_delete()                                            │   │
│   │       db.session.commit()                                           │   │
│   │       return success_response(                                      │   │
│   │           message="User deleted successfully",                      │   │
│   │           data={"user_id": path.user_id}                           │   │
│   │       )                                                              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                       │
│                                      ▼                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ Response:                                                            │   │
│   │                                                                      │   │
│   │   HTTP 200 OK                                                        │   │
│   │   {                                                                  │   │
│   │       "success": true,                                               │   │
│   │       "data": {                                                      │   │
│   │           "user_id": 123                                             │   │
│   │       },                                                             │   │
│   │       "error": null,                                                 │   │
│   │       "meta": null                                                   │   │
│   │   }                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Error Handling Flow

### 7.1 Unauthorized (401) - No Token

```
Request: DELETE /api/v1/users/123
Headers: (no Authorization header)

Flow:
┌─────────────────────────────────────────────────┐
│ Decorator: verify_jwt_in_request()              │
│ → Raises: NoAuthorizationError                  │
└─────────────────────┬───────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────┐
│ Decorator catches exception, returns:           │
│                                                 │
│ HTTP 401 Unauthorized                           │
│ {                                               │
│     "success": false,                           │
│     "data": null,                               │
│     "error": {                                  │
│         "code": "UNAUTHORIZED",                 │
│         "message": "Authentication required"   │
│     }                                           │
│ }                                               │
└─────────────────────────────────────────────────┘
```

### 7.2 Forbidden (403) - No Permission

```
Request: DELETE /api/v1/users/123
User: "regular_user" (only has "users:read")

Flow:
┌─────────────────────────────────────────────────┐
│ 1. verify_jwt_in_request() → ✓                 │
│ 2. get_current_user() → ✓ "regular_user"       │
│ 3. is_active → ✓ True                          │
│ 4. user_has_permission("users:delete")         │
│    → get_all_permissions() = {"users:read"}    │
│    → "users:delete" in set? → NO               │
│    → "*:*" in set? → NO                        │
│    → "users:*" in set? → NO                    │
│    → returns False                              │
└─────────────────────┬───────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────┐
│ Decorator returns:                              │
│                                                 │
│ HTTP 403 Forbidden                              │
│ {                                               │
│     "success": false,                           │
│     "data": null,                               │
│     "error": {                                  │
│         "code": "FORBIDDEN",                    │
│         "message": "Insufficient permissions", │
│         "details": {                            │
│             "required_permissions":             │
│                 ["users:delete"]                │
│         }                                       │
│     }                                           │
│ }                                               │
└─────────────────────────────────────────────────┘
```

### 7.3 Global Error Handler

```
┌─────────────────────────────────────────────────────────────────────────────┐
│   app/utils/error_handlers.py                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   # RBAC-specific exception handlers registered in register_error_handlers  │
│                                                                              │
│   @app.errorhandler(PermissionDeniedError)                                  │
│   def handle_permission_denied(error):                                       │
│       logger.warning(f"Permission denied: {error.message}")                 │
│       return error_response(                                                 │
│           code=ErrorCode.FORBIDDEN,                                          │
│           message=error.message,                                             │
│           details={"required_permissions": error.required_permissions},     │
│           status_code=403                                                    │
│       )                                                                      │
│                                                                              │
│   @app.errorhandler(RoleNotFoundError)                                      │
│   def handle_role_not_found(error):                                          │
│       return error_response(                                                 │
│           code=ErrorCode.RESOURCE_NOT_FOUND,                                 │
│           message=error.message,                                             │
│           status_code=404                                                    │
│       )                                                                      │
│                                                                              │
│   @app.errorhandler(RBACError)  # Catch-all for RBAC errors                 │
│   def handle_generic_rbac_error(error):                                      │
│       return error_response(                                                 │
│           code=ErrorCode.INTERNAL_ERROR,                                     │
│           message="Access control error",                                    │
│           status_code=500                                                    │
│       )                                                                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Complete Flow Diagrams

### Full Request Lifecycle

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    COMPLETE RBAC REQUEST LIFECYCLE                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   CLIENT                                                                     │
│   ──────                                                                     │
│   DELETE /api/v1/users/123                                                   │
│   Authorization: Bearer <token>                                              │
│              │                                                               │
│              ▼                                                               │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │                         FLASK APPLICATION                             │  │
│   ├──────────────────────────────────────────────────────────────────────┤  │
│   │                                                                       │  │
│   │  1. ROUTING LAYER                                                     │  │
│   │     └── Match URL to route handler                                    │  │
│   │              │                                                        │  │
│   │              ▼                                                        │  │
│   │  2. DECORATOR LAYER (@permission_required)                            │  │
│   │     ├── verify_jwt_in_request()                                       │  │
│   │     │       │                                                         │  │
│   │     │   ┌───┴───┐                                                     │  │
│   │     │ VALID   INVALID ────────────────────────────────▶ 401          │  │
│   │     │   │                                                             │  │
│   │     │   ▼                                                             │  │
│   │     ├── get_current_user()                                            │  │
│   │     │       │                                                         │  │
│   │     │   ┌───┴───┐                                                     │  │
│   │     │ FOUND  NOT FOUND ───────────────────────────────▶ 401          │  │
│   │     │   │                                                             │  │
│   │     │   ▼                                                             │  │
│   │     ├── check user.is_active                                          │  │
│   │     │       │                                                         │  │
│   │     │   ┌───┴───┐                                                     │  │
│   │     │ ACTIVE INACTIVE ────────────────────────────────▶ 403          │  │
│   │     │   │                                                             │  │
│   │     │   ▼                                                             │  │
│   │     └── RBACService.user_has_permission()                             │  │
│   │              │                                                        │  │
│   │              ▼                                                        │  │
│   │  3. SERVICE LAYER (RBACService)                                       │  │
│   │     └── user.get_all_permissions()                                    │  │
│   │              │                                                        │  │
│   │              ▼                                                        │  │
│   │  4. MODEL LAYER (User, Role, Permission)                              │  │
│   │     ├── Query user's roles                                            │  │
│   │     ├── Query each role's permissions                                 │  │
│   │     ├── Walk role inheritance chain                                   │  │
│   │     ├── Query direct_permissions                                      │  │
│   │     └── Return combined set                                           │  │
│   │              │                                                        │  │
│   │              ▼                                                        │  │
│   │  5. BACK TO SERVICE                                                   │  │
│   │     └── Check if required permission in set                           │  │
│   │              │                                                        │  │
│   │          ┌───┴───┐                                                    │  │
│   │        HAS     LACKS ─────────────────────────────────▶ 403          │  │
│   │          │                                                            │  │
│   │          ▼                                                            │  │
│   │  6. ROUTE HANDLER EXECUTES                                            │  │
│   │     └── Business logic (delete user)                                  │  │
│   │              │                                                        │  │
│   │              ▼                                                        │  │
│   │  7. RESPONSE FORMATTING                                               │  │
│   │     └── success_response() ───────────────────────────▶ 200          │  │
│   │                                                                       │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│              │                                                               │
│              ▼                                                               │
│   CLIENT receives JSON response                                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Database Query Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    DATABASE QUERIES FOR PERMISSION CHECK                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   user.get_all_permissions() triggers:                                       │
│                                                                              │
│   1. Query user's roles:                                                     │
│      SELECT r.* FROM rbac.roles r                                           │
│      JOIN rbac.user_roles ur ON ur.role_id = r.id                           │
│      WHERE ur.user_id = :user_id                                             │
│                                                                              │
│   2. For each role, query permissions:                                       │
│      SELECT p.* FROM rbac.permissions p                                      │
│      JOIN rbac.role_permissions rp ON rp.permission_id = p.id               │
│      WHERE rp.role_id = :role_id                                             │
│                                                                              │
│   3. Query direct permissions:                                               │
│      SELECT p.* FROM rbac.permissions p                                      │
│      JOIN rbac.user_permissions up ON up.permission_id = p.id               │
│      WHERE up.user_id = :user_id                                             │
│                                                                              │
│   OPTIMIZATION: SQLAlchemy uses eager loading (joinedload) to minimize      │
│   database round trips. With proper configuration, this is 1-2 queries.     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Summary

### Key Implementation Points

| Component     | File                          | Responsibility                |
| ------------- | ----------------------------- | ----------------------------- |
| **Entry**     | `run.py`                      | Starts Flask app              |
| **Factory**   | `app/__init__.py`             | Creates app, registers routes |
| **Routes**    | `app/routes/v1/*`             | HTTP endpoints                |
| **Decorator** | `app/rbac/decorators.py`      | Guards routes                 |
| **Service**   | `app/rbac/services.py`        | Permission logic              |
| **Models**    | `app/models/*`                | Data layer                    |
| **Errors**    | `app/utils/error_handlers.py` | Global handlers               |

### Flow Summary

```
Request → Flask → Decorator → Service → Model → Service → Decorator → Response
           │         │          │        │         │          │          │
         Route    JWT/Auth   Check     Query    Return    Grant/     JSON
         Match    Verify     Perms      DB      Perms     Deny
```

---

> **Previous:** [5.8 RBAC Architecture](./5.8_rbac_architecture.md) - Conceptual design and data flow
