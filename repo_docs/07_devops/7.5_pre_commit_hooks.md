# 7.5 Pre-commit Hooks

> **Automating Code Quality Checks Before Every Commit**

This document explains how pre-commit hooks work and details our configuration in `.pre-commit-config.yaml`.

---

## Table of Contents

1. [What Are Pre-commit Hooks?](#what-are-pre-commit-hooks)
2. [Installation](#installation)
3. [Our Configuration](#our-configuration)
4. [Hook Categories](#hook-categories)
5. [Running Hooks](#running-hooks)
6. [Skipping Hooks](#skipping-hooks)
7. [Troubleshooting](#troubleshooting)

---

## What Are Pre-commit Hooks?

### The Problem

```
Developer: *commits code*
CI: âŒ Build failed - formatting issues, unused imports, security vulnerabilities
Developer: *fixes issues, commits again*
CI: âŒ Build failed - another issue
Developer: ðŸ˜¤
```

### The Solution

Pre-commit hooks run checks **locally before each commit**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Pre-commit Flow                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Developer: git commit -m "feat: add feature"                           â”‚
â”‚                                                                          â”‚
â”‚       â”‚                                                                  â”‚
â”‚       â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                     PRE-COMMIT HOOKS                             â”‚    â”‚
â”‚  â”‚                                                                  â”‚    â”‚
â”‚  â”‚  1. âœ… check-added-large-files                                  â”‚    â”‚
â”‚  â”‚  2. âœ… check-merge-conflict                                     â”‚    â”‚
â”‚  â”‚  3. ðŸ“ trailing-whitespace (fixed)                              â”‚    â”‚
â”‚  â”‚  4. ðŸ“ black (reformatted 2 files)                              â”‚    â”‚
â”‚  â”‚  5. ðŸ“ isort (sorted imports)                                   â”‚    â”‚
â”‚  â”‚  6. âœ… flake8                                                   â”‚    â”‚
â”‚  â”‚  7. âœ… bandit (security)                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚       â”‚                                                                  â”‚
â”‚       â–¼                                                                  â”‚
â”‚  All hooks passed â†’ Commit proceeds âœ…                                   â”‚
â”‚                                                                          â”‚
â”‚  OR                                                                      â”‚
â”‚                                                                          â”‚
â”‚  Hook failed â†’ Commit blocked, fix and retry âŒ                         â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Benefits

| Benefit                | Description                                    |
| ---------------------- | ---------------------------------------------- |
| **Catch issues early** | Before they reach the repo                     |
| **Consistent code**    | Same formatting across all developers          |
| **Faster CI**          | CI doesn't fail on trivial issues              |
| **Auto-fix**           | Many hooks automatically fix problems          |
| **Security**           | Catch vulnerabilities before they're committed |

---

## Installation

### First Time Setup

```bash
# Install pre-commit
pip install pre-commit

# Install hooks for this repo
pre-commit install

# Install commit-msg hook (for conventional commits)
pre-commit install --hook-type commit-msg

# Run on all files (recommended first time)
pre-commit run --all-files
```

### What Happens

After `pre-commit install`:

```
.git/hooks/pre-commit  â† Created/replaced by pre-commit
.git/hooks/commit-msg  â† Created/replaced if --hook-type commit-msg
```

Now every `git commit` triggers the hooks automatically.

---

## Our Configuration

### File: `.pre-commit-config.yaml`

This file defines all the hooks that run before each commit.

### Structure Overview

```yaml
repos:
    - repo: https://github.com/pre-commit/pre-commit-hooks
      rev: v4.5.0
      hooks:
          - id: check-added-large-files
          - id: trailing-whitespace
          # ... more hooks

    - repo: https://github.com/psf/black
      rev: 24.1.1
      hooks:
          - id: black
            args: ["--line-length=100"]

    # ... more repos
```

| Field   | Meaning                        |
| ------- | ------------------------------ |
| `repos` | List of hook repositories      |
| `repo`  | Git URL of the hook repository |
| `rev`   | Version/tag to use             |
| `hooks` | List of hooks from this repo   |
| `id`    | Hook identifier                |
| `args`  | Arguments passed to the hook   |

---

## Hook Categories

### 1. General Checks (pre-commit-hooks)

```yaml
- repo: https://github.com/pre-commit/pre-commit-hooks
  rev: v4.5.0
  hooks:
      - id: check-added-large-files
        args: ["--maxkb=1000"]
      - id: check-merge-conflict
      - id: end-of-file-fixer
      - id: trailing-whitespace
      - id: check-yaml
      - id: check-json
      - id: debug-statements
      - id: detect-private-key
      - id: check-ast
      - id: no-commit-to-branch
        args: ["--branch", "main", "--branch", "master"]
```

| Hook                      | What It Does                             |
| ------------------------- | ---------------------------------------- |
| `check-added-large-files` | Block files > 1MB                        |
| `check-merge-conflict`    | Find leftover `<<<<<<<` markers          |
| `end-of-file-fixer`       | Ensure files end with newline            |
| `trailing-whitespace`     | Remove trailing spaces                   |
| `check-yaml`              | Validate YAML syntax                     |
| `check-json`              | Validate JSON syntax                     |
| `debug-statements`        | Find `import pdb; pdb.set_trace()`       |
| `detect-private-key`      | Find accidentally committed private keys |
| `check-ast`               | Validate Python syntax                   |
| `no-commit-to-branch`     | Block direct commits to main/master      |

### 2. Commit Message Validation

```yaml
- repo: https://github.com/compilerla/conventional-pre-commit
  rev: v3.1.0
  hooks:
      - id: conventional-pre-commit
        stages: [commit-msg]
        args:
            - feat # New feature
            - fix # Bug fix
            - docs # Documentation
            - style # Formatting
            - refactor # Code restructuring
            - perf # Performance
            - test # Tests
            - build # Build system
            - ci # CI configuration
            - chore # Maintenance
            - revert # Revert commit
```

**Conventional Commit Format:**

```
type(scope): description

# Examples:
feat: add user registration endpoint
fix(auth): resolve token refresh issue
docs: update README with setup instructions
```

### 3. Code Formatting (Black)

```yaml
- repo: https://github.com/psf/black
  rev: 24.1.1
  hooks:
      - id: black
        language_version: python3
        args: ["--line-length=100"]
```

Black is an **opinionated** formatter - no configuration debates!

**Before Black:**

```python
user = {"name": "John", "email": "john@example.com", "age": 30, "active": True}
```

**After Black:**

```python
user = {
    "name": "John",
    "email": "john@example.com",
    "age": 30,
    "active": True,
}
```

### 4. Import Sorting (isort)

```yaml
- repo: https://github.com/pycqa/isort
  rev: 5.13.2
  hooks:
      - id: isort
        args: ["--profile=black", "--line-length=100"]
```

**Before isort:**

```python
from flask import Flask
import logging
from app.models import User
import os
from typing import List
```

**After isort:**

```python
import logging
import os
from typing import List

from flask import Flask

from app.models import User
```

Groups: stdlib â†’ third-party â†’ local

### 5. Linting (Flake8)

```yaml
- repo: https://github.com/pycqa/flake8
  rev: 7.0.0
  hooks:
      - id: flake8
        args:
            - "--max-line-length=100"
            - "--extend-ignore=E203,W503"
            - "--exclude=venv,migrations,__pycache__"
        additional_dependencies:
            - flake8-bugbear
            - flake8-comprehensions
```

Catches:

-   Unused imports (`F401`)
-   Undefined names (`F821`)
-   Bad practices (via plugins)

### 6. Type Checking (MyPy)

```yaml
- repo: https://github.com/pre-commit/mirrors-mypy
  rev: v1.8.0
  hooks:
      - id: mypy
        args:
            - "--ignore-missing-imports"
            - "--no-error-summary"
        exclude: "tests/|migrations/"
```

**Note:** Runs with `continue-on-error: true` in some setups since type checking can be strict.

### 7. Security Scanning (Bandit)

```yaml
- repo: https://github.com/pycqa/bandit
  rev: 1.7.7
  hooks:
      - id: bandit
        args: ["-c", "pyproject.toml"]
        additional_dependencies: ["bandit[toml]"]
        exclude: "tests/"
```

Bandit finds security issues:

-   Hardcoded passwords
-   SQL injection vulnerabilities
-   Use of `eval()`
-   Weak cryptography

### 8. Markdown Linting

```yaml
- repo: https://github.com/igorshubovych/markdownlint-cli
  rev: v0.39.0
  hooks:
      - id: markdownlint
        args: ["--fix", "--disable", "MD013", "MD033", "MD041"]
```

Checks markdown files for:

-   Consistent heading levels
-   Proper list formatting
-   Link validity

---

## Running Hooks

### Automatic (On Commit)

```bash
git commit -m "feat: add feature"
# Hooks run automatically
```

### Manual (All Files)

```bash
# Run on all files
pre-commit run --all-files

# Run specific hook on all files
pre-commit run black --all-files

# Run on staged files only
pre-commit run
```

### Update Hooks

```bash
# Update to latest versions
pre-commit autoupdate
```

---

## Skipping Hooks

### Skip All Hooks

```bash
git commit --no-verify -m "WIP: work in progress"
# or
git commit -n -m "WIP: work in progress"
```

### Skip Specific Hooks

```bash
SKIP=mypy git commit -m "feat: skip type checking for now"

# Skip multiple
SKIP=mypy,bandit git commit -m "feat: skip multiple hooks"
```

**Warning:** Use sparingly! Skipping defeats the purpose.

---

## Troubleshooting

### Hook Failed - How to Fix

```
Fixing trailing whitespace.......................................Fixed
black....................................................................Failed
```

**Solution:** Black modified files. Stage them and commit again:

```bash
git add .
git commit -m "feat: your message"
```

### Flake8 Errors

```
app/routes/users.py:42:1 F401 'os' imported but unused
```

**Solution:** Remove the unused import.

### Commit Message Rejected

```
bad commit message: "fixed stuff"
```

**Solution:** Use conventional format:

```bash
git commit -m "fix: resolve authentication bug"
```

### Hook Installation Issues

```bash
# Reinstall hooks
pre-commit clean
pre-commit install
pre-commit install --hook-type commit-msg
```

### Cache Issues

```bash
# Clear pre-commit cache
pre-commit clean

# Force reinstall
pre-commit autoupdate
pre-commit install --install-hooks
```

---

## Summary

### Hooks at a Glance

| Hook Category  | Tools            | Purpose                  |
| -------------- | ---------------- | ------------------------ |
| General checks | pre-commit-hooks | Files, syntax, conflicts |
| Commit message | conventional     | Enforce commit format    |
| Formatting     | Black            | Code style               |
| Import sorting | isort            | Import organization      |
| Linting        | Flake8           | Code quality             |
| Type checking  | MyPy             | Type correctness         |
| Security       | Bandit           | Vulnerability detection  |
| Markdown       | markdownlint     | Documentation quality    |

### Quick Commands

| Task                      | Command                      |
| ------------------------- | ---------------------------- |
| Install hooks             | `pre-commit install`         |
| Run on all files          | `pre-commit run --all-files` |
| Update hooks              | `pre-commit autoupdate`      |
| Skip hooks (escape hatch) | `git commit --no-verify`     |
| Skip specific hook        | `SKIP=mypy git commit`       |

---

## Next Steps

-   **[7.6 GitHub Actions](./7.6_github_actions.md)** - CI/CD pipeline
-   **[7.1 DevOps Overview](./7.1_devops_overview.md)** - Full DevOps stack

---

> **Related Documentation:**
>
> -   [.pre-commit-config.yaml](../../.pre-commit-config.yaml)
> -   [CONTRIBUTING.md](../../CONTRIBUTING.md)
