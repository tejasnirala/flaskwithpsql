# 7.6 GitHub Actions

> **Continuous Integration and Deployment with GitHub Actions**

This document explains our GitHub Actions CI/CD pipeline defined in `.github/workflows/ci.yml`.

---

## Table of Contents

1. [What is GitHub Actions?](#what-is-github-actions)
2. [Our CI Pipeline](#our-ci-pipeline)
3. [Workflow File Structure](#workflow-file-structure)
4. [Pipeline Stages](#pipeline-stages)
5. [Understanding the YAML](#understanding-the-yaml)
6. [Adding New Jobs](#adding-new-jobs)
7. [Debugging Failures](#debugging-failures)

---

## What is GitHub Actions?

### Definition

**GitHub Actions** is a CI/CD platform built into GitHub that automates workflows based on repository events.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     GitHub Actions Flow                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Push/PR to Repository                                                   │
│       │                                                                  │
│       ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ .github/workflows/ci.yml                                         │    │
│  │                                                                  │    │
│  │ Triggered → GitHub spins up runners (Linux VMs)                 │    │
│  │           → Runs jobs defined in workflow                        │    │
│  │           → Reports status back to PR                           │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│       │                                                                  │
│       ▼                                                                  │
│  All Jobs Passed?                                                        │
│       │                                                                  │
│  Yes ─┴─ No                                                              │
│   │     │                                                                │
│   ▼     ▼                                                                │
│  ✅     ❌                                                               │
│  PR     PR Blocked                                                       │
│  Ready  (must fix)                                                       │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Key Concepts

| Concept      | Description                                             |
| ------------ | ------------------------------------------------------- |
| **Workflow** | YAML file defining automation (`.github/workflows/`)    |
| **Event**    | Trigger (push, PR, schedule, manual)                    |
| **Job**      | Set of steps that run on one runner                     |
| **Step**     | Individual task within a job                            |
| **Runner**   | VM that executes the job (GitHub-hosted or self-hosted) |
| **Action**   | Reusable unit of code (e.g., `actions/checkout@v4`)     |

---

## Our CI Pipeline

### Overview

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    CI Pipeline Stages                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Push/PR to main or develop                                              │
│       │                                                                  │
│       │                                                                  │
│       ├─────────────────┬─────────────────┐                             │
│       │                 │                 │                             │
│       ▼                 ▼                 ▼                             │
│  ┌─────────┐       ┌─────────┐       ┌─────────┐                        │
│  │  lint   │       │security │       │  test   │  (parallel)            │
│  │         │       │         │       │         │                        │
│  │ • black │       │ • bandit│       │ • pytest│                        │
│  │ • isort │       │ • safety│       │ • cov   │                        │
│  │ • flake8│       │         │       │         │                        │
│  │ • mypy  │       │         │       │         │                        │
│  └────┬────┘       └────┬────┘       └────┬────┘                        │
│       │                 │                 │                             │
│       └─────────────────┴─────────────────┘                             │
│                         │                                                │
│                         ▼                                                │
│                   All passed?                                            │
│                         │                                                │
│                ┌────────┴────────┐                                       │
│               Yes               No                                       │
│                │                 │                                       │
│                ▼                 ▼                                       │
│           ┌─────────┐       ❌ PR Blocked                                │
│           │  build  │                                                    │
│           │         │                                                    │
│           │ • Docker│                                                    │
│           │ • Trivy │                                                    │
│           └─────────┘                                                    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Jobs Summary

| Job        | Purpose                    | Runs On          |
| ---------- | -------------------------- | ---------------- |
| `lint`     | Code formatting and style  | Every push/PR    |
| `security` | Vulnerability scanning     | Every push/PR    |
| `test`     | Unit and integration tests | Every push/PR    |
| `build`    | Docker image build         | main branch only |

---

## Workflow File Structure

### File Location

```
.github/
└── workflows/
    ├── ci.yml                # Main CI pipeline
    └── dependency-check.yml  # Dependency updates
```

### High-Level Structure

```yaml
name: CI # Workflow name

on: # Triggers
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

env: # Global environment variables
    PYTHON_VERSION: "3.11"

jobs: # Job definitions
    lint: ...
    security: ...
    test: ...
    build: ...
```

---

## Pipeline Stages

### Stage 1: Lint Job

```yaml
jobs:
    lint:
        name: Lint & Format
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install black isort flake8 mypy

            - name: Check formatting with Black
              run: black --check --line-length=100 app/ tests/

            - name: Check import sorting with isort
              run: isort --check-only --profile=black --line-length=100 app/ tests/

            - name: Lint with flake8
              run: |
                  flake8 app/ tests/ \
                    --max-line-length=100 \
                    --extend-ignore=E203,W503 \
                    --exclude=__pycache__,migrations

            - name: Type check with mypy
              run: mypy app/ --ignore-missing-imports
              continue-on-error: true
```

**Key Points:**

| Key                         | Meaning                                  |
| --------------------------- | ---------------------------------------- |
| `runs-on: ubuntu-latest`    | Use GitHub's Ubuntu runner               |
| `uses: actions/checkout@v4` | Clone the repository                     |
| `cache: "pip"`              | Cache pip downloads for faster builds    |
| `--check`                   | Don't modify, just check (fail if wrong) |
| `continue-on-error`         | Don't fail the job on this step          |

### Stage 2: Security Job

```yaml
security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up Python
          uses: actions/setup-python@v5
          with:
              python-version: ${{ env.PYTHON_VERSION }}
              cache: "pip"

        - name: Install dependencies
          run: |
              python -m pip install --upgrade pip
              pip install bandit safety

        - name: Run Bandit security scan
          run: bandit -r app/ -x tests/ -ll
          continue-on-error: true

        - name: Check dependencies for vulnerabilities
          run: |
              pip install -r requirements.txt
              safety check --full-report
          continue-on-error: true
```

**Tools Used:**

| Tool     | Purpose                                      |
| -------- | -------------------------------------------- |
| `bandit` | Static analysis for security issues in code  |
| `safety` | Check dependencies for known vulnerabilities |

### Stage 3: Test Job (Currently Commented)

```yaml
# test:
#   name: Test (Python ${{ matrix.python-version }})
#   runs-on: ubuntu-latest
#   strategy:
#     fail-fast: false
#     matrix:
#       python-version: ["3.9", "3.10", "3.11", "3.12"]
#
#   services:
#     postgres:
#       image: postgres:15-alpine
#       env:
#         POSTGRES_PASSWORD: postgres
#       ports:
#         - 5432:5432
#       options: >-
#         --health-cmd pg_isready
#         --health-interval 10s
#
#   steps:
#     - uses: actions/checkout@v4
#     - name: Run tests with coverage
#       run: pytest --cov=app --cov-report=xml -v
```

**Matrix Strategy:**

Runs the same job multiple times with different configurations:

```
┌────────────┬────────────┬────────────┬────────────┐
│  Python    │  Python    │  Python    │  Python    │
│   3.9      │   3.10     │   3.11     │   3.12     │
│            │            │            │            │
│  pytest    │  pytest    │  pytest    │  pytest    │
└────────────┴────────────┴────────────┴────────────┘
         All run in parallel
```

**Services:**

GitHub Actions can spin up containers as services:

```yaml
services:
    postgres:
        image: postgres:15-alpine
        ports:
            - 5432:5432
```

### Stage 4: Build Job (Commented)

```yaml
# build:
#   name: Build Docker Image
#   runs-on: ubuntu-latest
#   needs: [lint, test]  # Only run after lint and test pass
#   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
#
#   steps:
#     - uses: actions/checkout@v4
#     - uses: docker/setup-buildx-action@v3
#     - uses: docker/build-push-action@v5
#       with:
#         context: .
#         push: false
#         target: production
#         cache-from: type=gha
#         cache-to: type=gha,mode=max
```

**Key Points:**

| Key          | Meaning                                    |
| ------------ | ------------------------------------------ |
| `needs`      | Wait for these jobs to complete first      |
| `if`         | Only run under certain conditions          |
| `cache-from` | Use GitHub Actions cache for Docker layers |

---

## Understanding the YAML

### Events (`on`)

```yaml
on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
```

Triggers when:

-   Push to `main` or `develop`
-   PR opened against `main` or `develop`

### Environment Variables (`env`)

```yaml
env:
    PYTHON_VERSION: "3.11"
```

Available as `${{ env.PYTHON_VERSION }}` in all jobs.

### Steps

```yaml
steps:
    - name: Human-readable step name
      uses: action/repo@version # Use an action
      with: # Action inputs
          key: value

    - name: Another step
      run: | # Run shell commands
          echo "Hello"
          python script.py
```

### Conditional Execution

```yaml
- name: Only on main
  if: github.ref == 'refs/heads/main'
  run: deploy.sh

- name: Only on PR
  if: github.event_name == 'pull_request'
  run: preview.sh
```

### Continue on Error

```yaml
- name: Optional check
  run: mypy app/
  continue-on-error: true # Job continues even if this fails
```

---

## Adding New Jobs

### Example: Add Coverage Upload

```yaml
test:
    # ... existing config ...

    steps:
        - name: Run tests with coverage
          run: pytest --cov=app --cov-report=xml -v

        # Add this step:
        - name: Upload coverage to Codecov
          uses: codecov/codecov-action@v3
          with:
              files: ./coverage.xml
              fail_ci_if_error: false
```

### Example: Add Deployment

```yaml
deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [lint, test, build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
        - name: Deploy to server
          uses: appleboy/ssh-action@master
          with:
              host: ${{ secrets.SERVER_HOST }}
              username: ${{ secrets.SERVER_USER }}
              key: ${{ secrets.SSH_PRIVATE_KEY }}
              script: |
                  cd /app
                  git pull
                  docker compose up -d --build
```

### Secrets

Store sensitive values in repository settings:

1. Go to Repository → Settings → Secrets and variables → Actions
2. Add secrets (e.g., `SERVER_HOST`, `SSH_PRIVATE_KEY`)
3. Use as `${{ secrets.SECRET_NAME }}`

---

## Debugging Failures

### View Logs

1. Go to repository → Actions tab
2. Click on the failed workflow run
3. Click on the failed job
4. Expand the failed step to see logs

### Re-run Failed Jobs

1. Go to the failed workflow run
2. Click "Re-run jobs" → "Re-run failed jobs"

### Debug Locally

Reproduce the CI environment locally:

```bash
# Install same tools
pip install black isort flake8 mypy bandit

# Run same commands
black --check --line-length=100 app/
isort --check-only --profile=black app/
flake8 app/ --max-line-length=100
```

### Common Issues

| Issue            | Solution                          |
| ---------------- | --------------------------------- |
| Formatting fails | Run `black app/` and `isort app/` |
| Flake8 fails     | Fix the reported errors           |
| Test fails       | Check test output for details     |
| Dependency issue | Check `requirements.txt` versions |

---

## Summary

### Pipeline Overview

| Stage    | Checks                     | Required? |
| -------- | -------------------------- | --------- |
| Lint     | Black, isort, flake8, mypy | Yes       |
| Security | Bandit, safety             | No (warn) |
| Test     | pytest, coverage           | Yes       |
| Build    | Docker image               | Main only |

### Quick Reference

| I want to...        | Look at...                      |
| ------------------- | ------------------------------- |
| See workflow status | GitHub repo → Actions tab       |
| Edit workflow       | `.github/workflows/ci.yml`      |
| Add secrets         | Settings → Secrets → Actions    |
| Debug locally       | Run same commands from workflow |

---

## Next Steps

-   **[7.7 Environment Variables](./7.7_environment_variables.md)** - Managing secrets
-   **[7.8 Production Deployment](./7.8_production_deployment.md)** - Deployment considerations

---

> **Related Documentation:**
>
> -   [.github/workflows/ci.yml](../../.github/workflows/ci.yml)
> -   [GitHub Actions Documentation](https://docs.github.com/en/actions)
