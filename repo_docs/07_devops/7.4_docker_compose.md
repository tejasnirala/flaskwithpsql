# 7.4 Docker Compose Explained

> **Orchestrating Multiple Containers for Local Development**

This document explains our `docker-compose.yml` file, which defines how to run the Flask application along with PostgreSQL, Redis, and other services.

---

## Table of Contents

1. [What is Docker Compose?](#what-is-docker-compose)
2. [Our Services](#our-services)
3. [Flask Application Service](#flask-application-service)
4. [PostgreSQL Database Service](#postgresql-database-service)
5. [Redis Service](#redis-service)
6. [pgAdmin Service](#pgadmin-service)
7. [Networks and Volumes](#networks-and-volumes)
8. [Commands](#commands)

---

## What is Docker Compose?

### The Problem

Running multiple containers manually is tedious:

```bash
# Without Docker Compose
docker run -d --name db postgres:15 -e POSTGRES_PASSWORD=...
docker run -d --name redis redis:7
docker run -d --name web --link db --link redis myapp
# And more options for each...
```

### The Solution

Docker Compose lets you define everything in one file:

```yaml
# docker-compose.yml
services:
    web: ...
    db: ...
    redis: ...
```

Then start everything with one command:

```bash
docker compose up
```

---

## Our Services

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Docker Compose Services                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                        flask_network                             │    │
│  │  ┌───────────────────────────────────────────────────────────┐  │    │
│  │  │                                                           │  │    │
│  │  │   ┌─────────────┐                                         │  │    │
│  │  │   │    web      │◄──── http://localhost:5500              │  │    │
│  │  │   │  (Flask)    │                                         │  │    │
│  │  │   └──────┬──────┘                                         │  │    │
│  │  │          │                                                │  │    │
│  │  │    ┌─────┴─────┐                                          │  │    │
│  │  │    │           │                                          │  │    │
│  │  │    ▼           ▼                                          │  │    │
│  │  │ ┌─────────┐ ┌─────────┐                                   │  │    │
│  │  │ │   db    │ │  redis  │                                   │  │    │
│  │  │ │(Postgres)│ │        │                                   │  │    │
│  │  │ └─────────┘ └─────────┘                                   │  │    │
│  │  │      ▲                                                    │  │    │
│  │  │      │                                                    │  │    │
│  │  │ ┌─────────┐                                               │  │    │
│  │  │ │ pgadmin │◄──── http://localhost:5050 (optional)         │  │    │
│  │  │ │         │                                               │  │    │
│  │  │ └─────────┘                                               │  │    │
│  │  │                                                           │  │    │
│  │  └───────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  Volumes:                                                                │
│  • postgres_data (persistent database)                                   │
│  • redis_data (persistent cache)                                         │
│  • pgadmin_data (pgAdmin configuration)                                  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Flask Application Service

```yaml
services:
    # ===========================================================================
    # Flask Application
    # ===========================================================================
    web:
        build:
            context: .
            dockerfile: Dockerfile
            target: development # Use development stage
```

**Explanation:**

| Field        | Value         | Meaning                           |
| ------------ | ------------- | --------------------------------- |
| `context`    | `.`           | Build from current directory      |
| `dockerfile` | `Dockerfile`  | Use this Dockerfile               |
| `target`     | `development` | Build only to "development" stage |

---

```yaml
container_name: flask_app
ports:
    - "5500:5500"
```

**Explanation:**

-   `container_name: flask_app` - Name for the container (instead of auto-generated)
-   `ports: "5500:5500"` - Map host port 5500 to container port 5500

---

```yaml
environment:
    - FLASK_ENV=development
    - FLASK_DEBUG=1
    - FLASK_APP=run.py
    - DATABASE_URL=postgresql://postgres:postgres@db:5432/flaskwithpsql
    - SECRET_KEY=dev-secret-key-for-docker-compose
    - RATELIMIT_STORAGE_URL=redis://redis:6379
```

**Explanation:**

Environment variables passed to the container:

| Variable                | Value                          | Purpose               |
| ----------------------- | ------------------------------ | --------------------- |
| `FLASK_ENV`             | `development`                  | Enable dev mode       |
| `FLASK_DEBUG`           | `1`                            | Enable debugger       |
| `FLASK_APP`             | `run.py`                       | Flask entry point     |
| `DATABASE_URL`          | `postgresql://...@db:5432/...` | Connect to db service |
| `SECRET_KEY`            | `dev-secret-key...`            | JWT signing key       |
| `RATELIMIT_STORAGE_URL` | `redis://redis:6379`           | Rate limit storage    |

**Note:** `@db` refers to the service name, not `localhost`! Docker Compose creates DNS.

---

```yaml
volumes:
    # Mount source code for hot-reload in development
    - .:/app
    # Exclude these from mount
    - /app/venv
    - /app/__pycache__
```

**Explanation:**

Volume mounts:

| Mount              | Purpose                                     |
| ------------------ | ------------------------------------------- |
| `.:/app`           | Sync local code with container (hot-reload) |
| `/app/venv`        | Don't overwrite container's venv            |
| `/app/__pycache__` | Don't sync cache files                      |

---

```yaml
depends_on:
    db:
        condition: service_healthy
    redis:
        condition: service_started
```

**Explanation:**

Start order and wait conditions:

| Dependency | Condition         | Meaning                          |
| ---------- | ----------------- | -------------------------------- |
| `db`       | `service_healthy` | Wait for healthcheck to pass     |
| `redis`    | `service_started` | Just wait for container to start |

---

```yaml
networks:
    - flask_network
restart: unless-stopped
```

**Explanation:**

-   `networks: flask_network` - Join the shared network
-   `restart: unless-stopped` - Auto-restart unless manually stopped

---

## PostgreSQL Database Service

```yaml
# ===========================================================================
# PostgreSQL Database
# ===========================================================================
db:
    image: postgres:15-alpine
    container_name: flask_db
```

**Explanation:**

-   `image: postgres:15-alpine` - Use official PostgreSQL 15 on Alpine Linux
-   Alpine variant is smaller (~80MB vs ~300MB)

---

```yaml
environment:
    - POSTGRES_USER=postgres
    - POSTGRES_PASSWORD=postgres
    - POSTGRES_DB=flaskwithpsql
```

**Explanation:**

| Variable            | Value           | Purpose               |
| ------------------- | --------------- | --------------------- |
| `POSTGRES_USER`     | `postgres`      | Database username     |
| `POSTGRES_PASSWORD` | `postgres`      | Database password     |
| `POSTGRES_DB`       | `flaskwithpsql` | Default database name |

---

```yaml
volumes:
    # Persist database data
    - postgres_data:/var/lib/postgresql/data
    # Initialize database with custom script if needed
    - ./docker/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
```

**Explanation:**

| Volume                                  | Purpose                      |
| --------------------------------------- | ---------------------------- |
| `postgres_data:/var/lib/...`            | Persist data across restarts |
| `./docker/init-db.sql:/docker-entry...` | Run SQL on first start       |

The `:ro` means read-only.

---

```yaml
ports:
    - "5432:5432"
```

Expose PostgreSQL on host port 5432 (so you can connect with pgAdmin or other tools).

---

```yaml
healthcheck:
    test: ["CMD-SHELL", "pg_isready -U postgres"]
    interval: 5s
    timeout: 5s
    retries: 5
```

**Explanation:**

Health check for PostgreSQL:

| Option     | Value                    | Meaning                      |
| ---------- | ------------------------ | ---------------------------- |
| `test`     | `pg_isready -U postgres` | Command to check health      |
| `interval` | `5s`                     | Check every 5 seconds        |
| `timeout`  | `5s`                     | Fail if check takes > 5s     |
| `retries`  | `5`                      | Mark unhealthy after 5 fails |

This allows `web` service to wait with `condition: service_healthy`.

---

## Redis Service

```yaml
# ===========================================================================
# Redis (for rate limiting and caching)
# ===========================================================================
redis:
    image: redis:7-alpine
    container_name: flask_redis
    ports:
        - "6379:6379"
    volumes:
        - redis_data:/data
    command: redis-server --appendonly yes
    networks:
        - flask_network
    restart: unless-stopped
```

**Explanation:**

| Field     | Value                           | Purpose            |
| --------- | ------------------------------- | ------------------ |
| `image`   | `redis:7-alpine`                | Redis 7 on Alpine  |
| `volumes` | `redis_data:/data`              | Persist redis data |
| `command` | `redis-server --appendonly yes` | Enable persistence |

`--appendonly yes` means Redis logs every write operation, allowing data recovery.

---

## pgAdmin Service

```yaml
# ===========================================================================
# pgAdmin (Database management UI) - Development only
# ===========================================================================
pgadmin:
    image: dpage/pgadmin4:latest
    container_name: flask_pgadmin
    environment:
        - PGADMIN_DEFAULT_EMAIL=admin@example.com
        - PGADMIN_DEFAULT_PASSWORD=admin
        - PGADMIN_CONFIG_SERVER_MODE=False
    ports:
        - "5050:80"
    volumes:
        - pgadmin_data:/var/lib/pgadmin
    depends_on:
        - db
    networks:
        - flask_network
    profiles:
        - tools # Only start with: docker compose --profile tools up
```

**Explanation:**

| Field             | Value             | Purpose                            |
| ----------------- | ----------------- | ---------------------------------- |
| `environment`     | Login credentials | `admin@example.com` / `admin`      |
| `ports`           | `5050:80`         | Access at http://localhost:5050    |
| `profiles: tools` | Optional service  | Only starts with `--profile tools` |

### Starting pgAdmin

```bash
# Start without pgAdmin
docker compose up

# Start WITH pgAdmin
docker compose --profile tools up
```

---

## Networks and Volumes

### Networks

```yaml
# =============================================================================
# Networks
# =============================================================================
networks:
    flask_network:
        driver: bridge
```

**Explanation:**

Creates a virtual network called `flask_network`:

-   All services on this network can communicate by service name
-   `web` can reach `db` at `db:5432`
-   `web` can reach `redis` at `redis:6379`
-   Isolated from other Docker networks

### Volumes

```yaml
# =============================================================================
# Volumes
# =============================================================================
volumes:
    postgres_data:
    redis_data:
    pgadmin_data:
```

**Explanation:**

Named volumes for data persistence:

| Volume          | Used By | Stores                    |
| --------------- | ------- | ------------------------- |
| `postgres_data` | db      | PostgreSQL database files |
| `redis_data`    | redis   | Redis persistence files   |
| `pgadmin_data`  | pgadmin | pgAdmin configuration     |

Data survives container restarts and removal!

---

## Commands

### Basic Operations

```bash
# Start all services
docker compose up

# Start in background
docker compose up -d

# Stop all services
docker compose down

# Stop and remove volumes (DELETES DATA!)
docker compose down -v
```

### Viewing Logs

```bash
# All services
docker compose logs

# Follow logs
docker compose logs -f

# Specific service
docker compose logs web
docker compose logs db
```

### Running Commands

```bash
# Run tests
docker compose run --rm web pytest

# Open shell in running container
docker compose exec web bash

# Run Flask CLI command
docker compose exec web flask db upgrade
```

### Rebuilding

```bash
# Rebuild images
docker compose build

# Rebuild and start
docker compose up --build

# Force rebuild from scratch
docker compose build --no-cache
```

---

## Production Overrides

For production, use `docker-compose.prod.yml` as an override:

```yaml
# docker-compose.prod.yml
services:
    web:
        build:
            target: production
        environment:
            - FLASK_ENV=production
            - FLASK_DEBUG=0
        volumes: [] # Don't mount code (use baked-in)
```

Run with:

```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml up
```

---

## Summary

### Service Overview

| Service   | Image               | Port | Purpose              |
| --------- | ------------------- | ---- | -------------------- |
| `web`     | Custom (Dockerfile) | 5500 | Flask application    |
| `db`      | `postgres:15`       | 5432 | PostgreSQL database  |
| `redis`   | `redis:7`           | 6379 | Rate limiting, cache |
| `pgadmin` | `dpage/pgadmin4`    | 5050 | DB management UI     |

### Quick Reference

| I want to...       | Command                              |
| ------------------ | ------------------------------------ |
| Start everything   | `docker compose up`                  |
| Stop everything    | `docker compose down`                |
| View logs          | `docker compose logs -f`             |
| Run tests          | `docker compose run --rm web pytest` |
| Access shell       | `docker compose exec web bash`       |
| Rebuild and start  | `docker compose up --build`          |
| Start with pgAdmin | `docker compose --profile tools up`  |

---

## Next Steps

-   **[7.5 Pre-commit Hooks](./7.5_pre_commit_hooks.md)** - Code quality automation
-   **[7.6 GitHub Actions](./7.6_github_actions.md)** - CI/CD pipeline

---

> **Related Documentation:**
>
> -   [docker-compose.yml](../../docker-compose.yml)
> -   [docker-compose.prod.yml](../../docker-compose.prod.yml)
