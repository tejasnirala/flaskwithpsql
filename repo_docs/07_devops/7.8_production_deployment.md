# 7.8 Production Deployment

> **Considerations for Deploying Flask to Production**

This document covers key considerations and best practices for deploying our Flask application to a production environment.

---

## Table of Contents

1. [Development vs Production](#development-vs-production)
2. [Production Checklist](#production-checklist)
3. [WSGI Server (Gunicorn)](#wsgi-server-gunicorn)
4. [Reverse Proxy (Nginx)](#reverse-proxy-nginx)
5. [Security Hardening](#security-hardening)
6. [Database Considerations](#database-considerations)
7. [Logging and Monitoring](#logging-and-monitoring)
8. [Deployment Options](#deployment-options)

---

## Development vs Production

### Key Differences

| Aspect           | Development           | Production                  |
| ---------------- | --------------------- | --------------------------- |
| **Server**       | Flask dev server      | Gunicorn + Nginx            |
| **Debug**        | Enabled (auto-reload) | Disabled                    |
| **Error pages**  | Detailed tracebacks   | Generic error pages         |
| **Logging**      | Console + debug level | File + JSON + info level    |
| **Database**     | Local PostgreSQL      | Managed PostgreSQL/RDS      |
| **Secrets**      | .env file             | Environment variables/Vault |
| **HTTPS**        | Optional (localhost)  | Required (TLS certificates) |
| **Static files** | Flask serves          | Nginx/CDN serves            |

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Development Stack                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Browser → Flask Dev Server (port 5500) → PostgreSQL (local)            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                    Production Stack                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Browser                                                                 │
│     │                                                                    │
│     ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  Load Balancer (optional)                                        │    │
│  │  • Distributes traffic across instances                         │    │
│  │  • SSL termination                                              │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│     │                                                                    │
│     ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  Nginx (Reverse Proxy)                                           │    │
│  │  • Serve static files                                           │    │
│  │  • SSL/TLS termination                                          │    │
│  │  • Request buffering                                            │    │
│  │  • Rate limiting                                                │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│     │                                                                    │
│     ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  Gunicorn (WSGI Server)                                          │    │
│  │  • Multiple worker processes                                    │    │
│  │  • Process management                                           │    │
│  │  • Graceful restarts                                            │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│     │                                                                    │
│     ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  Flask Application                                               │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│     │                                                                    │
│     ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  Managed PostgreSQL (AWS RDS, Google Cloud SQL, etc.)            │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Production Checklist

### Before Deploying

-   [ ] **Debug disabled**: `FLASK_DEBUG=0`, `FLASK_ENV=production`
-   [ ] **Secret key**: Random, 32+ characters, environment variable
-   [ ] **Database URL**: Production database, not local
-   [ ] **HTTPS**: SSL/TLS certificate configured
-   [ ] **CORS**: Only allow production frontend origins
-   [ ] **Tests passing**: All tests pass in CI
-   [ ] **Dependencies**: `requirements.txt` pinned to exact versions
-   [ ] **Logs**: JSON logging to files, appropriate levels
-   [ ] **Monitoring**: Health check endpoint working
-   [ ] **Backups**: Database backup strategy in place

### Security Checklist

-   [ ] **No sensitive data in code**: All secrets from environment
-   [ ] **SQL injection protected**: Using SQLAlchemy ORM
-   [ ] **XSS protected**: Proper escaping in templates
-   [ ] **CSRF protected**: If using forms
-   [ ] **Security headers**: Set by Nginx or Flask
-   [ ] **Rate limiting**: Enabled for sensitive endpoints
-   [ ] **Password hashing**: Using PBKDF2/bcrypt

---

## WSGI Server (Gunicorn)

### Why Not Flask's Dev Server?

| Flask Dev Server      | Gunicorn                   |
| --------------------- | -------------------------- |
| Single-threaded       | Multi-worker, multi-thread |
| Not secure            | Production-grade           |
| No process management | Handles crashes gracefully |
| Hot-reload (dev only) | Graceful restarts          |

### Gunicorn Configuration

```bash
# Basic command
gunicorn --bind 0.0.0.0:5500 run:app

# Production settings
gunicorn \
  --bind 0.0.0.0:5500 \
  --workers 4 \
  --threads 2 \
  --timeout 30 \
  --keep-alive 5 \
  --error-logfile /var/log/gunicorn/error.log \
  --access-logfile /var/log/gunicorn/access.log \
  --capture-output \
  run:app
```

### Worker Configuration

```
Workers = (2 × CPU cores) + 1

For a 4-core machine:
  Workers = (2 × 4) + 1 = 9 workers

Each worker handles one request at a time.
Threads allow concurrent handling within a worker.
```

### In Dockerfile

```dockerfile
CMD ["gunicorn", "--bind", "0.0.0.0:5500", "--workers", "4", "--threads", "2", "run:app"]
```

---

## Reverse Proxy (Nginx)

### Why Use Nginx?

| Benefit            | Description                           |
| ------------------ | ------------------------------------- |
| **Static files**   | Efficiently serve CSS/JS/images       |
| **SSL/TLS**        | Handle HTTPS termination              |
| **Buffering**      | Buffer slow clients, protect Gunicorn |
| **Rate limiting**  | Protect against abuse                 |
| **Load balancing** | Distribute across multiple Gunicorns  |

### Example Nginx Configuration

```nginx
server {
    listen 80;
    server_name api.example.com;

    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.example.com;

    # SSL certificates
    ssl_certificate /etc/letsencrypt/live/api.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.example.com/privkey.pem;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000" always;

    # Proxy to Gunicorn
    location / {
        proxy_pass http://127.0.0.1:5500;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Static files (if any)
    location /static {
        alias /app/static;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

---

## Security Hardening

### Environment Variables

```bash
# Production secrets (set via hosting platform)
SECRET_KEY=$(python -c "import secrets; print(secrets.token_hex(32))")
JWT_SECRET_KEY=$(python -c "import secrets; print(secrets.token_hex(32))")

# Disable debug
FLASK_ENV=production
FLASK_DEBUG=0
```

### Flask Security Settings

```python
# config.py - ProductionConfig

class ProductionConfig(Config):
    DEBUG = False
    TESTING = False

    # Session security
    SESSION_COOKIE_SECURE = True       # HTTPS only
    SESSION_COOKIE_HTTPONLY = True     # No JavaScript access
    SESSION_COOKIE_SAMESITE = "Lax"    # CSRF protection

    # Remember me cookie
    REMEMBER_COOKIE_SECURE = True
    REMEMBER_COOKIE_HTTPONLY = True

    # Prefer proxy headers (behind Nginx)
    PREFERRED_URL_SCHEME = "https"
```

### Security Headers

```python
from flask import Flask

def create_app():
    app = Flask(__name__)

    @app.after_request
    def add_security_headers(response):
        response.headers["X-Content-Type-Options"] = "nosniff"
        response.headers["X-Frame-Options"] = "SAMEORIGIN"
        response.headers["X-XSS-Protection"] = "1; mode=block"
        response.headers["Strict-Transport-Security"] = "max-age=31536000"
        return response

    return app
```

---

## Database Considerations

### Managed vs Self-Hosted

| Managed (AWS RDS, etc.)   | Self-Hosted         |
| ------------------------- | ------------------- |
| Automatic backups         | Manual backup setup |
| Easy scaling              | Manual scaling      |
| High availability options | DIY replication     |
| More expensive            | Lower cost          |
| Less control              | Full control        |

### Connection Pooling

```python
# config.py

SQLALCHEMY_ENGINE_OPTIONS = {
    "pool_size": 10,              # Maximum connections
    "pool_recycle": 3600,         # Recycle connections every hour
    "pool_pre_ping": True,        # Verify connection before use
    "max_overflow": 20,           # Allow 20 extra connections
}
```

### Migrations

```bash
# Run migrations before deploying new code
flask db upgrade

# Or in Docker
docker compose exec web flask db upgrade
```

---

## Logging and Monitoring

### Production Logging

```python
# Structured JSON logging
{
    "timestamp": "2026-01-15T10:30:00Z",
    "level": "INFO",
    "request_id": "abc123",
    "method": "POST",
    "path": "/api/v1/users",
    "status": 201,
    "duration_ms": 45.2,
    "user_id": 42
}
```

### Health Check Endpoint

```python
@app.route("/health")
def health():
    try:
        # Check database
        db.session.execute("SELECT 1")
        return {"status": "healthy", "database": "connected"}, 200
    except Exception as e:
        return {"status": "unhealthy", "error": str(e)}, 503
```

### Monitoring Options

| Tool           | Purpose                    |
| -------------- | -------------------------- |
| **Prometheus** | Metrics collection         |
| **Grafana**    | Metrics visualization      |
| **Sentry**     | Error tracking             |
| **ELK Stack**  | Log aggregation and search |
| **New Relic**  | Application performance    |

---

## Deployment Options

### Option 1: Docker on VPS

```bash
# Build and push image
docker build --target production -t myapp:latest .
docker tag myapp:latest registry.example.com/myapp:latest
docker push registry.example.com/myapp:latest

# On server
docker pull registry.example.com/myapp:latest
docker compose -f docker-compose.prod.yml up -d
```

### Option 2: Platform as a Service (PaaS)

**Heroku:**

```bash
heroku create myapp
git push heroku main
heroku config:set SECRET_KEY=...
```

**Render:**

-   Connect GitHub repo
-   Set environment variables in dashboard
-   Deploy automatically on push

### Option 3: Kubernetes

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
    name: flask-app
spec:
    replicas: 3
    selector:
        matchLabels:
            app: flask
    template:
        metadata:
            labels:
                app: flask
        spec:
            containers:
                - name: flask
                  image: myapp:latest
                  ports:
                      - containerPort: 5500
                  env:
                      - name: SECRET_KEY
                        valueFrom:
                            secretKeyRef:
                                name: app-secrets
                                key: secret-key
```

### Option 4: AWS/GCP/Azure

| AWS               | GCP            | Azure              |
| ----------------- | -------------- | ------------------ |
| ECS/EKS           | Cloud Run/GKE  | Container Apps/AKS |
| Elastic Beanstalk | App Engine     | App Service        |
| EC2               | Compute Engine | Virtual Machines   |
| RDS               | Cloud SQL      | Azure Database     |

---

## Summary

### Production Deployment Checklist

```
□ Debug disabled (FLASK_DEBUG=0)
□ Secure secret key (random, from environment)
□ HTTPS enabled (TLS certificate)
□ Gunicorn as WSGI server
□ Nginx as reverse proxy (optional but recommended)
□ Managed database (or properly secured self-hosted)
□ Connection pooling configured
□ Logging to files (JSON format)
□ Health check endpoint
□ Monitoring and alerting
□ Automatic backups
□ Rate limiting enabled
□ CORS properly configured
□ All tests passing
```

### Quick Reference

| Topic      | Development  | Production       |
| ---------- | ------------ | ---------------- |
| Server     | `flask run`  | `gunicorn`       |
| Debug      | `True`       | `False`          |
| Secret Key | `dev-secret` | Random 32+ chars |
| Database   | Local        | Managed/Cloud    |
| HTTPS      | No           | Yes (required)   |
| Logs       | Console      | Files + JSON     |

---

> **Related Documentation:**
>
> -   [Dockerfile](../../Dockerfile) - Multi-stage build
> -   [docker-compose.prod.yml](../../docker-compose.prod.yml) - Production overrides
> -   [config.py](../../config.py) - Configuration classes
