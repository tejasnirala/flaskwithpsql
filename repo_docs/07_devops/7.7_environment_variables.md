# 7.7 Environment Variables

> **Managing Configuration and Secrets Securely**

This document explains how we manage environment variables and secrets in our Flask application across different environments.

---

## Table of Contents

1. [What Are Environment Variables?](#what-are-environment-variables)
2. [Why Use Environment Variables?](#why-use-environment-variables)
3. [Our Configuration Files](#our-configuration-files)
4. [Environment Variable Categories](#environment-variable-categories)
5. [Configuration in Flask](#configuration-in-flask)
6. [Best Practices](#best-practices)
7. [Environment-Specific Config](#environment-specific-config)

---

## What Are Environment Variables?

### Definition

**Environment variables** are key-value pairs that configure your application without hardcoding values in source code.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Environment Variables                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Without env vars:                                                       │
│  ─────────────────                                                       │
│  # In code (BAD!)                                                        │
│  DATABASE_URL = "postgresql://user:pass@prod-server:5432/db"            │
│  SECRET_KEY = "super-secret-key-visible-in-git"                         │
│                                                                          │
│  Problems:                                                               │
│  • Secrets visible in source code                                        │
│  • Can't change without code deployment                                  │
│  • Different values needed for dev/staging/prod                          │
│                                                                          │
│  With env vars:                                                          │
│  ───────────────                                                         │
│  # In code (GOOD!)                                                       │
│  DATABASE_URL = os.environ.get("DATABASE_URL")                          │
│  SECRET_KEY = os.environ.get("SECRET_KEY")                              │
│                                                                          │
│  Benefits:                                                               │
│  • Secrets not in code                                                   │
│  • Change without redeploying                                            │
│  • Different values per environment                                      │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Why Use Environment Variables?

### The Twelve-Factor App

Environment variables follow the [Twelve-Factor App](https://12factor.net/) methodology:

> **III. Config**: Store config in the environment

```
┌────────────────────────────────────────────────────────────────────────┐
│             Config Across Environments                                  │
├────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  SAME CODE                    DIFFERENT CONFIG                          │
│  ─────────                    ────────────────                          │
│                                                                         │
│  ┌─────────────┐              Development:                              │
│  │             │              DATABASE_URL=postgresql://localhost...    │
│  │   app.py    │──────────►   SECRET_KEY=dev-secret                     │
│  │   routes/   │              DEBUG=1                                   │
│  │   models/   │                                                        │
│  │             │              Production:                               │
│  │             │──────────►   DATABASE_URL=postgresql://prod-db...      │
│  │             │              SECRET_KEY=<random-32-chars>              │
│  │             │              DEBUG=0                                   │
│  └─────────────┘                                                        │
│                                                                         │
│  Same code runs in all environments, config differs                     │
│                                                                         │
└────────────────────────────────────────────────────────────────────────┘
```

### Benefits

| Benefit         | Description                        |
| --------------- | ---------------------------------- |
| **Security**    | Secrets not in version control     |
| **Flexibility** | Change config without code changes |
| **Separation**  | Same code, different environments  |
| **Simplicity**  | Standard way supported everywhere  |

---

## Our Configuration Files

### Files Overview

```
flaskwithpsql/
├── .env              # Local development (NOT in git)
├── .env.example      # Template with dummy values (IN git)
├── config.py         # Python configuration classes
└── docker-compose.yml # Container environment
```

### .env.example (Template)

```bash
# Flask Configuration
FLASK_PORT=5000
FLASK_APP=run.py
FLASK_ENV=development
FLASK_DEBUG=1
SECRET_KEY=your-super-secret-key-change-in-production

# Database Configuration
## Connection String
DATABASE_URL=postgresql://username:password@localhost:5432/flaskwithpsql

## Or use individual variables
DB_USER=postgres
DB_PASSWORD=your_password
DB_HOST=localhost
DB_PORT=5432
DB_NAME=flaskwithpsql

# CORS Configuration
CORS_ORIGINS=http://localhost:3000,http://localhost:3001
CORS_METHODS=GET,POST,PUT,DELETE,OPTIONS
CORS_ALLOW_HEADERS=Content-Type,Authorization
CORS_EXPOSE_HEADERS=Content-Type,Authorization
CORS_CREDENTIALS=true
CORS_MAX_AGE=3600
```

### .env (Actual Values - NOT in git!)

```bash
# Copy from .env.example and fill in real values
SECRET_KEY=my-actual-secret-key-here
DATABASE_URL=postgresql://postgres:mypassword@localhost:5432/flaskwithpsql
```

### .gitignore Entry

```
# Never commit actual .env file
.env
!.env.example
```

---

## Environment Variable Categories

### 1. Flask Configuration

```bash
# Application mode
FLASK_ENV=development|testing|production
FLASK_DEBUG=1|0
FLASK_APP=run.py
FLASK_PORT=5500

# Security
SECRET_KEY=your-secret-key-here  # Used for JWT, sessions
```

### 2. Database Configuration

```bash
# Option 1: Connection string
DATABASE_URL=postgresql://user:pass@host:port/dbname

# Option 2: Individual components
DB_USER=postgres
DB_PASSWORD=your_password
DB_HOST=localhost
DB_PORT=5432
DB_NAME=flaskwithpsql
```

### 3. JWT Configuration

```bash
JWT_SECRET_KEY=your-jwt-secret
JWT_ACCESS_TOKEN_EXPIRES=3600      # 1 hour in seconds
JWT_REFRESH_TOKEN_EXPIRES=2592000  # 30 days in seconds
```

### 4. CORS Configuration

```bash
CORS_ORIGINS=http://localhost:3000,http://localhost:3001
CORS_METHODS=GET,POST,PUT,DELETE,OPTIONS
CORS_ALLOW_HEADERS=Content-Type,Authorization
```

### 5. External Services

```bash
# Redis (rate limiting)
RATELIMIT_STORAGE_URL=redis://localhost:6379

# Email (if needed)
MAIL_SERVER=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=your-email@gmail.com
MAIL_PASSWORD=app-specific-password
```

---

## Configuration in Flask

### config.py Structure

```python
import os
from datetime import timedelta

class Config:
    """Base configuration."""
    SECRET_KEY = os.environ.get("SECRET_KEY", "dev-secret-key")

    # Database
    SQLALCHEMY_DATABASE_URI = os.environ.get("DATABASE_URL")
    SQLALCHEMY_TRACK_MODIFICATIONS = False

    # JWT
    JWT_SECRET_KEY = os.environ.get("JWT_SECRET_KEY", SECRET_KEY)
    JWT_ACCESS_TOKEN_EXPIRES = timedelta(
        seconds=int(os.environ.get("JWT_ACCESS_TOKEN_EXPIRES", 3600))
    )


class DevelopmentConfig(Config):
    """Development configuration."""
    DEBUG = True
    SQLALCHEMY_ECHO = True  # Log SQL queries


class ProductionConfig(Config):
    """Production configuration."""
    DEBUG = False

    # Stricter security
    SESSION_COOKIE_SECURE = True
    SESSION_COOKIE_HTTPONLY = True


class TestingConfig(Config):
    """Testing configuration."""
    TESTING = True
    SQLALCHEMY_DATABASE_URI = os.environ.get(
        "TEST_DATABASE_URL",
        "sqlite:///:memory:"
    )


config = {
    "development": DevelopmentConfig,
    "production": ProductionConfig,
    "testing": TestingConfig,
    "default": DevelopmentConfig,
}
```

### Loading Configuration

```python
# app/__init__.py

from config import config

def create_app(config_name=None):
    if config_name is None:
        config_name = os.environ.get("FLASK_ENV", "development")

    app = Flask(__name__)
    app.config.from_object(config[config_name])

    return app
```

### Accessing Environment Variables

```python
import os

# Method 1: Direct access (may be None)
value = os.environ.get("KEY")

# Method 2: With default
value = os.environ.get("KEY", "default_value")

# Method 3: Required (raises error if missing)
value = os.environ["KEY"]  # KeyError if not set

# Method 4: Via Flask config
from flask import current_app
value = current_app.config["KEY"]
```

---

## Best Practices

### DO ✅

```python
# ✅ Use environment variables for secrets
SECRET_KEY = os.environ.get("SECRET_KEY")

# ✅ Provide sensible defaults for development
DEBUG = os.environ.get("DEBUG", "true" if development else "false")

# ✅ Validate required variables at startup
def validate_config():
    required = ["SECRET_KEY", "DATABASE_URL"]
    missing = [var for var in required if not os.environ.get(var)]
    if missing:
        raise RuntimeError(f"Missing required env vars: {missing}")

# ✅ Type-convert as needed
PORT = int(os.environ.get("PORT", 5500))
DEBUG = os.environ.get("DEBUG", "false").lower() == "true"

# ✅ Use .env.example as documentation
```

### DON'T ❌

```python
# ❌ Never hardcode secrets
SECRET_KEY = "super-secret-key"  # In source code!

# ❌ Never commit .env files
# (should be in .gitignore)

# ❌ Never log secrets
logger.info(f"Connecting with password: {DB_PASSWORD}")  # BAD!

# ❌ Don't use same secrets across environments
# Development and production should have different values
```

---

## Environment-Specific Config

### Development

```bash
# .env (local development)
FLASK_ENV=development
FLASK_DEBUG=1
SECRET_KEY=dev-secret-key-not-secure
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/flaskwithpsql
```

### Docker Development

```yaml
# docker-compose.yml
services:
    web:
        environment:
            - FLASK_ENV=development
            - FLASK_DEBUG=1
            - DATABASE_URL=postgresql://postgres:postgres@db:5432/flaskwithpsql
            - SECRET_KEY=docker-dev-secret
```

### GitHub Actions (CI)

```yaml
# .github/workflows/ci.yml
jobs:
    test:
        env:
            FLASK_ENV: testing
            SECRET_KEY: test-secret-key
            DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
```

### Production

```bash
# Set via hosting platform (Heroku, AWS, etc.)
FLASK_ENV=production
FLASK_DEBUG=0
SECRET_KEY=<random-64-character-string>
DATABASE_URL=postgresql://user:pass@prod-db.example.com:5432/app_prod

# Generate secure secret:
python -c "import secrets; print(secrets.token_hex(32))"
```

### Kubernetes/Docker Secrets

```yaml
# kubernetes secret
apiVersion: v1
kind: Secret
metadata:
    name: app-secrets
type: Opaque
stringData:
    SECRET_KEY: "your-production-secret"
    DATABASE_URL: "postgresql://..."
```

---

## Loading .env Files

### Using python-dotenv

```python
# Automatically loads .env in development
from dotenv import load_dotenv
load_dotenv()

# Now os.environ has values from .env
```

### Flask's Built-in Support

Flask automatically loads `.env` and `.flaskenv` files if `python-dotenv` is installed:

```bash
pip install python-dotenv
```

Priority: Environment variables > `.env` > `.flaskenv`

---

## Summary

### Environment Variable Checklist

-   [ ] `.env.example` committed with dummy values
-   [ ] `.env` in `.gitignore`
-   [ ] All secrets from environment variables, not code
-   [ ] Different values for dev/staging/prod
-   [ ] Required variables validated at startup
-   [ ] Secure secrets in production (random, long)

### Quick Reference

| Environment | How to Set                       |
| ----------- | -------------------------------- |
| Local       | `.env` file                      |
| Docker      | `docker-compose.yml` environment |
| CI          | GitHub Actions secrets/env       |
| Production  | Hosting platform's config        |

---

## Next Steps

-   **[7.8 Production Deployment](./7.8_production_deployment.md)** - Deployment considerations
-   **[7.1 DevOps Overview](./7.1_devops_overview.md)** - Full DevOps stack

---

> **Related Documentation:**
>
> -   [.env.example](../../.env.example)
> -   [config.py](../../config.py)
