# 7.8 Pre-commit Cross-Platform Setup

This document explains how we handle cross-platform pre-commit hook setup and the solutions implemented to ensure hooks work on all operating systems.

---

## ğŸ“‹ Table of Contents

1. [The Problem](#the-problem)
2. [Root Cause Analysis](#root-cause-analysis)
3. [Solution Overview](#solution-overview)
4. [Implementation Details](#implementation-details)
5. [Usage Guide](#usage-guide)
6. [Troubleshooting](#troubleshooting)

---

## The Problem

When a Windows developer cloned the repository and tried to commit, the following issues occurred:

1. **Pre-commit hooks didn't run** - Commits went through without any code quality checks
2. **Could commit to main branch** - The `no-commit-to-branch` hook didn't block the commit
3. **Invalid commit messages accepted** - Commit messages not following conventional commits format were allowed

---

## Root Cause Analysis

### Issue 1: Bash-Only Hook Scripts

The default hooks generated by `pre-commit install` use a bash shebang:

```bash
#!/usr/bin/env bash
```

**Problem**: Windows Command Prompt and PowerShell don't interpret bash scripts natively.

**What happens**:

-   On Mac/Linux: Hook runs correctly
-   On Windows CMD: Hook silently fails or doesn't execute
-   On Windows PowerShell: Same issue

### Issue 2: Hardcoded Platform-Specific Paths

The hook files contain hardcoded paths to the Python interpreter:

```bash
INSTALL_PYTHON=/Users/tejasnirala/Learning/flaskwithpsql/venv/bin/python3
```

**Problem**: This Mac-specific path doesn't exist on Windows.

**What happens**:

-   The `if [ -x "$INSTALL_PYTHON" ]` check fails
-   Falls through to `elif command -v pre-commit`
-   If `pre-commit` isn't in system PATH, hook fails silently

### Issue 3: Git Hooks Are Not Version Controlled

The `.git/hooks/` directory is local only and not tracked by Git.

**Problem**: When a developer clones the repo, they don't get any hooks.

**What happens**:

-   Fresh clone has no hooks installed
-   Developer must explicitly run `pre-commit install`
-   If they don't know this, commits bypass all checks

### Issue 4: Missing Commit-Message Hook Type

Even developers who run `pre-commit install` often miss installing the commit-msg hook:

```bash
# Developers run this:
pre-commit install

# But forget this:
pre-commit install --hook-type commit-msg
```

**Result**: Code quality hooks run, but commit message validation is skipped.

---

## Solution Overview

We implemented a multi-layered solution:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Solution Architecture                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 1: Cross-Platform Setup Script                       â”‚
â”‚  scripts/setup_hooks.py                                      â”‚
â”‚  - Pure Python (works everywhere)                           â”‚
â”‚  - Installs both hook types                                 â”‚
â”‚  - Verifies installation                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 2: CI Safety Net                                      â”‚
â”‚  .github/workflows/commit-lint.yml                          â”‚
â”‚  - Validates commits in CI                                  â”‚
â”‚  - Catches issues if local hooks failed                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 3: Documentation                                      â”‚
â”‚  docs/WINDOWS_SETUP_GUIDE.md                                â”‚
â”‚  docs/PRE_COMMIT_CROSS_PLATFORM.md                          â”‚
â”‚  - Clear instructions for all platforms                     â”‚
â”‚  - Troubleshooting guides                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Implementation Details

### 1. Cross-Platform Setup Script

**File**: `scripts/setup_hooks.py`

This Python script:

-   Works on Windows, macOS, and Linux
-   Uses `sys.executable` to find the correct Python interpreter
-   Installs both `pre-commit` and `commit-msg` hook types
-   Pre-installs hook environments for faster first commit
-   Verifies installation by checking for hook files
-   Runs a test to ensure hooks are functional

**Key Code Flow**:

```
main()
  â”‚
  â”œâ”€â¤ check_pre_commit_installed()
  â”‚     Uses subprocess to run: python -m pre_commit --version
  â”‚     Returns True if pre-commit is available
  â”‚
  â”œâ”€â¤ install_pre_commit() (if not installed)
  â”‚     Runs: python -m pip install pre-commit
  â”‚
  â”œâ”€â¤ install_hooks()
  â”‚     Runs: python -m pre_commit install --hook-type pre-commit
  â”‚     Runs: python -m pre_commit install --hook-type commit-msg
  â”‚
  â”œâ”€â¤ install_hook_environments()
  â”‚     Runs: python -m pre_commit install-hooks
  â”‚     Pre-downloads hook dependencies
  â”‚
  â”œâ”€â¤ verify_hooks()
  â”‚     Checks .git/hooks/pre-commit exists
  â”‚     Checks .git/hooks/commit-msg exists
  â”‚
  â””â”€â¤ run_test()
        Runs: python -m pre_commit run --all-files
        Verifies hooks are functional
```

### 2. CI Commit Validation

**File**: `.github/workflows/commit-lint.yml`

This GitHub Action:

-   Runs on every push and PR to main/develop
-   Uses `wagoid/commitlint-github-action` to validate commits
-   References `.commitlintrc.json` for configuration
-   Acts as a safety net when local hooks fail

**Configuration File**: `.commitlintrc.json`

```json
{
    "extends": ["@commitlint/config-conventional"],
    "rules": {
        "type-enum": [
            2,
            "always",
            [
                "feat",
                "fix",
                "docs",
                "style",
                "refactor",
                "perf",
                "test",
                "build",
                "ci",
                "chore",
                "revert"
            ]
        ],
        "type-case": [2, "always", "lower-case"],
        "subject-empty": [2, "never"],
        "header-max-length": [2, "always", 100]
    }
}
```

### 3. Updated Documentation

**Updated Files**:

-   `docs/WINDOWS_SETUP_GUIDE.md` - Added complete hook installation instructions
-   Created `docs/PRE_COMMIT_CROSS_PLATFORM.md` - Detailed troubleshooting

**Key Changes**:

-   Changed Step 10 from "Optional" to "IMPORTANT"
-   Added both hook type installations
-   Added setup script option
-   Added Windows-specific troubleshooting for hooks

---

## Usage Guide

### For New Developers

After cloning the repository:

```bash
# 1. Create and activate virtual environment
python -m venv venv
source venv/bin/activate  # Mac/Linux
venv\Scripts\activate     # Windows

# 2. Install dependencies
pip install -r requirements.txt

# 3. Set up git hooks (IMPORTANT!)
python scripts/setup_hooks.py
```

### For Existing Developers

If hooks aren't working:

```bash
# Regenerate hooks
python scripts/setup_hooks.py
```

### Using Makefile

```bash
# Full dev setup (includes hooks)
make install-dev

# Just hooks
make setup-hooks
```

---

## Troubleshooting

### Hooks Not Running

**Check 1**: Verify hooks exist

```bash
ls -la .git/hooks/pre-commit
ls -la .git/hooks/commit-msg
```

**Check 2**: Verify pre-commit is installed

```bash
pre-commit --version
```

**Fix**: Run the setup script

```bash
python scripts/setup_hooks.py
```

### Windows: Bash Not Found

**Symptom**: Error about `/usr/bin/env: 'bash': No such file or directory`

**Fixes**:

1. Use Git Bash terminal instead of CMD/PowerShell
2. Add Git's bin to PATH: `C:\Program Files\Git\bin`
3. Run git commands from within Git Bash

### Can Commit to Main

**Symptom**: `no-commit-to-branch` hook not blocking

**Check**: Verify hooks are installed and running

```bash
pre-commit run no-commit-to-branch
# Should fail with message about committing to main
```

### Commit Message Not Validated

**Symptom**: Invalid messages like "fixed stuff" accepted

**Fix**: Install commit-msg hook type

```bash
pre-commit install --hook-type commit-msg
```

---

## Data Flow Diagram

```
Developer makes a commit
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   git commit -m     â”‚
â”‚   "my message"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ .git/hooks/pre-commitâ”‚ â—€â”€â”€ Hook 1: Pre-commit
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€ Check formatting (Black)
         â”œâ”€â”€ Check imports (isort)
         â”œâ”€â”€ Lint code (Flake8)
         â”œâ”€â”€ Type check (MyPy)
         â”œâ”€â”€ Security scan (Bandit)
         â””â”€â”€ Branch check (no-commit-to-branch)
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ All Pass?  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚       â”‚
     Yes      No
      â”‚       â”‚
      â–¼       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Continueâ”‚  â”‚ Abort Commitâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ Fix Issues  â”‚
      â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ .git/hooks/commit-msgâ”‚ â—€â”€â”€ Hook 2: Commit-msg
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â””â”€â”€ Validate conventional commit format
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Valid Msg? â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚       â”‚
     Yes      No
      â”‚       â”‚
      â–¼       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Commit  â”‚  â”‚ Abort Commitâ”‚
â”‚ Success â”‚  â”‚ Fix Message â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Files Created/Modified

| File                                | Purpose                          |
| ----------------------------------- | -------------------------------- |
| `scripts/setup_hooks.py`            | Cross-platform hook setup script |
| `.github/workflows/commit-lint.yml` | CI commit validation             |
| `.commitlintrc.json`                | Commitlint configuration         |
| `docs/WINDOWS_SETUP_GUIDE.md`       | Updated with hook instructions   |
| `docs/PRE_COMMIT_CROSS_PLATFORM.md` | Detailed troubleshooting         |
| `Makefile`                          | Added `setup-hooks` target       |

---

## References

-   [Pre-commit Documentation](https://pre-commit.com/)
-   [Conventional Commits](https://www.conventionalcommits.org/)
-   [Commitlint](https://commitlint.js.org/)
-   [PEP 668 - Externally Managed Environments](https://peps.python.org/pep-0668/)
