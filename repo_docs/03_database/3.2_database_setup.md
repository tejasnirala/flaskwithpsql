# âš™ï¸ Database Setup

> **Configuring Flask-SQLAlchemy**

---

## ğŸ“‹ Overview

This document explains how we configure Flask-SQLAlchemy to connect to PostgreSQL.

---

## ğŸ”§ Configuration in config.py

```python
# config.py

def _build_database_uri() -> str:
    """
    Build database URI from environment variables.

    Supports both direct DATABASE_URL or individual components.
    """
    # Check for direct DATABASE_URL first (common in production/Heroku)
    database_url = os.environ.get("DATABASE_URL")
    if database_url:
        # Handle Heroku-style postgres:// URLs
        if database_url.startswith("postgres://"):
            database_url = database_url.replace("postgres://", "postgresql://", 1)
        return database_url

    # Build from individual components (development)
    db_user = os.environ.get("DB_USER", "postgres")
    db_password = os.environ.get("DB_PASSWORD", "")
    db_host = os.environ.get("DB_HOST", "localhost")
    db_port = os.environ.get("DB_PORT", "5432")
    db_name = os.environ.get("DB_NAME", "flaskwithpsql")

    return f"postgresql://{db_user}:{db_password}@{db_host}:{db_port}/{db_name}"


class Config:
    # SQLAlchemy settings
    SQLALCHEMY_DATABASE_URI = _build_database_uri()
    SQLALCHEMY_TRACK_MODIFICATIONS = False  # Disable event system (saves memory)
    SQLALCHEMY_ECHO = False  # Don't log SQL queries by default

    # Connection pool settings
    SQLALCHEMY_ENGINE_OPTIONS = {
        "pool_pre_ping": True,   # Verify connections before using
        "pool_recycle": 300,     # Recycle connections after 5 minutes
    }
```

---

## ğŸ“Š Database URI Format

```
postgresql://username:password@host:port/database_name
```

### Examples

```python
# Local development (no password)
"postgresql://postgres@localhost:5432/flaskwithpsql"

# Local development (with password)
"postgresql://postgres:mypassword@localhost:5432/flaskwithpsql"

# Docker Compose
"postgresql://postgres:postgres@db:5432/flaskwithpsql"

# Production (Heroku-style)
"postgresql://user:pass@ec2-xx-xx-xx-xx.compute.amazonaws.com:5432/dbname"
```

---

## ğŸ”„ Environment Variables

### .env File

```env
# Database Configuration
DB_HOST=localhost
DB_PORT=5432
DB_NAME=flaskwithpsql
DB_USER=postgres
DB_PASSWORD=your_password

# OR use a single DATABASE_URL (production)
# DATABASE_URL=postgresql://user:pass@host:5432/dbname
```

### Loading Environment Variables

```python
# config.py
from dotenv import load_dotenv

# Load .env file at module import
load_dotenv()

# Now os.environ.get() will include .env values
```

---

## ğŸ—ï¸ Initialization in App Factory

```python
# app/__init__.py

from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

# Create extensions WITHOUT app (at module level)
db = SQLAlchemy()
migrate = Migrate()

def create_app(config_name="default"):
    app = OpenAPI(__name__, info=info)

    # Load configuration
    app.config.from_object(config[config_name])

    # Initialize extensions WITH app
    db.init_app(app)
    migrate.init_app(app, db)

    return app
```

---

## ğŸ“Š Configuration Options Explained

### SQLALCHEMY_DATABASE_URI

The connection string to your database.

```python
SQLALCHEMY_DATABASE_URI = "postgresql://user:pass@host:5432/dbname"
```

### SQLALCHEMY_TRACK_MODIFICATIONS

Whether to track modifications to objects. **Always set to False** unless you need it.

```python
SQLALCHEMY_TRACK_MODIFICATIONS = False  # Saves memory, improves performance
```

### SQLALCHEMY_ECHO

Log all SQL statements. Useful for debugging.

```python
# Development
SQLALCHEMY_ECHO = True  # See all SQL queries

# Production
SQLALCHEMY_ECHO = False  # Don't clutter logs
```

### SQLALCHEMY_ENGINE_OPTIONS

Advanced configuration for the database engine.

```python
SQLALCHEMY_ENGINE_OPTIONS = {
    # Verify connection is alive before using
    "pool_pre_ping": True,

    # Recycle connections after N seconds (prevents stale connections)
    "pool_recycle": 300,

    # Number of connections to keep in the pool (production)
    "pool_size": 10,

    # Allow this many extra connections under load
    "max_overflow": 20,
}
```

---

## ğŸ”„ Connection Pooling

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CONNECTION POOLING                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Without Pooling:                                               â”‚
â”‚   Request 1 â†’ Connect â†’ Query â†’ Disconnect                      â”‚
â”‚   Request 2 â†’ Connect â†’ Query â†’ Disconnect  (slow!)             â”‚
â”‚   Request 3 â†’ Connect â†’ Query â†’ Disconnect                      â”‚
â”‚                                                                  â”‚
â”‚   With Pooling:                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚   â”‚           Connection Pool               â”‚                    â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”        â”‚                    â”‚
â”‚   â”‚   â”‚ 1 â”‚ â”‚ 2 â”‚ â”‚ 3 â”‚ â”‚ 4 â”‚ â”‚ 5 â”‚        â”‚                    â”‚
â”‚   â”‚   â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜        â”‚                    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                  â”‚
â”‚   Request 1 â†’ Borrow conn 1 â†’ Query â†’ Return to pool            â”‚
â”‚   Request 2 â†’ Borrow conn 2 â†’ Query â†’ Return to pool            â”‚
â”‚   Request 3 â†’ Borrow conn 1 â†’ Query â†’ Return to pool (reused!)  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª Testing Configuration

```python
# config.py

class TestingConfig(Config):
    TESTING = True

    # Use separate test database
    SQLALCHEMY_DATABASE_URI = os.environ.get(
        "TEST_DATABASE_URL",
        "postgresql://postgres:postgres@localhost:5432/flaskwithpsql_test"
    )
```

---

## âš ï¸ Common Issues

### Issue 1: Connection Refused

```
sqlalchemy.exc.OperationalError: connection refused
```

**Solution:** Check that PostgreSQL is running:

```bash
# macOS
brew services start postgresql

# Linux
sudo systemctl start postgresql

# Check if running
pg_isready
```

### Issue 2: Authentication Failed

```
FATAL: password authentication failed for user "postgres"
```

**Solution:** Check your password in `.env` file matches PostgreSQL.

### Issue 3: Database Does Not Exist

```
FATAL: database "flaskwithpsql" does not exist
```

**Solution:** Create the database:

```bash
createdb flaskwithpsql
```

---

## ğŸ†š Express.js Comparison

**Express with Prisma:**

```javascript
// prisma/schema.prisma
datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// Usage
const prisma = new PrismaClient();
```

**Flask with SQLAlchemy:**

```python
# config.py
SQLALCHEMY_DATABASE_URI = os.environ.get("DATABASE_URL")

# app/__init__.py
db = SQLAlchemy()
db.init_app(app)
```

Same concept, different syntax!

---

## ğŸ”œ Next Steps

Now that the database is configured, let's learn how to define models.

**Next: [3.3_models_explained.md](./3.3_models_explained.md)** - Defining database models.
