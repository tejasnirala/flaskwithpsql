# ğŸ” Querying Data

> **CRUD Operations with SQLAlchemy**

---

## ğŸ“‹ Overview

This document covers all the ways to Create, Read, Update, and Delete data using SQLAlchemy.

---

## ğŸ†š Comparison with Node.js ORMs

| Operation | Mongoose             | Prisma                      | SQLAlchemy               |
| --------- | -------------------- | --------------------------- | ------------------------ |
| Get all   | `Model.find()`       | `prisma.model.findMany()`   | `Model.query.all()`      |
| Get by ID | `Model.findById(id)` | `prisma.model.findUnique()` | `Model.query.get(id)`    |
| Find one  | `Model.findOne()`    | `prisma.model.findFirst()`  | `.filter().first()`      |
| Filter    | `Model.find({...})`  | `findMany({where:...})`     | `.filter_by()/.filter()` |
| Create    | `Model.create()`     | `prisma.model.create()`     | `db.session.add()`       |
| Update    | `doc.save()`         | `prisma.model.update()`     | `db.session.commit()`    |
| Delete    | `doc.remove()`       | `prisma.model.delete()`     | `db.session.delete()`    |

---

## ğŸ“– READ Operations

### Get All Records

```python
# Get all users
users = User.query.all()  # Returns list

# Same as:
users = db.session.query(User).all()
```

### Get by Primary Key

```python
# Get user by ID
user = User.query.get(1)  # Returns User or None

# SQLAlchemy 2.0 style (recommended):
user = db.session.get(User, 1)
```

### Filter by Column Value

```python
# Filter by exact match (simple)
active_users = User.query.filter_by(is_active=True).all()
admin = User.query.filter_by(username="admin").first()

# Multiple conditions
user = User.query.filter_by(
    email="john@example.com",
    is_active=True
).first()
```

### Filter with Expressions

```python
# More complex filters using .filter()
from sqlalchemy import and_, or_, not_

# Equal
User.query.filter(User.username == "john").first()

# Not equal
User.query.filter(User.username != "john").all()

# Greater than / Less than
User.query.filter(User.id > 10).all()
User.query.filter(User.id <= 100).all()

# IN
User.query.filter(User.id.in_([1, 2, 3])).all()

# NOT IN
User.query.filter(~User.id.in_([1, 2, 3])).all()

# LIKE (case-sensitive)
User.query.filter(User.username.like("%john%")).all()

# ILIKE (case-insensitive, PostgreSQL)
User.query.filter(User.username.ilike("%john%")).all()

# IS NULL / IS NOT NULL
User.query.filter(User.bio.is_(None)).all()
User.query.filter(User.bio.isnot(None)).all()

# AND
User.query.filter(
    and_(User.is_active == True, User.is_deleted == False)
).all()

# OR
User.query.filter(
    or_(User.username == "john", User.email == "john@example.com")
).all()
```

### Get First or 404

```python
from flask import abort

# Manual way
user = User.query.get(1)
if user is None:
    abort(404)

# Flask-SQLAlchemy shortcut
user = User.query.get_or_404(1)  # Raises 404 if not found
user = User.query.filter_by(username="john").first_or_404()
```

### Ordering

```python
# Order by column
users = User.query.order_by(User.username).all()  # Ascending
users = User.query.order_by(User.username.desc()).all()  # Descending

# Multiple order
users = User.query.order_by(
    User.is_active.desc(),
    User.username
).all()
```

### Pagination

```python
# Get page of results
page = User.query.paginate(page=1, per_page=10)

# Access pagination data
page.items      # List of items on current page
page.total      # Total number of items
page.pages      # Total number of pages
page.page       # Current page number
page.has_next   # True if there's a next page
page.has_prev   # True if there's a previous page
page.next_num   # Next page number
page.prev_num   # Previous page number
```

### Counting

```python
# Count all
total = User.query.count()

# Count with filter
active_count = User.query.filter_by(is_active=True).count()
```

### Selecting Specific Columns

```python
# Only select specific columns (returns tuples)
results = db.session.query(User.id, User.username).all()
# [(1, 'john'), (2, 'jane'), ...]

# With filter
usernames = db.session.query(User.username).filter_by(is_active=True).all()
```

---

## âœï¸ CREATE Operations

### Create Single Record

```python
# Create new user
new_user = User(
    username="john_doe",
    email="john@example.com",
    first_name="John",
)
new_user.set_password("SecurePass123!")

# Add to session
db.session.add(new_user)

# Commit to database
db.session.commit()

# Now new_user.id is set!
print(new_user.id)  # e.g., 1
```

### Create Multiple Records

```python
# Create multiple users
users = [
    User(username="user1", email="user1@example.com", first_name="User 1"),
    User(username="user2", email="user2@example.com", first_name="User 2"),
    User(username="user3", email="user3@example.com", first_name="User 3"),
]

# Add all
db.session.add_all(users)
db.session.commit()
```

### Handling Duplicates

```python
from sqlalchemy.exc import IntegrityError

try:
    new_user = User(username="existing_user", ...)
    db.session.add(new_user)
    db.session.commit()
except IntegrityError:
    db.session.rollback()
    raise ValueError("Username already exists")
```

---

## ğŸ”„ UPDATE Operations

### Update Single Record

```python
# Get the user
user = User.query.get(1)

# Modify attributes
user.first_name = "Updated Name"
user.bio = "New bio"

# Commit changes
db.session.commit()

# updated_at is automatically updated (if using BaseModel)
```

### Bulk Update

```python
# Update multiple records at once
User.query.filter_by(is_active=False).update({
    "is_deleted": True
})
db.session.commit()

# With more complex conditions
User.query.filter(User.id.in_([1, 2, 3])).update(
    {"is_active": False},
    synchronize_session="fetch"  # or "evaluate"
)
db.session.commit()
```

---

## ğŸ—‘ï¸ DELETE Operations

### Soft Delete (Recommended)

```python
# Using our BaseModel method
user = User.query.get(1)
user.soft_delete()  # Sets is_deleted = True
db.session.commit()

# Query only non-deleted users
active_users = User.query.filter_by(is_deleted=False).all()
```

### Hard Delete

```python
# Permanently remove from database
user = User.query.get(1)
db.session.delete(user)
db.session.commit()
```

### Bulk Delete

```python
# Delete multiple records
User.query.filter_by(is_deleted=True).delete()
db.session.commit()
```

---

## ğŸ“Š Query Chaining

SQLAlchemy queries can be chained:

```python
users = (
    User.query
    .filter_by(is_active=True)
    .filter_by(is_deleted=False)
    .filter(User.created_at > some_date)
    .order_by(User.username)
    .limit(10)
    .offset(0)
    .all()
)
```

---

## ğŸ”„ Transactions

### Automatic Transaction

```python
# Each commit is a transaction
user = User(username="test")
db.session.add(user)
db.session.commit()  # Transaction committed
```

### Manual Transaction Control

```python
# Multiple operations in one transaction
try:
    user1 = User(username="user1", ...)
    user2 = User(username="user2", ...)

    db.session.add(user1)
    db.session.add(user2)

    # Both or neither
    db.session.commit()
except Exception:
    db.session.rollback()
    raise
```

### Using Context Manager (Cleaner)

```python
from contextlib import contextmanager

@contextmanager
def transaction():
    try:
        yield
        db.session.commit()
    except Exception:
        db.session.rollback()
        raise

# Usage
with transaction():
    user = User(...)
    db.session.add(user)
    # Auto-commits or rolls back
```

---

## ğŸ“Š Query Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SQLALCHEMY QUERY FLOW                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   User.query                    â† Start with model               â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   .filter_by(is_active=True)    â† Add filters                    â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   .filter(User.id > 10)         â† More complex filters           â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   .order_by(User.username)      â† Ordering                       â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   .limit(10)                    â† Limit results                  â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   Terminal Methods:                                              â”‚
â”‚   â”œâ”€â”€ .all()      â†’ List[User]  (all results)                    â”‚
â”‚   â”œâ”€â”€ .first()    â†’ User | None (first result)                   â”‚
â”‚   â”œâ”€â”€ .one()      â†’ User        (exactly one, or error)          â”‚
â”‚   â”œâ”€â”€ .count()    â†’ int         (count results)                  â”‚
â”‚   â””â”€â”€ .paginate() â†’ Pagination  (paginated results)              â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš ï¸ Common Mistakes

### Mistake 1: Forgetting to Commit

```python
# âŒ BAD - Changes not saved!
user.first_name = "New Name"
# Forgot db.session.commit()

# âœ… GOOD
user.first_name = "New Name"
db.session.commit()
```

### Mistake 2: Using get() with Wrong Type

```python
# âŒ BAD - String ID when Integer expected
user = User.query.get("1")  # Might not work!

# âœ… GOOD - Correct type
user = User.query.get(1)
user = User.query.get(int(id))
```

### Mistake 3: Not Handling None

```python
# âŒ BAD - Might crash
user = User.query.get(999)
print(user.username)  # AttributeError if user is None!

# âœ… GOOD - Check for None
user = User.query.get(999)
if user:
    print(user.username)

# Or use get_or_404
user = User.query.get_or_404(999)
```

---

## ğŸ”œ Next Steps

Now let's understand database migrations.

**Next: [3.8_migrations_overview.md](./3.8_migrations_overview.md)** - What migrations are and why we need them.
