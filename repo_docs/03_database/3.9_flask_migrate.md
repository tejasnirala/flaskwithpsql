# üîÑ Flask-Migrate

> **Managing Migrations with Flask-Migrate**

---

## üìã What is Flask-Migrate?

Flask-Migrate is a Flask extension that wraps **Alembic**, the migration tool for SQLAlchemy. It provides Flask CLI commands for managing database migrations.

---

## üîß Setup

### Installation

```bash
pip install Flask-Migrate
```

### Initialization in App Factory

```python
# app/__init__.py
from flask_migrate import Migrate

db = SQLAlchemy()
migrate = Migrate()

def create_app(config_name="default"):
    app = Flask(__name__)

    db.init_app(app)
    migrate.init_app(app, db)  # Requires both app AND db

    return app
```

---

## üìã Command Reference

### Initialize Migrations Folder

```bash
flask db init
```

Creates the `migrations/` directory. **Only run once per project.**

### Generate a Migration

```bash
flask db migrate -m "Description of changes"
```

Compares your models to the database and generates a migration file.

### Apply Migrations

```bash
flask db upgrade
```

Applies all pending migrations to the database.

### Rollback Last Migration

```bash
flask db downgrade
```

Reverts the most recent migration.

### Show Migration History

```bash
flask db history
```

Shows all migrations and their order.

### Show Current Migration

```bash
flask db current
```

Shows which migration the database is currently at.

---

## üìä Command Workflow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   FLASK-MIGRATE COMMANDS                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ   FIRST TIME SETUP:                                              ‚îÇ
‚îÇ   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                              ‚îÇ
‚îÇ   $ flask db init           # Create migrations folder           ‚îÇ
‚îÇ   $ flask db migrate -m "Initial"  # Generate first migration    ‚îÇ
‚îÇ   $ flask db upgrade        # Apply to database                  ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ   ONGOING DEVELOPMENT:                                           ‚îÇ
‚îÇ   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                           ‚îÇ
‚îÇ   1. Edit your models (add column, new table, etc.)              ‚îÇ
‚îÇ   2. $ flask db migrate -m "Add feature X"                       ‚îÇ
‚îÇ   3. Review the generated migration file                         ‚îÇ
‚îÇ   4. $ flask db upgrade                                          ‚îÇ
‚îÇ   5. Commit migration file to Git                                ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ   ROLLBACK IF NEEDED:                                            ‚îÇ
‚îÇ   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                            ‚îÇ
‚îÇ   $ flask db downgrade      # Go back one step                   ‚îÇ
‚îÇ   $ flask db downgrade base # Go back to beginning               ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ   DEBUGGING:                                                     ‚îÇ
‚îÇ   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                                     ‚îÇ
‚îÇ   $ flask db current        # Where are we?                      ‚îÇ
‚îÇ   $ flask db history        # Show all migrations                ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üõ†Ô∏è Practical Examples

### Example 1: Adding a New Column

```python
# 1. Edit the model
class User(BaseModel):
    # ... existing fields ...
    phone = Column(String(20), nullable=True)  # NEW!
```

```bash
# 2. Generate migration
$ flask db migrate -m "Add phone column to users"

# Output:
# INFO  Generating migration script
# migrations/versions/abc123_add_phone_column_to_users.py

# 3. Apply migration
$ flask db upgrade

# Output:
# INFO  Running upgrade xyz789 -> abc123, Add phone column to users
```

### Example 2: Adding a New Table

```python
# 1. Create new model
# app/models/post.py
class Post(BaseModel):
    __tablename__ = "posts"

    title = Column(String(200), nullable=False)
    content = Column(Text)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
```

```python
# 2. Import in __init__.py
# app/models/__init__.py
from app.models.user import User
from app.models.post import Post  # NEW!
```

```bash
# 3. Generate and apply
$ flask db migrate -m "Add posts table"
$ flask db upgrade
```

### Example 3: Rolling Back

```bash
# Made a mistake? Roll back
$ flask db downgrade

# Back to specific revision
$ flask db downgrade abc123

# Back to the beginning
$ flask db downgrade base
```

---

## üìÅ Generated Migration File

When you run `flask db migrate`, it creates a file like this:

```python
# migrations/versions/abc123_add_phone_column.py
"""Add phone column to users

Revision ID: abc123
Revises: xyz789
Create Date: 2025-01-13 10:30:00.000000

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers
revision = 'abc123'
down_revision = 'xyz789'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic ###
    op.add_column('users', sa.Column('phone', sa.String(length=20), nullable=True))
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic ###
    op.drop_column('users', 'phone')
    # ### end Alembic commands ###
```

---

## ‚ö†Ô∏è Common Issues and Solutions

### Issue 1: "Can't find command 'db'"

```bash
$ flask db init
# Error: No such command 'db'
```

**Solution:** Make sure Flask-Migrate is installed and `migrate.init_app(app, db)` is called.

### Issue 2: "Target database is not up to date"

```bash
$ flask db migrate
# ERROR: Target database is not up to date
```

**Solution:** Run `flask db upgrade` to apply pending migrations first.

### Issue 3: Empty Migration Generated

```bash
$ flask db migrate
# INFO: No changes in schema detected
```

**Causes:**

-   Models not imported (not registered with SQLAlchemy)
-   Changes already in database
-   Circular import preventing model load

**Solution:** Make sure models are imported in `app/models/__init__.py`:

```python
# app/models/__init__.py
from app.models.user import User
from app.models.post import Post  # Don't forget new models!
```

### Issue 4: Schema Not Found

When using PostgreSQL schemas:

```python
# In migration file, add schema creation
def upgrade():
    op.execute('CREATE SCHEMA IF NOT EXISTS users')
    # Then create tables...
```

Or use our `db_manage.py` script which handles this automatically.

---

## üÜö Multiple Environments

### Development

```bash
# .env
FLASK_ENV=development
DATABASE_URL=postgresql://localhost/myapp_dev

# Run migrations
flask db upgrade
```

### Testing

```bash
# Uses testing config automatically
pytest  # Migrations applied in fixtures
```

### Production

```bash
# In deployment script
FLASK_ENV=production flask db upgrade
```

---

## üìä Migration Status Table

Flask-Migrate keeps track of migrations in a table called `alembic_version`:

```sql
SELECT * FROM alembic_version;

-- Result:
-- version_num
-- ------------
-- abc123
```

This single row shows the current migration applied.

---

## üîß Advanced Commands

### Show SQL Without Executing

```bash
flask db upgrade --sql
```

Shows what SQL would be executed without running it.

### Upgrade to Specific Revision

```bash
flask db upgrade abc123
```

### Mark Database Without Running Migration

```bash
flask db stamp head
```

Marks database as up-to-date without running migrations. Useful for initial production setup.

---

## üîú Next Steps

Now let's look at our custom database management script.

**Next: [3.10_db_manage_script.md](./3.10_db_manage_script.md)** - Our db_manage.py explained.
