# ðŸ›¡ï¸ Database Error Handling

> **Secure, User-Friendly Database Error Responses**

---

## ðŸ“‹ Overview

Database errors can expose sensitive information about your schema and implementation. This document explains our approach to handling SQLAlchemy exceptions securely while providing helpful feedback.

---

## ðŸŽ¯ The Problem: Raw Database Errors

Without proper handling, database errors expose sensitive information:

```json
{
    "error": {
        "code": "INTERNAL_ERROR",
        "message": "ProgrammingError: (psycopg2.errors.UndefinedTable) relation \"users.users\" does not exist\nLINE 2: FROM users.users..."
    }
}
```

### Why This Is Bad:

1. **Security Risk**: Attackers learn your table names, schema structure, and ORM being used
2. **Poor UX**: Users don't understand SQL errors
3. **Unprofessional**: Exposes internal implementation details

---

## ðŸ› ï¸ The Solution: Layered Error Handlers

We register specific handlers for different SQLAlchemy exception types:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Database Error Handling Flow                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Exception Raised in Route Handler                              â”‚
â”‚            â”‚                                                     â”‚
â”‚            â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚                Flask Error Handler Chain                    â”‚ â”‚
â”‚   â”‚                                                             â”‚ â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   Order matters! More specific    â”‚ â”‚
â”‚   â”‚  â”‚  IntegrityError     â”‚   handlers are checked first.     â”‚ â”‚
â”‚   â”‚  â”‚  (unique, FK, etc.) â”‚                                   â”‚ â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚ â”‚
â”‚   â”‚             â”‚ No match?                                    â”‚ â”‚
â”‚   â”‚             â–¼                                              â”‚ â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚ â”‚
â”‚   â”‚  â”‚  OperationalError   â”‚                                   â”‚ â”‚
â”‚   â”‚  â”‚  (connection, auth) â”‚                                   â”‚ â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚ â”‚
â”‚   â”‚             â”‚ No match?                                    â”‚ â”‚
â”‚   â”‚             â–¼                                              â”‚ â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚ â”‚
â”‚   â”‚  â”‚  ProgrammingError   â”‚   â† Missing table, bad SQL       â”‚ â”‚
â”‚   â”‚  â”‚  (schema mismatch)  â”‚                                   â”‚ â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚ â”‚
â”‚   â”‚             â”‚ No match?                                    â”‚ â”‚
â”‚   â”‚             â–¼                                              â”‚ â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚ â”‚
â”‚   â”‚  â”‚  DataError          â”‚                                   â”‚ â”‚
â”‚   â”‚  â”‚  (type mismatch)    â”‚                                   â”‚ â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚ â”‚
â”‚   â”‚             â”‚ No match?                                    â”‚ â”‚
â”‚   â”‚             â–¼                                              â”‚ â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚ â”‚
â”‚   â”‚  â”‚  SQLAlchemyError    â”‚   â† Catch-all for any DB errors  â”‚ â”‚
â”‚   â”‚  â”‚  (base class)       â”‚                                   â”‚ â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚ â”‚
â”‚   â”‚                                                             â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚   Result:                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  SERVER-SIDE       â”‚  CLIENT-SIDE                        â”‚   â”‚
â”‚   â”‚  (Logs)            â”‚  (Response)                         â”‚   â”‚
â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚   â”‚
â”‚   â”‚  Full traceback    â”‚  User-friendly message              â”‚   â”‚
â”‚   â”‚  SQL statement     â”‚  Generic error code                 â”‚   â”‚
â”‚   â”‚  Table names       â”‚  Appropriate HTTP status            â”‚   â”‚
â”‚   â”‚  Parameters        â”‚  NO internal details                â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“Š Exception Types and Responses

### 1. IntegrityError (HTTP 409 Conflict)

**When it occurs:**

-   Unique constraint violation (duplicate username, email)
-   Foreign key constraint violation
-   NOT NULL constraint violation
-   Check constraint violation

**Example trigger:**

```python
# User tries to register with existing email
user = User(email="existing@example.com")
db.session.add(user)
db.session.commit()  # â†’ IntegrityError
```

**Handler:**

```python
from sqlalchemy.exc import IntegrityError

@app.errorhandler(IntegrityError)
def handle_integrity_error(error):
    db.session.rollback()  # Important! Rollback failed transaction

    logger.warning("IntegrityError", extra={"error": str(error.orig)})

    return error_response(
        message="A record with this information already exists",
        error_code=ErrorCode.CONFLICT,
        status_code=409
    )
```

**Client receives:**

```json
{
    "success": false,
    "data": null,
    "error": {
        "code": "CONFLICT",
        "message": "A record with this information already exists"
    },
    "meta": null
}
```

---

### 2. OperationalError (HTTP 503 Service Unavailable)

**When it occurs:**

-   Database server is down
-   Connection timeout
-   Connection pool exhausted
-   Authentication failure

**Handler:**

```python
from sqlalchemy.exc import OperationalError

@app.errorhandler(OperationalError)
def handle_operational_error(error):
    db.session.rollback()

    logger.critical(
        "Database OperationalError - Database may be unavailable",
        exc_info=True,
        extra={"original_error": str(error.orig)}
    )

    return error_response(
        message="The service is temporarily unavailable. Please try again later.",
        error_code=ErrorCode.DATABASE_ERROR,
        status_code=503
    )
```

---

### 3. ProgrammingError (HTTP 500 Internal Server Error)

**When it occurs:**

-   Table doesn't exist (missing migrations)
-   Column doesn't exist
-   Invalid SQL syntax
-   Schema mismatch between code and database

**This is often a developer error** (forgot to run migrations).

**Handler:**

```python
from sqlalchemy.exc import ProgrammingError

@app.errorhandler(ProgrammingError)
def handle_programming_error(error):
    db.session.rollback()

    logger.error(
        "Database ProgrammingError - Possible schema mismatch or missing migrations",
        exc_info=True,
        extra={
            "error_type": "ProgrammingError",
            "original_error": str(error.orig),
            "hint": "Run 'flask db upgrade' to apply pending migrations"
        }
    )

    return error_response(
        message="The service encountered a configuration error. Please try again later.",
        error_code=ErrorCode.DATABASE_ERROR,
        status_code=500
    )
```

---

### 4. DataError (HTTP 400 Bad Request)

**When it occurs:**

-   Value too long for column
-   Invalid data type conversion
-   Numeric overflow

**Handler:**

```python
from sqlalchemy.exc import DataError

@app.errorhandler(DataError)
def handle_data_error(error):
    db.session.rollback()

    logger.warning("DataError", extra={"error": str(error.orig)})

    return error_response(
        message="The provided data could not be processed. Please check your input.",
        error_code=ErrorCode.BAD_REQUEST,
        status_code=400
    )
```

---

### 5. SQLAlchemyError (Catch-All)

**When it occurs:**

-   Any other SQLAlchemy error not caught by specific handlers

**Handler:**

```python
from sqlalchemy.exc import SQLAlchemyError

@app.errorhandler(SQLAlchemyError)
def handle_sqlalchemy_error(error):
    db.session.rollback()

    logger.error(
        "Unhandled SQLAlchemyError",
        exc_info=True,
        extra={"error_type": type(error).__name__}
    )

    return error_response(
        message="A database error occurred. Please try again later.",
        error_code=ErrorCode.DATABASE_ERROR,
        status_code=500
    )
```

---

## ðŸ“‹ Complete Error Handler Registration

```python
# app/utils/error_handlers.py

from flask import Flask
from sqlalchemy.exc import (
    IntegrityError,
    OperationalError,
    ProgrammingError,
    DataError,
    SQLAlchemyError,
)

from app import db
from app.utils.responses import error_response, ErrorCode


def register_database_error_handlers(app: Flask) -> None:
    """Register all database error handlers."""

    @app.errorhandler(IntegrityError)
    def handle_integrity_error(error):
        db.session.rollback()
        app.logger.warning("IntegrityError: %s", error.orig)
        return error_response(
            message="A record with this information already exists",
            error_code=ErrorCode.CONFLICT,
            status_code=409
        )

    @app.errorhandler(OperationalError)
    def handle_operational_error(error):
        db.session.rollback()
        app.logger.critical("OperationalError: %s", error.orig, exc_info=True)
        return error_response(
            message="The service is temporarily unavailable. Please try again later.",
            error_code=ErrorCode.DATABASE_ERROR,
            status_code=503
        )

    @app.errorhandler(ProgrammingError)
    def handle_programming_error(error):
        db.session.rollback()
        app.logger.error("ProgrammingError: %s", error.orig, exc_info=True)
        return error_response(
            message="The service encountered a configuration error.",
            error_code=ErrorCode.DATABASE_ERROR,
            status_code=500
        )

    @app.errorhandler(DataError)
    def handle_data_error(error):
        db.session.rollback()
        app.logger.warning("DataError: %s", error.orig)
        return error_response(
            message="The provided data could not be processed.",
            error_code=ErrorCode.BAD_REQUEST,
            status_code=400
        )

    @app.errorhandler(SQLAlchemyError)
    def handle_sqlalchemy_error(error):
        db.session.rollback()
        app.logger.error("SQLAlchemyError: %s", error, exc_info=True)
        return error_response(
            message="A database error occurred.",
            error_code=ErrorCode.DATABASE_ERROR,
            status_code=500
        )
```

---

## ðŸ” Security Best Practices

### 1. Never Expose SQL or Table Names

```python
# âŒ BAD - Exposes table name
message = str(error)  # "relation 'users.users' does not exist"

# âœ… GOOD - Generic message
message = "The service encountered a configuration error."
```

### 2. Log Full Details Server-Side Only

```python
logger.error(
    "Database ProgrammingError - Possible schema mismatch",
    exc_info=True,  # Full traceback in logs
    extra={
        "original_error": str(error.orig),  # Full SQL error - ONLY in logs
        "hint": "Run 'flask db upgrade'"
    }
)
```

### 3. Always Rollback Failed Transactions

```python
@app.errorhandler(IntegrityError)
def handle_integrity_error(error):
    db.session.rollback()  # â† IMPORTANT! Clean up failed transaction
    # ...
```

Without rollback, the session remains in a bad state and subsequent queries will fail.

---

## ðŸ“Š Error Code Reference

| Exception Type     | HTTP Status | Error Code       | When It Happens               |
| ------------------ | ----------- | ---------------- | ----------------------------- |
| `IntegrityError`   | 409         | `CONFLICT`       | Duplicate, FK violation, etc. |
| `OperationalError` | 503         | `DATABASE_ERROR` | DB connection issues          |
| `ProgrammingError` | 500         | `DATABASE_ERROR` | Missing table, bad SQL        |
| `DataError`        | 400         | `BAD_REQUEST`    | Data type mismatch            |
| `SQLAlchemyError`  | 500         | `DATABASE_ERROR` | Any other DB error            |

---

## ðŸ”§ Debugging Tips

### Check if Migrations Are Applied

```bash
# View current migration status
flask db current

# View migration history
flask db history
```

### Common Error: "relation does not exist"

**Cause:** Table hasn't been created (missing migrations)

**Fix:**

```bash
# Apply pending migrations
flask db upgrade

# Or if starting fresh
python db_manage.py setup
```

### Common Error: "duplicate key value violates unique constraint"

**Cause:** Trying to insert a record with a value that already exists

**Fix:** Check your data or handle the duplicate at the service layer

---

## ðŸ†š Express.js Comparison

**Express/Sequelize:**

```javascript
app.use((err, req, res, next) => {
    if (err.name === "SequelizeUniqueConstraintError") {
        return res.status(409).json({ error: "Duplicate entry" });
    }
    if (err.name === "SequelizeConnectionError") {
        return res.status(503).json({ error: "Database unavailable" });
    }
    // ...
});
```

**Flask/SQLAlchemy:**

```python
@app.errorhandler(IntegrityError)
def handle_integrity_error(error):
    return error_response(message="Duplicate entry", status_code=409)

@app.errorhandler(OperationalError)
def handle_operational_error(error):
    return error_response(message="Database unavailable", status_code=503)
```

Same concept, different syntax!

---

## ðŸ”œ Next Steps

Now you understand database error handling. Continue to the API design section.

**Next: [../04_api_design/4.1_rest_api_basics.md](../04_api_design/4.1_rest_api_basics.md)** - REST API principles.

---

## ðŸ“š Related Documentation

-   [4.11_error_handling.md](../04_api_design/4.11_error_handling.md) - General error handling
-   [4.10_response_format.md](../04_api_design/4.10_response_format.md) - Standardized responses
