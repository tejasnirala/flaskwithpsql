# ğŸ› ï¸ db_manage.py Script

> **Our Custom Database Management Tool**

---

## ğŸ“‹ Overview

`db_manage.py` is a custom Python script that provides convenient commands for managing the database. It wraps Flask-Migrate commands and adds additional functionality.

---

## ğŸ“ File Location

```
flaskwithpsql/
â”œâ”€â”€ db_manage.py      â† This script
â”œâ”€â”€ run.py
â”œâ”€â”€ config.py
â””â”€â”€ app/
```

---

## ğŸ“‹ Available Commands

```bash
python db_manage.py [command] [options]
```

| Command        | Description                                      |
| -------------- | ------------------------------------------------ |
| `init`         | Initialize migrations folder                     |
| `migrate`      | Create new migration from model changes          |
| `upgrade`      | Apply pending migrations                         |
| `downgrade`    | Rollback the last migration                      |
| `reset`        | Drop all tables and recreate (DANGEROUS!)        |
| `reset-schema` | Drop and recreate a specific schema (DANGEROUS!) |
| `reset-table`  | Drop and recreate a specific table (DANGEROUS!)  |
| `seed`         | Populate database with sample data               |
| `setup`        | Full setup: init + migrate + upgrade             |

---

## ğŸ”§ Command Details

### `init` - Initialize Migrations

```bash
python db_manage.py init
```

Creates the `migrations/` folder. Only needed once per project.

```
migrations/
â”œâ”€â”€ README
â”œâ”€â”€ alembic.ini
â”œâ”€â”€ env.py
â”œâ”€â”€ script.py.mako
â””â”€â”€ versions/
```

### `migrate` - Generate Migration

```bash
python db_manage.py migrate "Description of changes"
```

Compares your models to the database and generates a migration file.

**Example:**

```bash
python db_manage.py migrate "Add phone column to users"

# Output:
# ============================================================
#   Creating migration: Add phone column to users
# ============================================================
# $ flask db migrate -m "Add phone column to users"
#
# âœ… Creating migration: Add phone column to users completed successfully!
```

### `upgrade` - Apply Migrations

```bash
python db_manage.py upgrade
```

Applies all pending migrations to the database.

### `downgrade` - Rollback

```bash
python db_manage.py downgrade
```

Reverts the most recent migration.

### `reset` - Full Database Reset

```bash
python db_manage.py reset
```

âš ï¸ **DANGEROUS!** Drops all tables and recreates them.

**What it does:**

1. Prompts for confirmation
2. Detects custom schemas from models
3. Drops all tables
4. Recreates schemas
5. Recreates all tables

```bash
# Example output:
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#   âš ï¸  WARNING: This will DELETE ALL DATA!
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#
# Type 'yes' to confirm: yes
#
# ğŸ“‹ Detected custom schemas: users
#
# ğŸ—‘ï¸  Dropping all tables...
# âœ… All tables dropped.
#
# ğŸ—ï¸  Recreating schemas...
#   âœ“ Created schema: users
# âœ… Schemas recreated.
#
# ğŸ—ï¸  Creating all tables...
# âœ… All tables created.
```

### `reset-schema` - Reset Specific Schema

```bash
python db_manage.py reset-schema users
```

Drops and recreates a specific PostgreSQL schema and its tables.

### `reset-table` - Reset Specific Table

```bash
python db_manage.py reset-table users
```

Drops and recreates a specific table.

### `seed` - Add Sample Data

```bash
python db_manage.py seed
```

Populates the database with sample users for testing:

```bash
# Output:
# ğŸŒ± Seeding database with sample data...
#   âœ“ Created user: admin
#   âœ“ Created user: john_doe
#   âœ“ Created user: jane_smith
#   âœ“ Created user: test_user
#
# âœ… Created 4 sample users.
```

**Sample users created:**

| Username   | Email             | Password     |
| ---------- | ----------------- | ------------ |
| admin      | admin@example.com | Password123! |
| john_doe   | john@example.com  | Password123! |
| jane_smith | jane@example.com  | Password123! |
| test_user  | test@example.com  | Password123! |

### `setup` - Full Database Setup

```bash
python db_manage.py setup
```

Runs the complete setup process:

1. `init` (if migrations folder doesn't exist)
2. `migrate "Initial migration"`
3. `upgrade`

---

## ğŸ“Š How It Works

### Core Architecture

```python
# db_manage.py

def run_command(command: str, description: str = "") -> bool:
    """Run a shell command and return success status."""
    print(f"$ {command}")
    result = subprocess.run(command, shell=True, ...)
    return result.returncode == 0


def init_migrations():
    """Initialize the migrations folder."""
    if check_migrations_folder():
        print("âš ï¸  Migrations folder already exists. Skipping init.")
        return True
    return run_command("flask db init", "Initializing migrations folder")


def create_migration(message: str = "Auto migration"):
    """Create a new migration based on model changes."""
    return run_command(f'flask db migrate -m "{message}"', ...)


def upgrade_database():
    """Apply pending migrations to the database."""
    return run_command("flask db upgrade", "Applying migrations to database")
```

### Schema-Aware Reset

The `reset` command automatically detects PostgreSQL schemas:

```python
def reset_database():
    from app import create_app, db

    app = create_app("development")

    with app.app_context():
        # Detect schemas from model metadata
        schemas = set()
        for table in db.metadata.tables.values():
            if table.schema:
                schemas.add(table.schema)

        # Drop all tables
        db.drop_all()

        # Recreate schemas
        for schema in schemas:
            db.session.execute(db.text(f'CREATE SCHEMA IF NOT EXISTS "{schema}"'))

        # Recreate tables
        db.create_all()
```

---

## ğŸ“Š Workflow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   db_manage.py WORKFLOW                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   NEW PROJECT SETUP:                                             â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                             â”‚
â”‚   $ python db_manage.py setup                                    â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”œâ”€â”€ Check migrations folder (create if needed)             â”‚
â”‚       â”œâ”€â”€ Generate initial migration                             â”‚
â”‚       â””â”€â”€ Apply migration to database                            â”‚
â”‚                                                                  â”‚
â”‚   DEVELOPMENT CYCLE:                                             â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                             â”‚
â”‚   1. Edit models                                                 â”‚
â”‚   2. $ python db_manage.py migrate "Description"                 â”‚
â”‚   3. $ python db_manage.py upgrade                               â”‚
â”‚   4. $ python db_manage.py seed  (if needed)                     â”‚
â”‚                                                                  â”‚
â”‚   STARTING FRESH:                                                â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚   $ python db_manage.py reset                                    â”‚
â”‚   $ python db_manage.py seed                                     â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ†š db_manage.py vs Flask-Migrate

| Task                  | Flask-Migrate            | db_manage.py                       |
| --------------------- | ------------------------ | ---------------------------------- |
| Initialize            | `flask db init`          | `python db_manage.py init`         |
| Generate migration    | `flask db migrate -m ""` | `python db_manage.py migrate ""`   |
| Apply migrations      | `flask db upgrade`       | `python db_manage.py upgrade`      |
| Reset database        | Manual process           | `python db_manage.py reset`        |
| Reset specific schema | Not available            | `python db_manage.py reset-schema` |
| Seed data             | Custom script needed     | `python db_manage.py seed`         |
| Full setup            | Multiple commands        | `python db_manage.py setup`        |

**Why use db_manage.py?**

1. **Convenience**: Single entry point for all DB operations
2. **Schema support**: Handles PostgreSQL schemas automatically
3. **Safety prompts**: Dangerous operations require confirmation
4. **Seeding**: Built-in sample data
5. **Better output**: Colored, formatted output

---

## ğŸ§ª Using in Tests

The script can also be used programmatically:

```python
# In tests or scripts
from db_manage import reset_database, seed_database

# Reset and seed for testing
reset_database()
seed_database()
```

---

## âš ï¸ Safety Notes

### Protected Commands

These commands are protected with confirmation prompts:

-   `reset` - Deletes ALL data
-   `reset-schema` - Deletes schema data
-   `reset-table` - Deletes table data

```bash
python db_manage.py reset
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#   âš ï¸  WARNING: This will DELETE ALL DATA!
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#
# Type 'yes' to confirm:
```

### Never Run in Production

```bash
# âŒ NEVER do this in production!
python db_manage.py reset

# âœ… In production, only use:
python db_manage.py upgrade
```

---

## ğŸ“ Environment Setup

The script sets up Flask environment automatically:

```python
def main():
    # Set Flask app environment variable
    os.environ.setdefault("FLASK_APP", "run.py")
    os.environ.setdefault("FLASK_ENV", "development")

    # ... rest of script
```

---

## ğŸ‰ Section Complete!

You've completed the **03_database** section! You now understand:

1. âœ… What SQLAlchemy is (ORM overview)
2. âœ… How Flask-SQLAlchemy is configured
3. âœ… How to define models
4. âœ… The BaseModel pattern for common fields
5. âœ… Our User model in detail
6. âœ… Database relationships
7. âœ… CRUD operations and querying
8. âœ… What migrations are
9. âœ… Using Flask-Migrate
10. âœ… Our db_manage.py script

---

## ğŸ”œ Next Section

Ready to learn about API design? Let's go!

**Next: [../04_api_design/4.1_rest_api_basics.md](../04_api_design/4.1_rest_api_basics.md)** - REST API principles.
