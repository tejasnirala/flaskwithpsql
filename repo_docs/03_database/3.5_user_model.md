# ğŸ‘¤ User Model Deep Dive

> **Understanding Our User Model**

---

## ğŸ“‹ Overview

The User model is our main entity. It inherits from BaseModel and adds user-specific fields and methods.

---

## ğŸ“ Complete User Model

```python
# app/models/user.py

from sqlalchemy import Boolean, Column, String, Text
from app.models.base import BaseModel


class User(BaseModel):
    """
    User model representing the users table in PostgreSQL.

    Inherits from BaseModel:
        - id (Integer, Primary Key)
        - created_at (DateTime)
        - updated_at (DateTime)
        - is_deleted (Boolean)
    """

    __tablename__ = "users"
    __table_args__ = {"schema": "users"}

    # ========================================================================
    # USER INFORMATION (Unique identifiers)
    # ========================================================================
    username = Column(String(100), unique=True, nullable=False, index=True)
    email = Column(String(120), unique=True, nullable=False, index=True)
    password_hash = Column(String(256), nullable=False)

    # ========================================================================
    # PROFILE INFORMATION
    # ========================================================================
    first_name = Column(String(50), nullable=False)
    middle_name = Column(String(50), nullable=True)
    last_name = Column(String(50), nullable=True)
    bio = Column(Text, nullable=True)

    # ========================================================================
    # STATUS FLAGS
    # ========================================================================
    is_active = Column(Boolean, default=True)

    # ========================================================================
    # METHODS
    # ========================================================================
    def __repr__(self):
        return f"<User {self.username}>"

    def to_dict(self):
        data = self.to_base_dict()
        data.update({
            "username": self.username,
            "email": self.email,
            "first_name": self.first_name,
            "middle_name": self.middle_name,
            "last_name": self.last_name,
            "bio": self.bio,
            "is_active": self.is_active,
        })
        return data

    # Password methods...
```

---

## ğŸ“Š Table Configuration

### `__tablename__`

```python
__tablename__ = "users"
```

Explicitly sets the table name. Without this, SQLAlchemy would generate `user` (lowercase class name).

### `__table_args__` with Schema

```python
__table_args__ = {"schema": "users"}
```

**What is a PostgreSQL schema?**

A schema is like a namespace for tables. It's a way to organize tables logically.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PostgreSQL Database                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  public schema  â”‚  â”‚  users schema   â”‚  â”‚  logs schema    â”‚  â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚   â”‚  â€¢ migrations   â”‚  â”‚  â€¢ users        â”‚  â”‚  â€¢ audit_logs   â”‚  â”‚
â”‚   â”‚  â€¢ settings     â”‚  â”‚  â€¢ profiles     â”‚  â”‚  â€¢ error_logs   â”‚  â”‚
â”‚   â”‚                 â”‚  â”‚  â€¢ sessions     â”‚  â”‚                 â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚   Access: SELECT * FROM users.users;                             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Why use schemas?**

1. **Organization**: Group related tables
2. **Security**: Set permissions per schema
3. **Avoid conflicts**: Same table name in different schemas
4. **Multi-tenancy**: Each tenant gets their own schema

---

## ğŸ”’ Password Handling

### Never Store Plain Passwords!

```python
# âŒ NEVER DO THIS
password = Column(String(256))  # Plain text password!

# âœ… ALWAYS HASH
password_hash = Column(String(256))  # Hashed password
```

### Password Methods

```python
@staticmethod
def hash_password(password: str) -> str:
    """
    Hash a password for storing using secure werkzeug functions.

    Uses PBKDF2 with SHA-256:
    - Slow by design (resistant to brute-force)
    - Automatically salted
    - Industry standard
    """
    from werkzeug.security import generate_password_hash
    return generate_password_hash(password)


def check_password(self, password: str) -> bool:
    """
    Verify a password against the stored hash.

    Uses werkzeug's secure comparison (timing-attack safe).
    """
    from werkzeug.security import check_password_hash
    return check_password_hash(self.password_hash, password)


def set_password(self, password: str) -> None:
    """Set a new password for the user."""
    self.password_hash = self.hash_password(password)
```

### Password Hashing Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PASSWORD HASHING FLOW                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Registration:                                                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚
â”‚   User enters: "MySecurePassword123!"                            â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   user.set_password("MySecurePassword123!")                      â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   generate_password_hash()                                       â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   Stored: "pbkdf2:sha256:600000$abc123...$xyz789..."             â”‚
â”‚           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚
â”‚           â”‚         â”‚              â”‚       â”‚                     â”‚
â”‚           â”‚         â”‚              â”‚       â””â”€ Actual hash        â”‚
â”‚           â”‚         â”‚              â””â”€ Random salt                â”‚
â”‚           â”‚         â””â”€ Iterations (slow = secure)                â”‚
â”‚           â””â”€ Algorithm                                           â”‚
â”‚                                                                  â”‚
â”‚   Login:                                                         â”‚
â”‚   â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚   User enters: "MySecurePassword123!"                            â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   user.check_password("MySecurePassword123!")                    â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   check_password_hash(stored_hash, entered_password)             â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   Returns: True or False                                         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Field Details

### Unique Identifiers

```python
username = Column(String(100), unique=True, nullable=False, index=True)
email = Column(String(120), unique=True, nullable=False, index=True)
```

| Field    | Constraints    | Why                         |
| -------- | -------------- | --------------------------- |
| username | unique         | No two users with same name |
|          | nullable=False | Username is required        |
|          | index=True     | Fast lookups by username    |
| email    | unique         | No duplicate emails         |
|          | nullable=False | Email is required           |
|          | index=True     | Fast lookups by email       |

### Profile Information

```python
first_name = Column(String(50), nullable=False)   # Required
middle_name = Column(String(50), nullable=True)   # Optional
last_name = Column(String(50), nullable=True)     # Optional
bio = Column(Text, nullable=True)                  # Optional, unlimited length
```

### Status Flags

```python
is_active = Column(Boolean, default=True)
# From BaseModel:
# is_deleted = Column(Boolean, default=False)
```

**`is_active` vs `is_deleted`:**

| Flag       | Purpose                | Use Case                    |
| ---------- | ---------------------- | --------------------------- |
| is_active  | User can login/use app | Suspend account temporarily |
| is_deleted | Record is "deleted"    | User deleted their account  |

---

## ğŸ”§ Model Methods

### `__repr__()` - String Representation

```python
def __repr__(self):
    return f"<User {self.username}>"
```

Used for debugging:

```python
>>> user = User.query.get(1)
>>> print(user)
<User john_doe>

>>> users = User.query.all()
>>> print(users)
[<User john_doe>, <User jane_smith>]
```

### `to_dict()` - Convert to Dictionary

```python
def to_dict(self):
    data = self.to_base_dict()  # id, created_at, updated_at, is_deleted
    data.update({
        "username": self.username,
        "email": self.email,
        "first_name": self.first_name,
        "middle_name": self.middle_name,
        "last_name": self.last_name,
        "bio": self.bio,
        "is_active": self.is_active,
    })
    return data
```

**Note:** Password is **never** included in `to_dict()`!

---

## ğŸ†š Comparison with Mongoose

### Mongoose Schema

```javascript
const userSchema = new mongoose.Schema({
    username: { type: String, required: true, unique: true },
    email: { type: String, required: true, unique: true },
    passwordHash: { type: String, required: true },
    firstName: { type: String, required: true },
    middleName: String,
    lastName: String,
    bio: String,
    isActive: { type: Boolean, default: true },
});

userSchema.methods.checkPassword = function (password) {
    return bcrypt.compare(password, this.passwordHash);
};
```

### SQLAlchemy Model

```python
class User(BaseModel):
    __tablename__ = "users"

    username = Column(String(100), unique=True, nullable=False)
    email = Column(String(120), unique=True, nullable=False)
    password_hash = Column(String(256), nullable=False)
    first_name = Column(String(50), nullable=False)
    middle_name = Column(String(50))
    last_name = Column(String(50))
    bio = Column(Text)
    is_active = Column(Boolean, default=True)

    def check_password(self, password):
        return check_password_hash(self.password_hash, password)
```

**Key differences:**

| Mongoose             | SQLAlchemy            |
| -------------------- | --------------------- |
| `required: true`     | `nullable=False`      |
| `type: String`       | `Column(String(n))`   |
| `type: Boolean`      | `Column(Boolean)`     |
| `schema.methods.fn`  | `def fn(self):`       |
| camelCase convention | snake_case convention |

---

## ğŸ“ File Location

```
app/
â””â”€â”€ models/
    â”œâ”€â”€ __init__.py     # Exports User
    â”œâ”€â”€ base.py         # BaseModel
    â””â”€â”€ user.py         # User model â† THIS FILE
```

---

## ğŸ”œ Next Steps

Now let's learn about relationships between models.

**Next: [3.6_relationships.md](./3.6_relationships.md)** - Foreign keys and relationships.
