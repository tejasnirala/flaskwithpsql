# ğŸ“¦ Migrations Overview

> **Version Control for Your Database Schema**

---

## ğŸ“‹ What Are Migrations?

Migrations are **version control for your database schema**. Just like Git tracks changes to your code, migrations track changes to your database structure.

---

## ğŸ¯ Why Do We Need Migrations?

### The Problem Without Migrations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             WITHOUT MIGRATIONS - CHAOS!                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Developer A:                                                   â”‚
â”‚   "I added a 'phone' column to users table"                      â”‚
â”‚   â†’ Runs: ALTER TABLE users ADD COLUMN phone VARCHAR(20)         â”‚
â”‚                                                                  â”‚
â”‚   Developer B:                                                   â”‚
â”‚   "What? I don't have that column. My code is crashing!"         â”‚
â”‚                                                                  â”‚
â”‚   Production Server:                                             â”‚
â”‚   "Neither do I. Deploy failed."                                 â”‚
â”‚                                                                  â”‚
â”‚   Problems:                                                      â”‚
â”‚   âŒ No record of what changes were made                         â”‚
â”‚   âŒ Different environments have different schemas               â”‚
â”‚   âŒ Can't reproduce the database state                          â”‚
â”‚   âŒ Deployment is manual and error-prone                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### The Solution With Migrations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                WITH MIGRATIONS - ORDER!                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Developer A:                                                   â”‚
â”‚   1. Updates User model: phone = Column(String(20))              â”‚
â”‚   2. Runs: flask db migrate -m "Add phone to users"              â”‚
â”‚   3. Migration file created and committed to Git                 â”‚
â”‚                                                                  â”‚
â”‚   Developer B:                                                   â”‚
â”‚   1. Pulls latest code                                           â”‚
â”‚   2. Runs: flask db upgrade                                      â”‚
â”‚   3. Database automatically updated!                             â”‚
â”‚                                                                  â”‚
â”‚   Production Server:                                             â”‚
â”‚   1. Deploy includes migration files                             â”‚
â”‚   2. CI/CD runs: flask db upgrade                                â”‚
â”‚   3. Production database matches dev!                            â”‚
â”‚                                                                  â”‚
â”‚   Benefits:                                                      â”‚
â”‚   âœ… Changes tracked in Git                                      â”‚
â”‚   âœ… All environments stay in sync                               â”‚
â”‚   âœ… Can rollback if something goes wrong                        â”‚
â”‚   âœ… Automated, reproducible deployments                         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ†š Comparison with Node.js

### Prisma

```bash
# Edit schema.prisma, then:
npx prisma migrate dev --name add_phone_to_users
npx prisma migrate deploy  # Apply to production
```

### Sequelize

```bash
npx sequelize-cli migration:generate --name add-phone-to-users
npx sequelize-cli db:migrate
```

### SQLAlchemy (with Alembic/Flask-Migrate)

```bash
flask db migrate -m "Add phone to users"
flask db upgrade
```

---

## ğŸ“Š Migration Workflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   MIGRATION WORKFLOW                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   1. CHANGE MODEL                                                â”‚
â”‚      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                             â”‚
â”‚      Edit Python model file:                                     â”‚
â”‚      phone = Column(String(20))                                  â”‚
â”‚                                                                  â”‚
â”‚              â”‚                                                   â”‚
â”‚              â–¼                                                   â”‚
â”‚                                                                  â”‚
â”‚   2. GENERATE MIGRATION                                          â”‚
â”‚      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚      $ flask db migrate -m "Add phone to users"                  â”‚
â”‚                                                                  â”‚
â”‚      Creates: migrations/versions/abc123_add_phone_to_users.py   â”‚
â”‚                                                                  â”‚
â”‚              â”‚                                                   â”‚
â”‚              â–¼                                                   â”‚
â”‚                                                                  â”‚
â”‚   3. REVIEW MIGRATION                                            â”‚
â”‚      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                        â”‚
â”‚      Open the file and verify it looks correct                   â”‚
â”‚                                                                  â”‚
â”‚              â”‚                                                   â”‚
â”‚              â–¼                                                   â”‚
â”‚                                                                  â”‚
â”‚   4. APPLY MIGRATION                                             â”‚
â”‚      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚      $ flask db upgrade                                          â”‚
â”‚                                                                  â”‚
â”‚      Database schema is now updated!                             â”‚
â”‚                                                                  â”‚
â”‚              â”‚                                                   â”‚
â”‚              â–¼                                                   â”‚
â”‚                                                                  â”‚
â”‚   5. COMMIT TO GIT                                               â”‚
â”‚      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                            â”‚
â”‚      $ git add migrations/                                       â”‚
â”‚      $ git commit -m "Add phone column migration"                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Migration File Structure

```
migrations/
â”œâ”€â”€ README                    # Info about the migrations folder
â”œâ”€â”€ alembic.ini               # Alembic configuration
â”œâ”€â”€ env.py                    # Environment setup for migrations
â”œâ”€â”€ script.py.mako            # Template for migration files
â””â”€â”€ versions/                 # Actual migration files
    â”œâ”€â”€ 001_initial_migration.py
    â”œâ”€â”€ 002_add_phone_to_users.py
    â””â”€â”€ 003_add_bio_column.py
```

---

## ğŸ“ What's in a Migration File?

```python
# migrations/versions/abc123_add_phone_to_users.py
"""Add phone to users

Revision ID: abc123
Revises: xyz789
Create Date: 2025-01-13 10:30:00

"""
from alembic import op
import sqlalchemy as sa

# Revision identifiers
revision = 'abc123'
down_revision = 'xyz789'  # Previous migration
branch_labels = None
depends_on = None


def upgrade():
    """Apply the migration."""
    op.add_column('users', sa.Column('phone', sa.String(20), nullable=True))


def downgrade():
    """Rollback the migration."""
    op.drop_column('users', 'phone')
```

**Key parts:**

1. **revision**: Unique ID for this migration
2. **down_revision**: ID of the previous migration (chain)
3. **upgrade()**: What to do when applying
4. **downgrade()**: What to do when rolling back

---

## ğŸ“Š Migration Chain

Migrations form a chain, each pointing to its predecessor:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Initial â”‚ â”€â”€â–º â”‚  Add    â”‚ â”€â”€â–º â”‚  Add    â”‚ â”€â”€â–º â”‚ Latest  â”‚
â”‚  (001)  â”‚     â”‚  Users  â”‚     â”‚  Phone  â”‚     â”‚  (004)  â”‚
â”‚         â”‚     â”‚  (002)  â”‚     â”‚  (003)  â”‚     â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                               â”‚
     â”‚                                               â”‚
     â–¼                                               â–¼
   Empty                                         Current
  Database                                        State
```

You can:

-   **upgrade**: Move forward in the chain
-   **downgrade**: Move backward in the chain
-   **upgrade head**: Go to the latest
-   **downgrade base**: Go back to empty

---

## ğŸ”§ Common Migration Operations

### Adding a Column

```python
def upgrade():
    op.add_column('users', sa.Column('phone', sa.String(20), nullable=True))

def downgrade():
    op.drop_column('users', 'phone')
```

### Adding a Table

```python
def upgrade():
    op.create_table(
        'posts',
        sa.Column('id', sa.Integer, primary_key=True),
        sa.Column('title', sa.String(200), nullable=False),
        sa.Column('user_id', sa.Integer, sa.ForeignKey('users.id')),
    )

def downgrade():
    op.drop_table('posts')
```

### Adding an Index

```python
def upgrade():
    op.create_index('ix_users_email', 'users', ['email'])

def downgrade():
    op.drop_index('ix_users_email', 'users')
```

### Creating a Schema

```python
def upgrade():
    op.execute('CREATE SCHEMA IF NOT EXISTS users')

def downgrade():
    op.execute('DROP SCHEMA IF EXISTS users CASCADE')
```

---

## âš ï¸ Migration Best Practices

### 1. Always Review Generated Migrations

```python
# Flask-Migrate generates, but doesn't always get it perfect
# Always check before applying!
```

### 2. Never Edit Applied Migrations

```python
# âŒ BAD - Editing a migration that's been applied
# This will cause issues for other developers

# âœ… GOOD - Create a new migration to fix issues
flask db migrate -m "Fix phone column type"
```

### 3. Make Migrations Reversible

```python
# âœ… GOOD - Can go forward and backward
def upgrade():
    op.add_column('users', sa.Column('phone', sa.String(20)))

def downgrade():
    op.drop_column('users', 'phone')
```

### 4. Handle Data Migrations Carefully

```python
# When changing column types or moving data
def upgrade():
    # Add new column
    op.add_column('users', sa.Column('new_col', sa.String(100)))

    # Migrate data (be careful!)
    op.execute("""
        UPDATE users SET new_col = old_col
    """)

    # Remove old column
    op.drop_column('users', 'old_col')
```

---

## ğŸ”œ Next Steps

Now let's see how to use Flask-Migrate in practice.

**Next: [3.9_flask_migrate.md](./3.9_flask_migrate.md)** - Using Flask-Migrate commands.
