# ğŸ—ƒï¸ SQLAlchemy Overview

> **Python's Most Popular ORM**

---

## ğŸ“‹ What is SQLAlchemy?

SQLAlchemy is a **SQL toolkit and Object-Relational Mapper (ORM)** for Python. It lets you interact with databases using Python objects instead of writing raw SQL.

---

## ğŸ†š Comparison with Node.js ORMs

| Feature            | SQLAlchemy            | Prisma          | Sequelize         | Mongoose         |
| ------------------ | --------------------- | --------------- | ----------------- | ---------------- |
| **Type**           | ORM                   | ORM             | ORM               | ODM              |
| **Database**       | Multiple (SQL)        | Multiple (SQL)  | Multiple (SQL)    | MongoDB only     |
| **Query Language** | Python methods        | TypeScript API  | JavaScript API    | MongoDB queries  |
| **Migrations**     | Alembic/Flask-Migrate | Built-in        | Sequelize-CLI     | Not needed       |
| **Schema**         | Python classes        | `.prisma` file  | JavaScript models | Mongoose schemas |
| **Type Safety**    | Optional (type hints) | Full TypeScript | Optional          | No               |

---

## ğŸ”§ ORM vs Raw SQL

### âŒ Raw SQL Approach

```python
# Without ORM - writing raw SQL
import psycopg2

conn = psycopg2.connect("postgresql://localhost/mydb")
cursor = conn.cursor()

# Insert a user
cursor.execute("""
    INSERT INTO users (username, email, password_hash)
    VALUES (%s, %s, %s)
    RETURNING id
""", ("john_doe", "john@example.com", "hashed_password"))

user_id = cursor.fetchone()[0]

# Get a user
cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))
row = cursor.fetchone()

# Manual mapping to dict
user = {
    "id": row[0],
    "username": row[1],
    "email": row[2],
    # ... tedious!
}

conn.commit()
cursor.close()
conn.close()
```

**Problems:**

-   SQL injection risk (if not careful with parameterization)
-   Manual connection management
-   No type checking
-   Manual mapping between rows and objects
-   Database-specific SQL

### âœ… ORM Approach (SQLAlchemy)

```python
# With SQLAlchemy ORM
from app import db
from app.models.user import User

# Insert a user
user = User(
    username="john_doe",
    email="john@example.com",
)
user.set_password("secure_password")
db.session.add(user)
db.session.commit()

# Get a user
user = User.query.get(1)

# Already a Python object!
print(user.username)  # "john_doe"
print(user.to_dict())  # Full dictionary
```

**Benefits:**

-   Automatic SQL parameterization (no SQL injection)
-   Connection pooling handled automatically
-   Python objects instead of tuples
-   Database-agnostic (switch databases easily)
-   Relationships are automatic

---

## ğŸ“Š SQLAlchemy Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SQLALCHEMY LAYERS                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Your Code (Models, Queries)                                    â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                    ORM Layer                            â”‚    â”‚
â”‚   â”‚   â€¢ Model classes (User, Post, etc.)                    â”‚    â”‚
â”‚   â”‚   â€¢ Query interface (User.query.filter_by())            â”‚    â”‚
â”‚   â”‚   â€¢ Relationships (user.posts)                          â”‚    â”‚
â”‚   â”‚   â€¢ Session management                                  â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                  Core Layer                             â”‚    â”‚
â”‚   â”‚   â€¢ SQL Expression Language                             â”‚    â”‚
â”‚   â”‚   â€¢ Schema/Types                                        â”‚    â”‚
â”‚   â”‚   â€¢ Engine/Connection                                   â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                    DBAPI                                â”‚    â”‚
â”‚   â”‚   â€¢ psycopg2 (PostgreSQL)                               â”‚    â”‚
â”‚   â”‚   â€¢ sqlite3 (SQLite)                                    â”‚    â”‚
â”‚   â”‚   â€¢ etc.                                                â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                  DATABASE                               â”‚    â”‚
â”‚   â”‚   â€¢ PostgreSQL, MySQL, SQLite, etc.                     â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Flask-SQLAlchemy

We use **Flask-SQLAlchemy**, which is a Flask extension that adds SQLAlchemy support:

```python
# Without Flask-SQLAlchemy
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

engine = create_engine('postgresql://...')
Session = sessionmaker(bind=engine)
session = Session()

# With Flask-SQLAlchemy
from flask_sqlalchemy import SQLAlchemy

db = SQLAlchemy()

# Then in your models:
class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
```

**Flask-SQLAlchemy provides:**

-   Automatic session management per request
-   Easy configuration via Flask config
-   Query property on models (`User.query`)
-   Integration with Flask's application context

---

## ğŸ“ Key Concepts

### 1. Engine

The engine is the "home base" for the database connection:

```python
# Flask-SQLAlchemy handles this via config
SQLALCHEMY_DATABASE_URI = 'postgresql://user:pass@localhost/dbname'
```

### 2. Session

The session manages your objects and transactions:

```python
# Add objects
db.session.add(user)

# Commit transaction
db.session.commit()

# Rollback on error
db.session.rollback()
```

### 3. Model

A Python class that maps to a database table:

```python
class User(db.Model):
    __tablename__ = 'users'

    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True)
```

### 4. Query

Interface for reading data:

```python
# Get all
users = User.query.all()

# Get one
user = User.query.get(1)

# Filter
admins = User.query.filter_by(is_admin=True).all()
```

---

## ğŸ†š Express/Node.js Mental Model

| Node.js Concept      | SQLAlchemy Equivalent              |
| -------------------- | ---------------------------------- |
| `mongoose.connect()` | `db.init_app(app)`                 |
| `mongoose.Schema`    | `class User(db.Model)`             |
| `Model.find()`       | `User.query.all()`                 |
| `Model.findById()`   | `User.query.get(id)`               |
| `Model.findOne()`    | `User.query.filter_by().first()`   |
| `doc.save()`         | `db.session.commit()`              |
| `Model.create()`     | `db.session.add()` + `commit()`    |
| `doc.remove()`       | `db.session.delete()` + `commit()` |

---

## ğŸ”œ Next Steps

Now that you understand what SQLAlchemy is, let's see how it's configured in our project.

**Next: [3.2_database_setup.md](./3.2_database_setup.md)** - Flask-SQLAlchemy configuration.
