# ğŸ¥ Main Routes Explained

> **Health Check and Status Endpoints**

---

## ğŸ“‹ Overview

The main routes provide health checks and basic API status. These are essential for:

-   **Monitoring systems** (Kubernetes, load balancers)
-   **Debugging** (verify API is running)
-   **Documentation** (welcome message with API info)

---

## ğŸ“ File Location

```
app/routes/v1/main.py
```

---

## ğŸ“ Complete Code with Explanation

```python
"""Main routes for API v1.

These routes provide health checks and basic status endpoints.
Using APIBlueprint from flask-openapi3 for automatic OpenAPI documentation.
"""

import logging
from typing import Optional

from flask_openapi3 import APIBlueprint, Tag
from pydantic import BaseModel, Field

from app.utils.responses import StandardSuccessResponse, success_response
from app.version import __version__

# Module-level logger
logger = logging.getLogger(__name__)
```

### Import Breakdown

| Import              | Purpose                           |
| ------------------- | --------------------------------- |
| `logging`           | For logging errors/events         |
| `APIBlueprint, Tag` | Flask-openapi3 components         |
| `BaseModel, Field`  | Pydantic for response schemas     |
| `success_response`  | Standardized response helper      |
| `__version__`       | App version from `app/version.py` |

---

## ğŸ·ï¸ Blueprint Setup

```python
# Tag for grouping in Swagger UI
tag = Tag(
    name="Health (v1)",
    description="Health check and status endpoints - Version 1"
)

# Blueprint definition
main_bp_v1 = APIBlueprint(
    "main_v1",           # Unique name
    __name__,
    url_prefix="/",      # Root of v1 (becomes /api/v1/)
    abp_tags=[tag],      # All routes get this tag
)
```

**Key Points:**

-   `url_prefix="/"` means routes are at the root of v1
-   Combined with parent `/api/v1`, routes become `/api/v1/` and `/api/v1/health`

---

## ğŸ“Š Response Schemas

Pydantic schemas define the shape of responses for OpenAPI docs:

```python
class WelcomeDataResponse(StandardSuccessResponse):
    """Response schema for the welcome/root endpoint."""

    class WelcomeData(BaseModel):
        message: str = Field(
            ...,
            description="Welcome message",
            examples=["Welcome to Flask with PostgreSQL!"],
        )
        status: str = Field(
            ...,
            description="Application status",
            examples=["running"]
        )
        version: str = Field(
            ...,
            description="API version",
            examples=["1.0.0"]
        )
        api_version: str = Field(
            ...,
            description="API version number",
            examples=["v1"]
        )

    data: Optional[WelcomeData] = Field(..., description="Welcome data")


class HealthDataResponse(StandardSuccessResponse):
    """Response schema for health check endpoint."""

    class HealthData(BaseModel):
        status: str = Field(
            ...,
            description="Health status",
            examples=["healthy"]
        )
        database: str = Field(
            ...,
            description="Database connection status",
            examples=["connected"]
        )
        api_version: str = Field(
            ...,
            description="API version",
            examples=["v1"]
        )

    data: Optional[HealthData] = Field(..., description="Health check data")
```

---

## ğŸ”§ Root Endpoint

```python
@main_bp_v1.get(
    "/",
    summary="Root Endpoint",
    description="Returns a welcome message and basic API information for v1.",
    responses={
        200: WelcomeDataResponse,
    },
)
def index():
    """
    Root endpoint for API v1 - Welcome message.

    Returns:
        JSON response with welcome message and API status
    """
    return success_response(
        data={
            "message": "Welcome to Flask with PostgreSQL!",
            "status": "running",
            "version": __version__,
            "api_version": "v1",
        }
    )
```

### Request/Response Example

```
GET /api/v1/

Response 200:
{
    "success": true,
    "data": {
        "message": "Welcome to Flask with PostgreSQL!",
        "status": "running",
        "version": "1.0.0",
        "api_version": "v1"
    },
    "error": null,
    "meta": null
}
```

---

## ğŸ¥ Health Check Endpoint

```python
@main_bp_v1.get(
    "/health",
    summary="Health Check",
    description="Returns the health status of the API and database connection.",
    responses={
        200: HealthDataResponse,
    },
)
def health():
    """
    Health check endpoint for API v1.

    Actually verifies database connectivity by executing a simple query.

    Returns:
        JSON response indicating service health
    """
    from app import db

    # Actually check database connection
    try:
        db.session.execute(db.text("SELECT 1"))
        db_status = "connected"
    except Exception as e:
        logger.error(f"Database health check failed: {e}")
        db_status = "disconnected"

    return success_response(
        data={
            "status": "healthy" if db_status == "connected" else "degraded",
            "database": db_status,
            "api_version": "v1",
        }
    )
```

### Request/Response Examples

**Healthy State:**

```
GET /api/v1/health

Response 200:
{
    "success": true,
    "data": {
        "status": "healthy",
        "database": "connected",
        "api_version": "v1"
    },
    "error": null,
    "meta": null
}
```

**Degraded State (DB disconnected):**

```
GET /api/v1/health

Response 200:
{
    "success": true,
    "data": {
        "status": "degraded",
        "database": "disconnected",
        "api_version": "v1"
    },
    "error": null,
    "meta": null
}
```

---

## ğŸ“Š Health Check Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HEALTH CHECK FLOW                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   1. Request arrives: GET /api/v1/health                         â”‚
â”‚                                                                  â”‚
â”‚   2. Import db (lazy import to avoid circular)                   â”‚
â”‚      from app import db                                          â”‚
â”‚                                                                  â”‚
â”‚   3. Test database connection                                    â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚      â”‚  db.session.execute(text("SELECT 1"))â”‚                    â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚              â”‚                    â”‚                              â”‚
â”‚         Success               Exception                          â”‚
â”‚              â”‚                    â”‚                              â”‚
â”‚              â–¼                    â–¼                              â”‚
â”‚      db_status = "connected"    db_status = "disconnected"       â”‚
â”‚      status = "healthy"         status = "degraded"              â”‚
â”‚                                 + log error                      â”‚
â”‚                                                                  â”‚
â”‚   4. Return standardized response                                â”‚
â”‚      {                                                           â”‚
â”‚        "success": true,                                          â”‚
â”‚        "data": {                                                 â”‚
â”‚          "status": "healthy|degraded",                           â”‚
â”‚          "database": "connected|disconnected",                   â”‚
â”‚          "api_version": "v1"                                     â”‚
â”‚        },                                                        â”‚
â”‚        "error": null,                                            â”‚
â”‚        "meta": null                                              â”‚
â”‚      }                                                           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Health Check Best Practices

### 1. Keep It Fast

Health checks are called frequently. Keep them lightweight:

```python
# âœ… GOOD - Simple query
db.session.execute(db.text("SELECT 1"))

# âŒ BAD - Complex query
db.session.execute(db.text("SELECT COUNT(*) FROM large_table"))
```

### 2. Check Critical Dependencies

```python
# Extended health check (example)
def health():
    checks = {
        "database": check_database(),
        "redis": check_redis(),
        "external_api": check_external_api(),
    }

    all_healthy = all(v == "connected" for v in checks.values())

    return success_response(data={
        "status": "healthy" if all_healthy else "degraded",
        **checks,
    })
```

### 3. Don't Expose Sensitive Info

```python
# âŒ BAD - Exposes connection string
"database_url": os.environ.get("DATABASE_URL")

# âœ… GOOD - Just status
"database": "connected"
```

---

## ğŸ”§ Use Cases

### Kubernetes Liveness/Readiness Probes

```yaml
# kubernetes deployment.yaml
livenessProbe:
    httpGet:
        path: /api/v1/health
        port: 5000
    initialDelaySeconds: 30
    periodSeconds: 10

readinessProbe:
    httpGet:
        path: /api/v1/health
        port: 5000
    initialDelaySeconds: 5
    periodSeconds: 5
```

### Load Balancer Health Check

```nginx
# nginx.conf
upstream backend {
    server app1:5000;
    server app2:5000;

    check interval=3000 rise=2 fall=3 timeout=1000 type=http;
    check_http_send "GET /api/v1/health HTTP/1.0\r\n\r\n";
    check_http_expect_alive http_2xx;
}
```

---

## ğŸ”œ Next Steps

Now let's dive into the user routes.

**Next: [4.6_user_routes.md](./4.6_user_routes.md)** - users.py deep dive.
