# ğŸ‘¥ User Routes Deep Dive

> **CRUD Operations for Users**

---

## ğŸ“‹ Overview

The user routes provide full CRUD operations for managing users. This file demonstrates our layered architecture:

```
Route (HTTP handling) â†’ Service (Business logic) â†’ Model (Data)
```

---

## ğŸ“ File Location

```
app/routes/v1/users.py
```

---

## ğŸ“Š Endpoints Summary

| Method | Endpoint             | Description      | Auth Required |
| ------ | -------------------- | ---------------- | ------------- |
| GET    | `/api/v1/users/`     | List all users   | No            |
| GET    | `/api/v1/users/{id}` | Get single user  | No            |
| PUT    | `/api/v1/users/{id}` | Update user      | âœ… Yes        |
| DELETE | `/api/v1/users/{id}` | Soft delete user | âœ… Yes        |

**Note:** Registration and login are in `/api/v1/auth/` routes.

---

## ğŸ·ï¸ Blueprint Setup

```python
from flask_openapi3 import APIBlueprint, Tag

# Tag for Swagger UI grouping
tag = Tag(
    name="Users (v1)",
    description="User management - CRUD operations for users - Version 1",
)

# Blueprint with resource prefix
users_bp_v1 = APIBlueprint(
    "users_v1",          # Unique name
    __name__,
    url_prefix="/users", # Added to /api/v1
    abp_tags=[tag],
)
```

---

## ğŸ“Š Parameter Schemas

### Path Parameters

```python
class UserPath(BaseModel):
    """Path parameters for user-specific endpoints."""

    user_id: int = Field(
        ...,              # Required
        description="User ID",
        ge=1,             # Greater than or equal to 1
    )
```

Used in routes like `/users/{user_id}`:

```python
@users_bp_v1.get("/<int:user_id>")
def get_user(path: UserPath):
    user_id = path.user_id  # Validated integer â‰¥ 1
```

### Query Parameters

```python
class UserListQuery(BaseModel):
    """Query parameters for listing users."""

    page: int = Field(
        default=1,        # Default value
        ge=1,             # â‰¥ 1
        description="Page number (1-indexed)"
    )
    per_page: int = Field(
        default=20,
        ge=1,             # â‰¥ 1
        le=100,           # â‰¤ 100
        description="Items per page (max 100)"
    )
    include_deleted: bool = Field(
        default=False,
        description="Include soft-deleted users"
    )
```

Used in routes:

```python
@users_bp_v1.get("/")
def get_users(query: UserListQuery):
    # query.page, query.per_page are validated
    users, total = UserService.get_all(
        page=query.page,
        per_page=query.per_page,
    )
```

---

## ğŸ“ Route: Get All Users

```python
@users_bp_v1.get(
    "/",
    summary="Get All Users",
    description="Retrieves a paginated list of all users in the system.",
    responses={
        200: UsersListResponse,
    },
)
def get_users(query: UserListQuery):
    """Get all users with pagination."""

    # 1. Call service layer
    users, total = UserService.get_all(
        include_deleted=query.include_deleted,
        page=query.page,
        per_page=query.per_page,
    )

    # 2. Convert to response schema
    users_data = [
        UserResponseSchema.model_validate(user).to_dict()
        for user in users
    ]

    # 3. Calculate pagination
    total_pages = (total + query.per_page - 1) // query.per_page

    # 4. Return standardized response
    return success_response(
        data=users_data,
        meta={
            "count": len(users_data),
            "total": total,
            "page": query.page,
            "per_page": query.per_page,
            "total_pages": total_pages,
            "api_version": "v1",
        },
    )
```

### Example Request/Response

```
GET /api/v1/users/?page=1&per_page=2

Response 200:
{
    "success": true,
    "data": [
        {
            "id": 1,
            "username": "john_doe",
            "email": "john@example.com",
            "first_name": "John",
            "is_active": true,
            ...
        },
        {
            "id": 2,
            "username": "jane_smith",
            ...
        }
    ],
    "error": null,
    "meta": {
        "count": 2,
        "total": 15,
        "page": 1,
        "per_page": 2,
        "total_pages": 8,
        "api_version": "v1"
    }
}
```

---

## ğŸ“ Route: Get Single User

```python
@users_bp_v1.get(
    "/<int:user_id>",
    summary="Get User by ID",
    description="Retrieves a specific user by their ID.",
    responses={
        200: UserDataResponse,
        404: StandardErrorResponse,
    },
)
def get_user(path: UserPath):
    """Get a specific user by ID."""
    try:
        # Service layer handles the lookup
        user = UserService.get_by_id_or_404(path.user_id)

        # Convert to response schema
        response_data = UserResponseSchema.model_validate(user)
        return success_response(data=response_data.to_dict())

    except UserNotFoundError:
        return error_response(
            code=ErrorCode.RESOURCE_NOT_FOUND,
            message=f"User with id={path.user_id} not found",
            status_code=404,
        )
```

### Example Responses

**Success:**

```
GET /api/v1/users/1

Response 200:
{
    "success": true,
    "data": {
        "id": 1,
        "username": "john_doe",
        "email": "john@example.com",
        ...
    },
    "error": null,
    "meta": null
}
```

**Not Found:**

```
GET /api/v1/users/99999

Response 404:
{
    "success": false,
    "data": null,
    "error": {
        "code": "RESOURCE_NOT_FOUND",
        "message": "User with id=99999 not found"
    },
    "meta": null
}
```

---

## ğŸ“ Route: Update User (Protected)

```python
@users_bp_v1.put(
    "/<int:user_id>",
    summary="Update User",
    description="""
Updates an existing user's profile.

**Partial Update:** Only fields provided in the request body will be updated.
    """,
    responses={
        200: UserDataResponse,
        404: StandardErrorResponse,
        422: StandardErrorResponse,
    },
    security=[{"jwt": []}],  # ğŸ”’ Requires JWT
)
@jwt_required()  # ğŸ”’ Decorator enforces auth
def update_user(path: UserPath, body: UserUpdateSchema):
    """Update an existing user."""
    try:
        user = UserService.update_user(path.user_id, body)
        response_data = UserResponseSchema.model_validate(user)
        return success_response(
            data=response_data.to_dict(),
            message="User updated successfully",
        )
    except UserNotFoundError:
        return error_response(
            code=ErrorCode.RESOURCE_NOT_FOUND,
            message=f"User with id={path.user_id} not found",
            status_code=404,
        )
```

### Two Levels of Authentication

1. **`security=[{"jwt": []}]`** - Tells OpenAPI docs this needs auth (shows lock icon)
2. **`@jwt_required()`** - Actually enforces auth at runtime

### Example Request

```
PUT /api/v1/users/1
Authorization: Bearer <access_token>
Content-Type: application/json

{
    "first_name": "John Updated",
    "bio": "New bio text"
}

Response 200:
{
    "success": true,
    "data": {
        "message": "User updated successfully",
        "id": 1,
        "username": "john_doe",
        "first_name": "John Updated",
        "bio": "New bio text",
        ...
    },
    "error": null,
    "meta": null
}
```

---

## ğŸ“ Route: Delete User (Protected)

```python
@users_bp_v1.delete(
    "/<int:user_id>",
    summary="Delete User",
    description="""
Soft-deletes a user by setting is_deleted=True.

The user record remains in the database but is marked as deleted.
    """,
    responses={
        200: MessageResponse,
        404: StandardErrorResponse,
    },
    security=[{"jwt": []}],
)
@jwt_required()
def delete_user(path: UserPath):
    """Delete a user (soft delete)."""
    try:
        UserService.soft_delete(path.user_id)
        return success_response(
            message=f"User {path.user_id} deleted successfully"
        )
    except UserNotFoundError:
        return error_response(
            code=ErrorCode.RESOURCE_NOT_FOUND,
            message=f"User with id={path.user_id} not found",
            status_code=404,
        )
```

### Example

```
DELETE /api/v1/users/1
Authorization: Bearer <access_token>

Response 200:
{
    "success": true,
    "data": {
        "message": "User 1 deleted successfully"
    },
    "error": null,
    "meta": null
}
```

---

## ğŸ“Š Request Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UPDATE USER FLOW                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   PUT /api/v1/users/1                                            â”‚
â”‚   Authorization: Bearer <token>                                  â”‚
â”‚   Body: {"first_name": "New Name"}                               â”‚
â”‚                                                                  â”‚
â”‚   1. JWT Validation                                              â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚      â”‚  @jwt_required()                    â”‚                     â”‚
â”‚      â”‚  - Verify token validity            â”‚                     â”‚
â”‚      â”‚  - Check not expired                â”‚                     â”‚
â”‚      â”‚  - Check not blacklisted            â”‚                     â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚              â”‚ Valid                    â”‚ Invalid                â”‚
â”‚              â–¼                          â–¼                        â”‚
â”‚        Continue               401 Unauthorized                   â”‚
â”‚                                                                  â”‚
â”‚   2. Parameter Validation                                        â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚      â”‚  path: UserPath (user_id >= 1)      â”‚                     â”‚
â”‚      â”‚  body: UserUpdateSchema             â”‚                     â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚              â”‚ Valid                    â”‚ Invalid                â”‚
â”‚              â–¼                          â–¼                        â”‚
â”‚        Continue               422 Validation Error               â”‚
â”‚                                                                  â”‚
â”‚   3. Service Layer                                               â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚      â”‚  UserService.update_user(id, body)  â”‚                     â”‚
â”‚      â”‚  - Find user                        â”‚                     â”‚
â”‚      â”‚  - Update fields                    â”‚                     â”‚
â”‚      â”‚  - Commit to DB                     â”‚                     â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚              â”‚ Found                    â”‚ Not Found              â”‚
â”‚              â–¼                          â–¼                        â”‚
â”‚        Updated User           404 Not Found                      â”‚
â”‚                                                                  â”‚
â”‚   4. Response                                                    â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚      â”‚  success_response(data=user)        â”‚                     â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ†š Comparison with Express.js

### Express.js Controller

```javascript
router.get("/users", async (req, res, next) => {
    try {
        const { page = 1, per_page = 20 } = req.query;
        const users = await UserService.getAll(page, per_page);
        res.json({ success: true, data: users });
    } catch (error) {
        next(error);
    }
});

router.put("/users/:id", authenticate, async (req, res, next) => {
    try {
        const user = await UserService.update(req.params.id, req.body);
        res.json({ success: true, data: user });
    } catch (error) {
        next(error);
    }
});
```

### Flask Route

```python
@users_bp_v1.get("/")
def get_users(query: UserListQuery):  # Auto-validated
    users, total = UserService.get_all(page=query.page, per_page=query.per_page)
    return success_response(data=users)

@users_bp_v1.put("/<int:user_id>")
@jwt_required()  # authenticate equivalent
def update_user(path: UserPath, body: UserUpdateSchema):  # Auto-validated
    user = UserService.update_user(path.user_id, body)
    return success_response(data=user)
```

Same pattern, more concise with automatic validation!

---

## ğŸ”œ Next Steps

Now let's understand Pydantic and validation.

**Next: [4.7_pydantic_overview.md](./4.7_pydantic_overview.md)** - Pydantic vs Joi/Zod.
