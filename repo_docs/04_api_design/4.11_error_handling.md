# ‚ö†Ô∏è Error Handling

> **Centralized Error Handlers**

---

## üìã Overview

Flask provides a way to handle errors globally using **error handlers**. This ensures all errors return consistent, standardized responses.

---

## üìÅ File Location

```
app/utils/error_handlers.py
```

---

## üìä Error Handling Strategy

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    ERROR HANDLING FLOW                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ   Request Processing                                             ‚îÇ
‚îÇ   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                             ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ   try:                                                           ‚îÇ
‚îÇ       Route handler executes                                     ‚îÇ
‚îÇ   except:                                                        ‚îÇ
‚îÇ       ‚îÇ                                                          ‚îÇ
‚îÇ       ‚ñº                                                          ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                            ‚îÇ
‚îÇ   ‚îÇ     Error Handlers Check        ‚îÇ                            ‚îÇ
‚îÇ   ‚îÇ                                 ‚îÇ                            ‚îÇ
‚îÇ   ‚îÇ  1. Pydantic ValidationError?   ‚îÇ                            ‚îÇ
‚îÇ   ‚îÇ  2. HTTP Exception (404, etc.)? ‚îÇ                            ‚îÇ
‚îÇ   ‚îÇ  3. SQLAlchemy Exception?       ‚îÇ                            ‚îÇ
‚îÇ   ‚îÇ  4. Service Exception?          ‚îÇ                            ‚îÇ
‚îÇ   ‚îÇ  5. Generic Exception?          ‚îÇ                            ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                            ‚îÇ
‚îÇ       ‚îÇ                                                          ‚îÇ
‚îÇ       ‚ñº                                                          ‚îÇ
‚îÇ   Standardized Error Response                                    ‚îÇ
‚îÇ   {                                                              ‚îÇ
‚îÇ       "success": false,                                          ‚îÇ
‚îÇ       "data": null,                                              ‚îÇ
‚îÇ       "error": {...},                                            ‚îÇ
‚îÇ       "meta": null                                               ‚îÇ
‚îÇ   }                                                              ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîß Registering Error Handlers

```python
# app/utils/error_handlers.py

def register_error_handlers(app):
    """Register all error handlers with the Flask app."""

    @app.errorhandler(ValidationError)
    def handle_validation_error(error):
        # Handle Pydantic validation errors
        ...

    @app.errorhandler(404)
    def handle_not_found(error):
        # Handle 404 errors
        ...

    @app.errorhandler(Exception)
    def handle_generic_error(error):
        # Catch-all for unhandled exceptions
        ...
```

Called in app factory:

```python
# app/__init__.py
def create_app(config_name="default"):
    app = OpenAPI(__name__, info=info)

    # ... other setup ...

    # Register error handlers
    from app.utils.error_handlers import register_error_handlers
    register_error_handlers(app)

    return app
```

---

## üìù Error Handler Examples

### HTTP Not Found (404)

```python
@app.errorhandler(404)
def handle_not_found(error):
    """Handle 404 Not Found errors."""
    return error_response(
        code=ErrorCode.NOT_FOUND,
        message="The requested resource was not found",
        status_code=404,
    )
```

### HTTP Method Not Allowed (405)

```python
@app.errorhandler(405)
def handle_method_not_allowed(error):
    """Handle 405 Method Not Allowed errors."""
    return error_response(
        code=ErrorCode.METHOD_NOT_ALLOWED,
        message="The method is not allowed for this resource",
        status_code=405,
    )
```

### Pydantic Validation Error

```python
from pydantic import ValidationError

@app.errorhandler(ValidationError)
def handle_pydantic_validation_error(error: ValidationError):
    """Handle Pydantic validation errors."""

    # Convert Pydantic errors to our format
    details = {}
    for err in error.errors():
        field = ".".join(str(loc) for loc in err["loc"])
        message = err["msg"]

        if field in details:
            if isinstance(details[field], list):
                details[field].append(message)
            else:
                details[field] = [details[field], message]
        else:
            details[field] = message

    return error_response(
        code=ErrorCode.VALIDATION_ERROR,
        message="Validation failed",
        details=details,
        status_code=422,
    )
```

### SQLAlchemy Integrity Error

```python
from sqlalchemy.exc import IntegrityError

@app.errorhandler(IntegrityError)
def handle_integrity_error(error: IntegrityError):
    """Handle database integrity errors (duplicates, etc.)."""

    error_msg = str(error.orig).lower()

    if "duplicate" in error_msg or "unique" in error_msg:
        return error_response(
            code=ErrorCode.RESOURCE_ALREADY_EXISTS,
            message="A resource with this value already exists",
            status_code=409,
        )

    return error_response(
        code=ErrorCode.DATABASE_ERROR,
        message="Database constraint violated",
        status_code=400,
    )
```

### Database Connection Error

```python
from sqlalchemy.exc import OperationalError

@app.errorhandler(OperationalError)
def handle_operational_error(error: OperationalError):
    """Handle database connection errors."""

    logger.error(f"Database operational error: {error}")

    return error_response(
        code=ErrorCode.DATABASE_ERROR,
        message="Database is temporarily unavailable",
        status_code=503,
    )
```

### Rate Limit Exceeded

```python
@app.errorhandler(429)
def handle_rate_limit(error):
    """Handle rate limit exceeded errors."""
    return error_response(
        code=ErrorCode.RATE_LIMIT_EXCEEDED,
        message="Too many requests. Please slow down.",
        status_code=429,
    )
```

### Generic Exception (Catch-All)

```python
@app.errorhandler(Exception)
def handle_generic_exception(error: Exception):
    """Catch-all handler for unhandled exceptions."""

    # Log the full error for debugging
    logger.exception(f"Unhandled exception: {error}")

    # Don't expose internal details in production
    if app.config.get("DEBUG"):
        message = str(error)
    else:
        message = "An internal error occurred"

    return error_response(
        code=ErrorCode.INTERNAL_ERROR,
        message=message,
        status_code=500,
    )
```

---

## üìä Error Handler Priority

Error handlers are matched most-specific to least-specific:

```
1. @errorhandler(SpecificException)  ‚Üê Checked first
2. @errorhandler(ParentException)
3. @errorhandler(Exception)          ‚Üê Catch-all (last resort)
```

Example:

```python
# More specific - checked first
@app.errorhandler(IntegrityError)
def handle_integrity(error):
    ...

# Less specific - parent class
@app.errorhandler(SQLAlchemyError)
def handle_sqlalchemy(error):
    ...

# Least specific - catch-all
@app.errorhandler(Exception)
def handle_generic(error):
    ...
```

---

## üÜö Comparison with Express.js

### Express.js Error Middleware

```javascript
// Error handling middleware (must have 4 parameters)
app.use((err, req, res, next) => {
    console.error(err.stack);

    if (err instanceof ValidationError) {
        return res.status(422).json({
            success: false,
            error: { code: "VALIDATION_ERROR", message: err.message },
        });
    }

    res.status(500).json({
        success: false,
        error: { code: "INTERNAL_ERROR", message: "Something went wrong" },
    });
});
```

### Flask Error Handlers

```python
@app.errorhandler(ValidationError)
def handle_validation(error):
    return error_response(
        code=ErrorCode.VALIDATION_ERROR,
        message="Validation failed",
        status_code=422,
    )

@app.errorhandler(Exception)
def handle_generic(error):
    return error_response(
        code=ErrorCode.INTERNAL_ERROR,
        message="Something went wrong",
        status_code=500,
    )
```

Key difference: Flask uses decorator-based registration instead of middleware chains.

---

## üîß Custom Service Exceptions

Define custom exceptions for service layer:

```python
# app/services/exceptions.py

class ServiceError(Exception):
    """Base exception for service layer."""
    pass

class UserNotFoundError(ServiceError):
    """Raised when a user is not found."""
    pass

class UserAlreadyExistsError(ServiceError):
    """Raised when a user already exists."""
    pass
```

Register handlers:

```python
@app.errorhandler(UserNotFoundError)
def handle_user_not_found(error):
    return error_response(
        code=ErrorCode.RESOURCE_NOT_FOUND,
        message=str(error) or "User not found",
        status_code=404,
    )

@app.errorhandler(UserAlreadyExistsError)
def handle_user_exists(error):
    return error_response(
        code=ErrorCode.RESOURCE_ALREADY_EXISTS,
        message=str(error) or "User already exists",
        status_code=409,
    )
```

---

## üìä Complete Error Response Examples

### 404 Not Found

```json
{
    "success": false,
    "data": null,
    "error": {
        "code": "NOT_FOUND",
        "message": "The requested resource was not found"
    },
    "meta": null
}
```

### 422 Validation Error

```json
{
    "success": false,
    "data": null,
    "error": {
        "code": "VALIDATION_ERROR",
        "message": "Validation failed",
        "details": {
            "email": "Invalid email format",
            "password": "Must be at least 8 characters"
        }
    },
    "meta": null
}
```

### 409 Conflict

```json
{
    "success": false,
    "data": null,
    "error": {
        "code": "RESOURCE_ALREADY_EXISTS",
        "message": "Username already exists"
    },
    "meta": null
}
```

### 500 Internal Error

```json
{
    "success": false,
    "data": null,
    "error": {
        "code": "INTERNAL_ERROR",
        "message": "An internal error occurred"
    },
    "meta": null
}
```

---

## ‚ö†Ô∏è Best Practices

### 1. Never Expose Internal Details in Production

```python
@app.errorhandler(Exception)
def handle_generic(error):
    if app.config.get("DEBUG"):
        # Development: show details
        message = str(error)
    else:
        # Production: hide details
        message = "An internal error occurred"

    return error_response(
        code=ErrorCode.INTERNAL_ERROR,
        message=message,
        status_code=500,
    )
```

### 2. Always Log Errors

```python
@app.errorhandler(Exception)
def handle_generic(error):
    # Log with full traceback
    logger.exception(f"Unhandled: {error}")

    return error_response(...)
```

### 3. Use Specific Error Codes

```python
# ‚ùå BAD - Generic
code=ErrorCode.BAD_REQUEST

# ‚úÖ GOOD - Specific
code=ErrorCode.RESOURCE_NOT_FOUND
code=ErrorCode.VALIDATION_ERROR
code=ErrorCode.RESOURCE_ALREADY_EXISTS
```

---

## üéâ Section Complete!

You've completed the **04_api_design** section! You now understand:

1. ‚úÖ REST API principles
2. ‚úÖ OpenAPI and Swagger with flask-openapi3
3. ‚úÖ Route structure and organization
4. ‚úÖ API versioning strategy
5. ‚úÖ Health check routes
6. ‚úÖ User CRUD routes
7. ‚úÖ Pydantic for validation
8. ‚úÖ Our schemas folder
9. ‚úÖ Request validation flow
10. ‚úÖ Standardized response format
11. ‚úÖ Centralized error handling

---

## üîú Next Section

Ready to learn about authentication? Let's go!

**Next: [../05_authentication/5.1_auth_overview.md](../05_authentication/5.1_auth_overview.md)** - Authentication overview.
