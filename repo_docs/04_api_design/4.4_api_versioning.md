# ğŸ”¢ API Versioning

> **URL-Based Versioning Strategy**

---

## ğŸ“‹ What is API Versioning?

API versioning allows you to make breaking changes without affecting existing clients. When you release a new version, old clients continue using the old API.

---

## ğŸ“Š Versioning Strategies

### 1. URL Path Versioning (Our Choice) âœ…

```
GET /api/v1/users
GET /api/v2/users
```

**Pros:**

-   Explicit and visible
-   Easy to understand and debug
-   Works with all HTTP clients
-   Can be easily cached

**Cons:**

-   URLs change between versions
-   More routes to maintain

### 2. Header Versioning

```
GET /api/users
Accept: application/vnd.myapi.v1+json
```

**Pros:**

-   Clean URLs

**Cons:**

-   Hidden from users
-   Harder to debug
-   Browser testing is difficult

### 3. Query Parameter Versioning

```
GET /api/users?version=1
```

**Pros:**

-   Simple implementation

**Cons:**

-   Not RESTful (version isn't a resource property)
-   Easy to forget

---

## ğŸ”§ Our Implementation

### Parent Blueprint (Version Prefix)

```python
# app/routes/v1/__init__.py

api_v1 = APIBlueprint(
    "api_v1",
    __name__,
    url_prefix="/api/v1",  # Version defined ONCE here!
)

api_v1.register_api(auth_bp_v1)   # /api/v1/auth/*
api_v1.register_api(users_bp_v1) # /api/v1/users/*
api_v1.register_api(main_bp_v1)  # /api/v1/*
```

### Child Blueprints (Resource Prefix Only)

```python
# app/routes/v1/users.py

users_bp_v1 = APIBlueprint(
    "users_v1",
    __name__,
    url_prefix="/users",  # Just the resource name
    abp_tags=[tag],
)
```

---

## ğŸ“Š How Prefixes Combine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    URL COMPOSITION                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Parent Blueprint:           /api/v1                            â”‚
â”‚   Child Blueprint:            /users                             â”‚
â”‚   Route:                      /<int:user_id>                     â”‚
â”‚                              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚   Final URL:                  /api/v1/users/<int:user_id>        â”‚
â”‚                                                                  â”‚
â”‚   Example Request:            GET /api/v1/users/123              â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ†š Comparison with Express.js

### Express.js Versioning

```javascript
// routes/v1/index.js
const v1Router = express.Router();
v1Router.use("/users", usersRouter);

// routes/v2/index.js
const v2Router = express.Router();
v2Router.use("/users", usersV2Router); // New implementation

// app.js
app.use("/api/v1", v1Router);
app.use("/api/v2", v2Router);
```

### Flask Versioning

```python
# app/routes/v1/__init__.py
api_v1 = APIBlueprint("api_v1", __name__, url_prefix="/api/v1")
api_v1.register_api(users_bp_v1)

# app/routes/v2/__init__.py (future)
api_v2 = APIBlueprint("api_v2", __name__, url_prefix="/api/v2")
api_v2.register_api(users_bp_v2)

# app/__init__.py
app.register_api(api_v1)
app.register_api(api_v2)
```

Same pattern!

---

## ğŸ“ Future v2 Structure

When we need version 2:

```
app/routes/
â”œâ”€â”€ v1/
â”‚   â”œâ”€â”€ __init__.py      # api_v1 blueprint
â”‚   â”œâ”€â”€ main.py
â”‚   â””â”€â”€ users.py         # v1 users logic
â””â”€â”€ v2/
    â”œâ”€â”€ __init__.py      # api_v2 blueprint
    â”œâ”€â”€ main.py
    â””â”€â”€ users.py         # v2 users logic (new/improved)
```

---

## ğŸ“Š When to Create a New Version

Create a new version when you make **breaking changes**:

| Change Type                      | Breaking? | New Version? |
| -------------------------------- | --------- | ------------ |
| Add new endpoint                 | No        | âŒ No        |
| Add optional field to response   | No        | âŒ No        |
| Add optional query parameter     | No        | âŒ No        |
| **Remove endpoint**              | **Yes**   | **âœ… Yes**   |
| **Remove response field**        | **Yes**   | **âœ… Yes**   |
| **Change field type**            | **Yes**   | **âœ… Yes**   |
| **Make optional field required** | **Yes**   | **âœ… Yes**   |
| **Change URL structure**         | **Yes**   | **âœ… Yes**   |

---

## ğŸ”§ Deprecation Strategy

When introducing v2, don't immediately remove v1:

```python
# app/__init__.py

def create_app(config_name="default"):
    app = OpenAPI(__name__, info=info)

    # Register both versions
    app.register_api(api_v1)  # Still available
    app.register_api(api_v2)  # New version

    return app
```

### Deprecation Header

Add a warning header to v1 endpoints:

```python
# app/routes/v1/users.py

@users_bp_v1.get("/")
def get_users():
    response, status = success_response(data=users)
    response.headers['Deprecation'] = 'true'
    response.headers['Sunset'] = 'Sat, 01 Jan 2026 00:00:00 GMT'
    return response, status
```

---

## ğŸ“Š Version Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VERSION LIFECYCLE                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Timeline:                                                      â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                  â”‚
â”‚   â–¼ v1 Release (Day 0)                                           â”‚
â”‚   â”‚   - v1 is current, stable                                    â”‚
â”‚   â”‚   - All clients use v1                                       â”‚
â”‚   â”‚                                                              â”‚
â”‚   â”‚ v2 Development (Months later)                                â”‚
â”‚   â”‚   - v2 being built with breaking changes                     â”‚
â”‚   â”‚   - v1 still current, stable                                 â”‚
â”‚   â”‚                                                              â”‚
â”‚   â–¼ v2 Release                                                   â”‚
â”‚   â”‚   - v1 deprecated (still works!)                             â”‚
â”‚   â”‚   - v2 is current, stable                                    â”‚
â”‚   â”‚   - Clients encouraged to migrate                            â”‚
â”‚   â”‚   - Deprecation headers on v1                                â”‚
â”‚   â”‚                                                              â”‚
â”‚   â”‚ Migration Period (6-12 months)                               â”‚
â”‚   â”‚   - v1 monitored for usage                                   â”‚
â”‚   â”‚   - v2 stable, receiving updates                             â”‚
â”‚   â”‚                                                              â”‚
â”‚   â–¼ v1 Sunset                                                    â”‚
â”‚       - v1 removed (or returns 410 Gone)                         â”‚
â”‚       - v2 is only version                                       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ Best Practices

### 1. Version in Response (Optional)

Include API version in responses:

```python
return success_response(
    data=users_data,
    meta={
        "api_version": "v1",
        # ...
    }
)
```

### 2. Clear Documentation

Document which version is current:

```markdown
## API Versions

| Version | Status      | End of Life |
| ------- | ----------- | ----------- |
| v1      | Deprecated  | 2026-01-01  |
| v2      | **Current** | -           |
```

### 3. Version-Specific Tests

```python
# tests/test_routes/test_v1_users.py
def test_v1_get_users(client):
    response = client.get('/api/v1/users/')
    assert response.status_code == 200

# tests/test_routes/test_v2_users.py
def test_v2_get_users(client):
    response = client.get('/api/v2/users/')
    assert response.status_code == 200
```

---

## ğŸ”œ Next Steps

Let's look at our main routes in detail.

**Next: [4.5_main_routes.md](./4.5_main_routes.md)** - main.py explained.
