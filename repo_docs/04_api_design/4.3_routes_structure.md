# ğŸ“ Routes Structure

> **How Our API Routes Are Organized**

---

## ğŸ“‹ Overview

Our routes follow a modular structure that mirrors Express.js nested routers, making the codebase easy to navigate and maintain.

---

## ğŸ“ Directory Structure

```
app/
â”œâ”€â”€ __init__.py              # App factory, registers api_v1
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ __init__.py          # Empty (routes loaded via blueprints)
â”‚   â”œâ”€â”€ v1/
â”‚   â”‚   â”œâ”€â”€ __init__.py      # Parent blueprint for v1
â”‚   â”‚   â”œâ”€â”€ auth.py          # Auth routes (login, register)
â”‚   â”‚   â”œâ”€â”€ main.py          # Health/status routes
â”‚   â”‚   â””â”€â”€ users.py         # User CRUD routes
â”‚   â””â”€â”€ web.py               # Non-API routes (landing page)
â”œâ”€â”€ auth/
â”‚   â””â”€â”€ __init__.py          # JWT configuration (NOT routes)
â””â”€â”€ templates/
    â””â”€â”€ index.html           # Landing page HTML
```

---

## ğŸ”— Blueprint Hierarchy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BLUEPRINT HIERARCHY                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   OpenAPI App (app/__init__.py)                                  â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”œâ”€â”€ api_v1 (app/routes/v1/__init__.py)                     â”‚
â”‚       â”‚   url_prefix="/api/v1"                                   â”‚
â”‚       â”‚       â”‚                                                  â”‚
â”‚       â”‚       â”œâ”€â”€ auth_bp_v1 â†’ /api/v1/auth/*                    â”‚
â”‚       â”‚       â”œâ”€â”€ users_bp_v1 â†’ /api/v1/users/*                  â”‚
â”‚       â”‚       â””â”€â”€ main_bp_v1 â†’ /api/v1/ and /api/v1/health       â”‚
â”‚       â”‚                                                          â”‚
â”‚       â””â”€â”€ web_bp (app/routes/web.py)                             â”‚
â”‚           url_prefix=""                                          â”‚
â”‚           â””â”€â”€ / â†’ Landing page (HTML)                            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Final URL Mapping

| Blueprint     | Prefix    | Route            | Final URL               |
| ------------- | --------- | ---------------- | ----------------------- |
| `api_v1`      | `/api/v1` | -                | -                       |
| `main_bp_v1`  | `/`       | `/`              | `/api/v1/`              |
| `main_bp_v1`  | `/`       | `/health`        | `/api/v1/health`        |
| `auth_bp_v1`  | `/auth`   | `/register`      | `/api/v1/auth/register` |
| `auth_bp_v1`  | `/auth`   | `/login`         | `/api/v1/auth/login`    |
| `users_bp_v1` | `/users`  | `/`              | `/api/v1/users/`        |
| `users_bp_v1` | `/users`  | `/<int:user_id>` | `/api/v1/users/123`     |
| `web_bp`      | (none)    | `/`              | `/`                     |

---

## ğŸ†š Comparison with Express.js

### Express.js Nested Routers

```javascript
// routes/v1/index.js
const v1Router = express.Router();
v1Router.use("/", mainRouter);
v1Router.use("/auth", authRouter);
v1Router.use("/users", usersRouter);

// app.js
app.use("/api/v1", v1Router);
```

### Flask Nested Blueprints

```python
# app/routes/v1/__init__.py
api_v1 = APIBlueprint("api_v1", __name__, url_prefix="/api/v1")
api_v1.register_api(main_bp_v1)   # /api/v1/*
api_v1.register_api(auth_bp_v1)   # /api/v1/auth/*
api_v1.register_api(users_bp_v1)  # /api/v1/users/*

# app/__init__.py
app.register_api(api_v1)
```

Same concept, different syntax!

---

## ğŸ“ Key Files Explained

### 1. `app/routes/v1/__init__.py` - Parent Blueprint

This file creates the parent blueprint and registers all child blueprints:

```python
"""API Version 1 Routes Package."""

from flask_openapi3 import APIBlueprint

from app.routes.v1.auth import auth_bp_v1
from app.routes.v1.main import main_bp_v1
from app.routes.v1.users import users_bp_v1

# Parent blueprint - version prefix defined ONCE here!
api_v1 = APIBlueprint(
    "api_v1",
    __name__,
    url_prefix="/api/v1",
)

# Register child blueprints
api_v1.register_api(auth_bp_v1)   # â†’ /api/v1/auth/*
api_v1.register_api(users_bp_v1) # â†’ /api/v1/users/*
api_v1.register_api(main_bp_v1)  # â†’ /api/v1/*

__all__ = ["api_v1"]
```

### 2. `app/__init__.py` - App Factory

Registers the parent blueprint with the app:

```python
from app.routes.v1 import api_v1

def create_app(config_name="default"):
    app = OpenAPI(__name__, info=info)

    # ... configuration ...

    # Register the entire v1 API
    app.register_api(api_v1)

    return app
```

### 3. Individual Route Modules

Each module defines its own blueprint with a resource prefix:

```python
# app/routes/v1/users.py
users_bp_v1 = APIBlueprint(
    "users_v1",
    __name__,
    url_prefix="/users",  # Just resource name
    abp_tags=[tag],
)

@users_bp_v1.get("/")
def get_users():
    # Handles GET /api/v1/users/
    pass

@users_bp_v1.get("/<int:user_id>")
def get_user(path: UserPath):
    # Handles GET /api/v1/users/123
    pass
```

---

## ğŸ“Š Route Files Overview

### `main.py` - Health Routes

```python
# GET /api/v1/         â†’ Welcome message
# GET /api/v1/health   â†’ Health check with DB status
```

### `users.py` - User CRUD

```python
# GET    /api/v1/users/         â†’ List all users (paginated)
# GET    /api/v1/users/{id}     â†’ Get single user
# PUT    /api/v1/users/{id}     â†’ Update user (auth required)
# DELETE /api/v1/users/{id}     â†’ Soft delete (auth required)
```

### `routes/v1/auth.py` - Authentication

```python
# POST /api/v1/auth/register   â†’ Create new account
# POST /api/v1/auth/login      â†’ Get access/refresh tokens
# POST /api/v1/auth/refresh    â†’ Get new access token
# POST /api/v1/auth/logout     â†’ Invalidate token
# GET  /api/v1/auth/me         â†’ Get current user info
```

### `web.py` - Non-API Routes

```python
# GET / â†’ HTML landing page
```

---

## ğŸ”§ Adding a New Route Module

To add a new resource (e.g., Posts):

### Step 1: Create Route File

```python
# app/routes/v1/posts.py
from flask_openapi3 import APIBlueprint, Tag

tag = Tag(name="Posts (v1)", description="Post management")

posts_bp_v1 = APIBlueprint(
    "posts_v1",
    __name__,
    url_prefix="/posts",
    abp_tags=[tag],
)

@posts_bp_v1.get("/")
def get_posts():
    return success_response(data=[])

@posts_bp_v1.post("/")
def create_post(body: PostCreateSchema):
    # ...
    pass
```

### Step 2: Register in v1 Package

```python
# app/routes/v1/__init__.py
from app.routes.v1.posts import posts_bp_v1

api_v1.register_api(posts_bp_v1)  # â†’ /api/v1/posts/*
```

That's it! The new routes are now available.

---

## ğŸ“Š Benefits of This Structure

1. **Version Prefix Once** - `/api/v1` defined in one place
2. **Modular** - Each resource in its own file
3. **Scalable** - Easy to add new resources or versions
4. **Familiar** - Same pattern as Express.js routers
5. **Clear Hierarchy** - URL structure mirrors file structure

---

## ğŸ”œ Next Steps

Let's dive deeper into API versioning.

**Next: [4.4_api_versioning.md](./4.4_api_versioning.md)** - URL-based versioning explained.
