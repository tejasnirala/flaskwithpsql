# ğŸ§© Flask Extensions

> **Adding Functionality to Flask**

---

## ğŸ“‹ What are Flask Extensions?

Flask extensions are packages that add functionality to Flask applications. They follow a common pattern and integrate seamlessly with Flask's application factory.

---

## ğŸ†š Express.js Comparison

**Express.js:**

```javascript
// npm packages used as middleware
const cors = require("cors");
const helmet = require("helmet");

app.use(cors());
app.use(helmet());
app.use(rateLimiter);
```

**Flask:**

```python
# pip packages that follow Flask extension pattern
from flask_cors import CORS
from flask_sqlalchemy import SQLAlchemy

CORS(app)
db.init_app(app)
```

---

## ğŸ“¦ Extensions We Use

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   OUR FLASK EXTENSIONS                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Database                                                       â”‚
â”‚   â”œâ”€â”€ Flask-SQLAlchemy   # ORM integration                       â”‚
â”‚   â””â”€â”€ Flask-Migrate      # Database migrations                   â”‚
â”‚                                                                  â”‚
â”‚   Authentication                                                 â”‚
â”‚   â””â”€â”€ Flask-JWT-Extended # JWT tokens                            â”‚
â”‚                                                                  â”‚
â”‚   API                                                            â”‚
â”‚   â””â”€â”€ flask-openapi3     # OpenAPI/Swagger docs                  â”‚
â”‚                                                                  â”‚
â”‚   Security                                                       â”‚
â”‚   â”œâ”€â”€ Flask-CORS         # Cross-origin requests                 â”‚
â”‚   â””â”€â”€ Flask-Limiter      # Rate limiting                         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ Extension Initialization Pattern

All Flask extensions follow the same pattern:

### Pattern 1: Direct Initialization

```python
from flask import Flask
from flask_cors import CORS

app = Flask(__name__)
CORS(app)  # Initialize with app directly
```

### Pattern 2: Factory Pattern (Recommended)

```python
# app/__init__.py
from flask_sqlalchemy import SQLAlchemy

# Create extension WITHOUT app
db = SQLAlchemy()

def create_app():
    app = Flask(__name__)

    # Initialize WITH app later
    db.init_app(app)

    return app
```

**Why Pattern 2?**

-   Supports application factory
-   Avoids circular imports
-   Allows multiple app instances

---

## ğŸ“š Extension Deep Dives

### 1. Flask-SQLAlchemy

**Purpose:** Database ORM integration

```python
# app/__init__.py
from flask_sqlalchemy import SQLAlchemy

db = SQLAlchemy()

def create_app():
    app = Flask(__name__)
    app.config['SQLALCHEMY_DATABASE_URI'] = 'postgresql://...'
    db.init_app(app)
    return app

# app/models/user.py
from app import db

class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(50), nullable=False)
```

**ğŸ“ See:** `03_database/` for full details

---

### 2. Flask-Migrate

**Purpose:** Database migrations (like Prisma migrations)

```python
# app/__init__.py
from flask_migrate import Migrate

migrate = Migrate()

def create_app():
    app = Flask(__name__)
    db.init_app(app)
    migrate.init_app(app, db)  # Pass both app and db!
    return app
```

**CLI Commands:**

```bash
flask db init       # Initialize migrations
flask db migrate    # Generate migration
flask db upgrade    # Apply migrations
flask db downgrade  # Rollback
```

---

### 3. Flask-JWT-Extended

**Purpose:** JWT authentication

```python
# app/auth/__init__.py
from flask_jwt_extended import JWTManager

jwt = JWTManager()

def init_jwt(app):
    jwt.init_app(app)

    @jwt.token_in_blocklist_loader
    def check_if_token_revoked(jwt_header, jwt_payload):
        jti = jwt_payload['jti']
        return is_token_revoked(jti)

# Usage in routes
from flask_jwt_extended import jwt_required, get_jwt_identity

@app.route('/protected')
@jwt_required()
def protected():
    user_id = get_jwt_identity()
    return f"Hello, user {user_id}"
```

**ğŸ“ See:** `05_authentication/` for full details

---

### 4. Flask-CORS

**Purpose:** Cross-Origin Resource Sharing

```python
# app/__init__.py
from flask_cors import CORS

def create_app():
    app = Flask(__name__)

    CORS(
        app,
        origins=['http://localhost:3000'],
        methods=['GET', 'POST', 'PUT', 'DELETE'],
        allow_headers=['Content-Type', 'Authorization'],
        supports_credentials=True,
    )

    return app
```

---

### 5. Flask-Limiter

**Purpose:** Rate limiting

```python
# app/utils/rate_limiter.py
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address

limiter = Limiter(
    key_func=get_remote_address,  # Rate limit by IP
    default_limits=["100 per minute"],
)

def init_limiter(app):
    limiter.init_app(app)

# Pre-configured decorators
auth_limit = limiter.limit("5 per minute")  # Strict for login
api_limit = limiter.limit("60 per minute")  # Normal API calls

# Usage
@app.route('/login')
@auth_limit
def login():
    ...
```

---

### 6. flask-openapi3

**Purpose:** OpenAPI/Swagger documentation

```python
# Instead of Flask, we use OpenAPI
from flask_openapi3 import OpenAPI, Info

info = Info(title="My API", version="1.0.0")
app = OpenAPI(__name__, info=info)

# Routes automatically documented!
@app.get('/users')
def get_users():
    """This docstring appears in Swagger."""
    ...
```

**Documentation URLs:**

-   `/openapi/swagger` - Swagger UI
-   `/openapi/redoc` - ReDoc
-   `/openapi/openapi.json` - Raw spec

---

## ğŸ”„ Extension Initialization Order

Order matters! Initialize in this sequence:

```python
def create_app():
    app = Flask(__name__)

    # 1. Load configuration FIRST
    app.config.from_object(config_class)

    # 2. Database (before other extensions that might need it)
    db.init_app(app)
    migrate.init_app(app, db)

    # 3. Authentication (needs config)
    init_jwt(app)

    # 4. Rate limiting (needs config)
    init_limiter(app)

    # 5. CORS (before routes)
    CORS(app, ...)

    # 6. Register blueprints (routes)
    app.register_api(api_v1)

    # 7. Error handlers (last, catch-all)
    register_error_handlers(app)

    return app
```

---

## ğŸ“Š Extension Configuration

Each extension has its own configuration:

```python
# config.py

class Config:
    # Flask-SQLAlchemy
    SQLALCHEMY_DATABASE_URI = 'postgresql://...'
    SQLALCHEMY_TRACK_MODIFICATIONS = False

    # Flask-JWT-Extended
    JWT_SECRET_KEY = 'secret'
    JWT_ACCESS_TOKEN_EXPIRES = timedelta(minutes=15)
    JWT_REFRESH_TOKEN_EXPIRES = timedelta(days=30)

    # Flask-Limiter
    RATELIMIT_ENABLED = True
    RATELIMIT_DEFAULT = "100 per minute"
    RATELIMIT_STORAGE_URL = "memory://"

    # Flask-CORS (we configure in code, not config)
    CORS_ORIGINS = ['http://localhost:3000']
```

---

## ğŸ§ª Testing with Extensions

Extensions work in tests too:

```python
# tests/conftest.py

@pytest.fixture
def app():
    app = create_app('testing')  # TestingConfig

    with app.app_context():
        db.create_all()  # Flask-SQLAlchemy
        yield app
        db.drop_all()

@pytest.fixture
def client(app):
    return app.test_client()

def test_rate_limiting(client):
    # Flask-Limiter is disabled in testing config
    for _ in range(100):
        response = client.get('/api/v1/users/')
        assert response.status_code == 200  # No 429!
```

---

## âš ï¸ Common Extension Issues

### Issue 1: Working Outside Application Context

```python
# âŒ WRONG - No app context
from app import db
User.query.all()  # RuntimeError: Working outside application context

# âœ… RIGHT - Use app context
with app.app_context():
    User.query.all()
```

### Issue 2: Extension Not Initialized

```python
# âŒ WRONG - Forgot init_app
db = SQLAlchemy()
# db.init_app(app) missing!
User.query.all()  # Error!

# âœ… RIGHT - Initialize with app
db = SQLAlchemy()
db.init_app(app)  # Now it works
```

### Issue 3: Wrong Configuration Key

```python
# âŒ WRONG - Typo in config key
app.config['SQLALCHEMY_DATABASE_URL'] = '...'  # URL instead of URI!

# âœ… RIGHT - Correct key
app.config['SQLALCHEMY_DATABASE_URI'] = '...'
```

---

## ğŸ”œ Next Steps

Now you understand Flask extensions. Let's learn about Flask's context system.

**Next: [2.7_application_context.md](./2.7_application_context.md)** - Application vs Request context.
