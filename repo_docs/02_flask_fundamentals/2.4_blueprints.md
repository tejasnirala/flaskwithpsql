# ğŸ—‚ï¸ Blueprints - Organizing Routes

> **Flask's Version of Express Router**

---

## ğŸ“‹ What is a Blueprint?

A **Blueprint** is a way to organize your Flask application into reusable components. Think of it as a collection of routes, templates, and static files that can be registered with an application.

---

## ğŸ†š Express.js Comparison

**Express.js Router:**

```javascript
// routes/users.js
const router = express.Router();

router.get("/", getAllUsers);
router.post("/", createUser);
router.get("/:id", getUserById);

module.exports = router;

// app.js
const usersRouter = require("./routes/users");
app.use("/api/users", usersRouter); // Prefix defined here
```

**Flask Blueprint:**

```python
# app/routes/v1/users.py
from flask_openapi3 import APIBlueprint

users_bp = APIBlueprint('users', __name__, url_prefix='/users')

@users_bp.get('/')
def get_all_users():
    ...

@users_bp.post('/')
def create_user():
    ...

@users_bp.get('/<int:user_id>')
def get_user_by_id(user_id):
    ...

# app/__init__.py
from app.routes.v1 import api_v1
app.register_api(api_v1)  # Contains users_bp
```

---

## ğŸ¯ Why Use Blueprints?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     BENEFITS OF BLUEPRINTS                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   1. ORGANIZATION                                                â”‚
â”‚      â”œâ”€â”€ Group related routes together                           â”‚
â”‚      â”œâ”€â”€ Separate files for each feature                         â”‚
â”‚      â””â”€â”€ Clean project structure                                 â”‚
â”‚                                                                  â”‚
â”‚   2. REUSABILITY                                                 â”‚
â”‚      â”œâ”€â”€ Same blueprint in multiple apps                         â”‚
â”‚      â”œâ”€â”€ Package blueprints as libraries                         â”‚
â”‚      â””â”€â”€ Share between projects                                  â”‚
â”‚                                                                  â”‚
â”‚   3. URL PREFIXING                                               â”‚
â”‚      â”œâ”€â”€ Define prefix once                                      â”‚
â”‚      â”œâ”€â”€ All routes automatically prefixed                       â”‚
â”‚      â””â”€â”€ Easy to version APIs                                    â”‚
â”‚                                                                  â”‚
â”‚   4. LAZY REGISTRATION                                           â”‚
â”‚      â”œâ”€â”€ Blueprints created without app                          â”‚
â”‚      â”œâ”€â”€ Registered when app is created                          â”‚
â”‚      â””â”€â”€ Avoids circular imports                                 â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Our Blueprint Structure

We use **nested blueprints** for API versioning:

```
app/routes/
â”œâ”€â”€ __init__.py           # Exports api_v1
â”œâ”€â”€ web.py               # Web interface (/, /health-dashboard)
â””â”€â”€ v1/                   # API Version 1
    â”œâ”€â”€ __init__.py       # Parent blueprint with /api/v1 prefix
    â”œâ”€â”€ main.py          # /api/v1/ and /api/v1/health
    â””â”€â”€ users.py         # /api/v1/users/*

app/auth/
â””â”€â”€ v1/
    â”œâ”€â”€ __init__.py
    â””â”€â”€ routes.py         # /api/v1/auth/*
```

---

## ğŸ”§ Creating a Blueprint

### Basic Blueprint

```python
# app/routes/v1/users.py
from flask_openapi3 import APIBlueprint, Tag

# Tag for Swagger UI grouping
tag = Tag(name="Users", description="User management operations")

# Create blueprint with URL prefix
users_bp_v1 = APIBlueprint(
    'users_v1',           # Blueprint name (must be unique)
    __name__,             # Import name (for finding resources)
    url_prefix='/users',  # URL prefix for all routes
    abp_tags=[tag],       # Swagger UI grouping
)

@users_bp_v1.get('/')
def get_all_users():
    """Get all users."""
    ...

@users_bp_v1.get('/<int:user_id>')
def get_user(user_id: int):
    """Get user by ID."""
    ...

@users_bp_v1.post('/register')
def register():
    """Register a new user."""
    ...
```

### Parent Blueprint (for Versioning)

```python
# app/routes/v1/__init__.py
from flask_openapi3 import APIBlueprint

from app.auth.v1.routes import auth_bp_v1
from app.routes.v1.main import main_bp_v1
from app.routes.v1.users import users_bp_v1

# Parent blueprint with version prefix
api_v1 = APIBlueprint(
    'api_v1',                  # Parent blueprint name
    __name__,
    url_prefix='/api/v1',      # Version prefix - defined ONCE!
)

# Register child blueprints under the parent
api_v1.register_api(auth_bp_v1)   # â†’ /api/v1/auth/*
api_v1.register_api(users_bp_v1)  # â†’ /api/v1/users/*
api_v1.register_api(main_bp_v1)   # â†’ /api/v1/ and /api/v1/health
```

---

## ğŸ”„ URL Building

### How URLs are Constructed

```
Parent Blueprint        Child Blueprint         Route
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/api/v1            +   /users             +   /register
                                              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                               = /api/v1/users/register
```

### Visual Example

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    URL CONSTRUCTION                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   api_v1 (url_prefix="/api/v1")                                  â”‚
â”‚   â”‚                                                              â”‚
â”‚   â”œâ”€â”€ users_bp_v1 (url_prefix="/users")                          â”‚
â”‚   â”‚   â”œâ”€â”€ GET /              â†’ /api/v1/users/                    â”‚
â”‚   â”‚   â”œâ”€â”€ GET /<id>          â†’ /api/v1/users/<id>                â”‚
â”‚   â”‚   â”œâ”€â”€ POST /register     â†’ /api/v1/users/register            â”‚
â”‚   â”‚   â””â”€â”€ PUT /<id>          â†’ /api/v1/users/<id>                â”‚
â”‚   â”‚                                                              â”‚
â”‚   â”œâ”€â”€ auth_bp_v1 (url_prefix="/auth")                            â”‚
â”‚   â”‚   â”œâ”€â”€ POST /login        â†’ /api/v1/auth/login                â”‚
â”‚   â”‚   â”œâ”€â”€ POST /logout       â†’ /api/v1/auth/logout               â”‚
â”‚   â”‚   â”œâ”€â”€ POST /refresh      â†’ /api/v1/auth/refresh              â”‚
â”‚   â”‚   â””â”€â”€ GET /me            â†’ /api/v1/auth/me                   â”‚
â”‚   â”‚                                                              â”‚
â”‚   â””â”€â”€ main_bp_v1 (url_prefix="")                                 â”‚
â”‚       â”œâ”€â”€ GET /              â†’ /api/v1/                          â”‚
â”‚       â””â”€â”€ GET /health        â†’ /api/v1/health                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Blueprint Registration

### In App Factory

```python
# app/__init__.py

def create_app(config_name="default"):
    app = OpenAPI(__name__, info=info)

    # ... configuration ...

    # Register versioned API blueprints
    from app.routes.v1 import api_v1
    app.register_api(api_v1)  # All v1 routes!

    # Register web interface blueprints
    from app.routes.web import web_bp
    app.register_api(web_bp)

    return app
```

### Express.js Equivalent

```javascript
// Similar nested router pattern
const v1Router = express.Router();
v1Router.use("/users", usersRouter);
v1Router.use("/auth", authRouter);
v1Router.use("/", mainRouter);

app.use("/api/v1", v1Router);
```

---

## ğŸ¯ Blueprint vs APIBlueprint

We use `APIBlueprint` from flask-openapi3 instead of Flask's `Blueprint`:

```python
# Flask's built-in Blueprint
from flask import Blueprint
bp = Blueprint('users', __name__)

# flask-openapi3's APIBlueprint (we use this)
from flask_openapi3 import APIBlueprint
bp = APIBlueprint('users', __name__)
```

**Why APIBlueprint?**

-   Automatic OpenAPI/Swagger documentation
-   Built-in request validation with Pydantic
-   Comes with helpful decorators

---

## ğŸ”§ Common Blueprint Operations

### Route Parameters

```python
@users_bp.get('/<int:user_id>')
def get_user(user_id: int):
    """Get user by ID. user_id is automatically an integer."""
    user = User.query.get(user_id)
    ...

# URL: /api/v1/users/42
# user_id = 42 (as an int)
```

### Multiple HTTP Methods

```python
# Separate decorators (recommended)
@users_bp.get('/<int:user_id>')
def get_user(user_id):
    ...

@users_bp.put('/<int:user_id>')
def update_user(user_id):
    ...

@users_bp.delete('/<int:user_id>')
def delete_user(user_id):
    ...
```

### Before Request Hooks

```python
@users_bp.before_request
def check_auth():
    """Runs before every request in this blueprint."""
    if not current_user.is_authenticated:
        return error_response("Unauthorized", 401)
```

---

## ğŸ“Š Our Web Blueprint

For non-API routes (HTML pages):

```python
# app/routes/web.py
from flask_openapi3 import APIBlueprint
from flask import render_template

web_bp = APIBlueprint(
    'web',
    __name__,
    # No url_prefix - routes are at /
)

@web_bp.get('/')
def index():
    """Landing page."""
    return render_template('index.html')

@web_bp.get('/health-dashboard')
def health_dashboard():
    """Health monitoring dashboard."""
    return render_template('health.html')
```

---

## ğŸ“ Advanced Blueprint Features

### Blueprint-Specific Error Handlers

Each blueprint can have its own error handlers that only apply to routes within that blueprint:

```python
@users_bp.errorhandler(404)
def user_not_found(error):
    """Only catches 404s from users_bp routes."""
    return error_response(
        message="User not found",
        error_code=ErrorCode.RESOURCE_NOT_FOUND,
        status_code=404
    )

@users_bp.errorhandler(ValidationError)
def handle_validation_error(error):
    """Catches Pydantic ValidationError from users_bp."""
    return error_response(
        message="Invalid user data",
        error_code=ErrorCode.VALIDATION_ERROR,
        details=error.errors(),
        status_code=422
    )
```

### After Request Hooks

Run code after every request in a blueprint:

```python
@users_bp.after_request
def add_user_headers(response):
    """Add custom headers to all user responses."""
    response.headers['X-User-API-Version'] = 'v1'
    return response
```

### Teardown Hooks (Cleanup)

```python
@users_bp.teardown_request
def cleanup(exception=None):
    """Run after every request, even if an error occurred."""
    if exception:
        logger.error(f"Request failed: {exception}")
    # Clean up any resources
```

### Blueprint Request/Response Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 BLUEPRINT REQUEST FLOW                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Incoming Request: POST /api/v1/users/register                  â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   App-level before_request handlers (all requests)               â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   Blueprint before_request (users_bp only)                       â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   Route handler: register()                                      â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼ (if no error)                                            â”‚
â”‚   Blueprint after_request                                        â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   App-level after_request                                        â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   Response sent to client                                        â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   Blueprint teardown_request (cleanup)                           â”‚
â”‚                                                                  â”‚
â”‚   (If error at any step â†’ Blueprint errorhandler â†’ App errorhandler)
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš ï¸ Common Mistakes

### 1. Duplicate Blueprint Names

```python
# âŒ WRONG - Same name will cause errors
bp1 = Blueprint('users', __name__)
bp2 = Blueprint('users', __name__)  # Error!

# âœ… RIGHT - Unique names
bp1 = Blueprint('users_v1', __name__)
bp2 = Blueprint('users_v2', __name__)
```

### 2. Forgetting url_prefix

```python
# âŒ Routes at /register instead of /users/register
users_bp = APIBlueprint('users', __name__)  # No prefix!

# âœ… Routes at /users/register
users_bp = APIBlueprint('users', __name__, url_prefix='/users')
```

### 3. Circular Imports

```python
# âŒ WRONG - Importing app in blueprint
from app import app  # Circular!

@bp.route('/')
def home():
    ...

# âœ… RIGHT - Use current_app
from flask import current_app

@bp.route('/')
def home():
    config = current_app.config  # Gets config at request time
    ...
```

---

## ğŸ”œ Next Steps

Now you understand Blueprints. Let's trace what happens when a request comes in.

**Next: [2.5_request_lifecycle.md](./2.5_request_lifecycle.md)** - The complete request/response cycle.
