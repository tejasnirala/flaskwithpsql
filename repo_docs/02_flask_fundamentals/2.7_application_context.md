# ğŸ”® Application Context vs Request Context

> **Understanding Flask's Two Context Types**

---

## ğŸ“‹ What are Contexts?

Flask has two types of contexts that manage state:

1. **Application Context** - Information about the application
2. **Request Context** - Information about the current request

This is one of Flask's most confusing concepts for beginners, but it's essential to understand.

---

## ğŸ†š Express.js Comparison

Express doesn't have this concept because Node.js handles things differently:

**Express.js:**

```javascript
// Everything is available via req
app.get("/users", (req, res) => {
    const user = req.user; // From middleware
    const appConfig = app.config; // Direct app access
});
```

**Flask:**

```python
from flask import current_app, request, g

@app.route('/users')
def get_users():
    config = current_app.config  # Application context
    user_agent = request.headers.get('User-Agent')  # Request context
    user = g.user  # Request-scoped data
```

---

## ğŸ“Š The Two Contexts

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLASK CONTEXTS                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   APPLICATION CONTEXT                                            â”‚
â”‚   â”œâ”€â”€ Contains: current_app, g (partially)                       â”‚
â”‚   â”œâ”€â”€ Lifespan: Duration of request (usually)                    â”‚
â”‚   â”œâ”€â”€ Purpose: Access app configuration and extensions           â”‚
â”‚   â””â”€â”€ When: Pushed automatically during request                  â”‚
â”‚                                                                  â”‚
â”‚   REQUEST CONTEXT                                                â”‚
â”‚   â”œâ”€â”€ Contains: request, session, g                              â”‚
â”‚   â”œâ”€â”€ Lifespan: Single HTTP request                              â”‚
â”‚   â”œâ”€â”€ Purpose: Access request data                               â”‚
â”‚   â””â”€â”€ When: Pushed automatically for each request                â”‚
â”‚                                                                  â”‚
â”‚   Relationship:                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚   â”‚  Application Context                    â”‚                    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                    â”‚
â”‚   â”‚  â”‚  Request Context               â”‚    â”‚                    â”‚
â”‚   â”‚  â”‚  (request, session)            â”‚    â”‚                    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                    â”‚
â”‚   â”‚  (current_app, g)                       â”‚                    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                  â”‚
â”‚   Request context INCLUDES application context                   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ Context Objects

### `current_app` - The Application

```python
from flask import current_app

@app.route('/info')
def info():
    # Access app configuration
    secret = current_app.config['SECRET_KEY']
    debug = current_app.debug

    # Access extensions
    db = current_app.extensions['sqlalchemy']

    return {'debug': debug}
```

**Why `current_app` instead of `app`?**

-   With the factory pattern, `app` might not exist at import time
-   `current_app` always points to the current application
-   Avoids circular imports

### `request` - The Current Request

```python
from flask import request

@app.route('/users', methods=['POST'])
def create_user():
    # JSON body
    data = request.get_json()

    # URL parameters
    page = request.args.get('page', 1, type=int)

    # Headers
    auth = request.headers.get('Authorization')

    # Method
    if request.method == 'POST':
        ...
```

### `g` - Request-Scoped Storage

```python
from flask import g

@app.before_request
def load_user():
    token = request.headers.get('Authorization')
    if token:
        g.user = get_user_from_token(token)

@app.route('/profile')
def profile():
    if not hasattr(g, 'user') or g.user is None:
        return {'error': 'Not authenticated'}, 401
    return {'user': g.user.to_dict()}
```

**`g` characteristics:**

-   Reset for each request
-   Good for storing data used across the request
-   Like `req.user` in Express

### `session` - User Sessions

```python
from flask import session

@app.route('/login', methods=['POST'])
def login():
    session['user_id'] = user.id  # Stored in cookie
    return {'message': 'Logged in'}

@app.route('/dashboard')
def dashboard():
    user_id = session.get('user_id')
    if not user_id:
        return redirect('/login')
```

---

## âš ï¸ The Context Problem

### Working Outside Request Context

```python
# âŒ WRONG - No request context
from flask import request
print(request.method)  # RuntimeError: Working outside of request context

# âŒ WRONG - No application context
from flask import current_app
print(current_app.config)  # RuntimeError: Working outside of application context
```

### Solutions

**Solution 1: Use `with` block**

```python
# For scripts, CLI commands, tests
with app.app_context():
    # Application context is now active
    print(current_app.config['SECRET_KEY'])
    User.query.all()  # Database queries work
```

**Solution 2: Test client handles it**

```python
# Flask test client manages contexts
def test_users(client):
    response = client.get('/api/v1/users/')  # Context managed
    assert response.status_code == 200
```

**Solution 3: During request handling (automatic)**

```python
# Flask handles context automatically during requests
@app.route('/users')
def get_users():
    # Both contexts are active here!
    config = current_app.config
    users = User.query.all()
    return jsonify([u.to_dict() for u in users])
```

---

## ğŸ”„ Context Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CONTEXT LIFECYCLE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Request arrives                                                â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚   â”‚ Push application context          â”‚                          â”‚
â”‚   â”‚   â€¢ current_app becomes available â”‚                          â”‚
â”‚   â”‚   â€¢ g is initialized              â”‚                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚   â”‚ Push request context              â”‚                          â”‚
â”‚   â”‚   â€¢ request becomes available     â”‚                          â”‚
â”‚   â”‚   â€¢ session becomes available     â”‚                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   [ View function executes ]                                     â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚   â”‚ Pop request context               â”‚                          â”‚
â”‚   â”‚   â€¢ request no longer available   â”‚                          â”‚
â”‚   â”‚   â€¢ teardown_request runs         â”‚                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚   â”‚ Pop application context           â”‚                          â”‚
â”‚   â”‚   â€¢ current_app no longer avail   â”‚                          â”‚
â”‚   â”‚   â€¢ teardown_appcontext runs      â”‚                          â”‚
â”‚   â”‚   â€¢ g is cleared                  â”‚                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   Response sent to client                                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Context Usage in Our Project

### Database Queries (Need App Context)

```python
# app/services/user_service.py
class UserService:
    @staticmethod
    def get_by_id(user_id: int):
        # Works because we're in a request (has app context)
        return User.query.get(user_id)
```

### CLI Commands (Manual Context)

```python
# db_manage.py
import click
from app import create_app, db

@click.command()
def seed():
    """Seed the database."""
    app = create_app()
    with app.app_context():  # Manually push context
        user = User(username='admin', email='admin@example.com')
        db.session.add(user)
        db.session.commit()
```

### Tests (Fixtures Handle Context)

```python
# tests/conftest.py
@pytest.fixture
def app():
    app = create_app('testing')
    with app.app_context():  # Push context
        db.create_all()
        yield app  # Tests run here
        db.drop_all()
```

---

## ğŸ§ª Testing Context Understanding

```python
from flask import Flask, current_app, request, g

app = Flask(__name__)

# Outside any context
try:
    print(current_app.name)
except RuntimeError as e:
    print(f"Error: {e}")  # Working outside of application context

# With application context only
with app.app_context():
    print(current_app.name)  # Works! "my_app"
    try:
        print(request.method)
    except RuntimeError as e:
        print(f"Error: {e}")  # Working outside of request context

# With test request context (includes app context)
with app.test_request_context('/users?page=1'):
    print(current_app.name)  # Works!
    print(request.path)      # Works! "/users"
    print(request.args.get('page'))  # Works! "1"
```

---

## ğŸ“ Quick Reference

| Object        | Context Needed | Purpose                      | Scope            |
| ------------- | -------------- | ---------------------------- | ---------------- |
| `current_app` | Application    | Access app config/extensions | Request duration |
| `g`           | Application    | Store request-specific data  | Single request   |
| `request`     | Request        | Access request data          | Single request   |
| `session`     | Request        | Access user session          | Across requests  |

---

## ğŸ”œ Next Steps

Now you understand Flask's context system. Let's do a line-by-line walkthrough of our app factory.

**Next: [2.8_our_app_init.md](./2.8_our_app_init.md)** - Our `app/__init__.py` explained.
