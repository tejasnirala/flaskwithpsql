# üåê CORS - Cross-Origin Resource Sharing

> **Understanding and Configuring CORS in Flask**

---

## üìã What is CORS?

**CORS** (Cross-Origin Resource Sharing) is a security mechanism built into web browsers that controls which websites can make requests to your API.

### The Same-Origin Policy

Browsers enforce a **Same-Origin Policy**: JavaScript on `https://frontend.com` cannot make requests to `https://api.backend.com` by default.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   SAME-ORIGIN POLICY                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ   Origin = Protocol + Domain + Port                              ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ   ‚úÖ SAME ORIGIN (allowed by default):                           ‚îÇ
‚îÇ      http://example.com/page1  ‚Üí  http://example.com/api         ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ   ‚ùå DIFFERENT ORIGIN (blocked by default):                      ‚îÇ
‚îÇ      http://frontend.com  ‚Üí  http://api.backend.com              ‚îÇ
‚îÇ      http://localhost:3000  ‚Üí  http://localhost:5500             ‚îÇ
‚îÇ      https://example.com  ‚Üí  http://example.com (port differs!)  ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Why Does This Exist?

Without the same-origin policy, malicious websites could:

-   Steal your session cookies
-   Make requests on your behalf
-   Access your private data

CORS is the **controlled way** to allow cross-origin requests when they're legitimate.

---

## üîÑ How CORS Works

When a browser makes a cross-origin request, it adds special headers. The server responds with CORS headers indicating what's allowed.

### Simple Requests

For simple GET/POST requests:

```
Browser ‚Üí Server: "I'm from http://frontend.com"
Server ‚Üí Browser: "Access-Control-Allow-Origin: http://frontend.com"
Browser: "OK, I'll allow this response"
```

### Preflight Requests (OPTIONS)

For complex requests (custom headers, PUT/DELETE, etc.), the browser first sends an **OPTIONS** request:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   PREFLIGHT FLOW                                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ   1. Browser wants to send: PUT /api/users/1                     ‚îÇ
‚îÇ      with header: Authorization: Bearer token                    ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ   2. Browser sends PREFLIGHT first:                              ‚îÇ
‚îÇ      OPTIONS /api/users/1                                        ‚îÇ
‚îÇ      Origin: http://frontend.com                                 ‚îÇ
‚îÇ      Access-Control-Request-Method: PUT                          ‚îÇ
‚îÇ      Access-Control-Request-Headers: Authorization               ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ   3. Server responds:                                            ‚îÇ
‚îÇ      Access-Control-Allow-Origin: http://frontend.com            ‚îÇ
‚îÇ      Access-Control-Allow-Methods: PUT                           ‚îÇ
‚îÇ      Access-Control-Allow-Headers: Authorization                 ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ   4. If allowed, browser sends ACTUAL request:                   ‚îÇ
‚îÇ      PUT /api/users/1                                            ‚îÇ
‚îÇ      Authorization: Bearer token                                 ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üÜö Express.js vs Flask CORS

**Express.js with cors middleware:**

```javascript
const cors = require("cors");

app.use(
    cors({
        origin: ["http://localhost:3000", "https://frontend.com"],
        methods: ["GET", "POST", "PUT", "DELETE"],
        allowedHeaders: ["Content-Type", "Authorization"],
        credentials: true,
        maxAge: 86400,
    })
);
```

**Flask with Flask-CORS:**

```python
from flask_cors import CORS

CORS(app,
    origins=['http://localhost:3000', 'https://frontend.com'],
    methods=['GET', 'POST', 'PUT', 'DELETE'],
    allow_headers=['Content-Type', 'Authorization'],
    supports_credentials=True,
    max_age=86400
)
```

**Key Mapping:**

| Express.js       | Flask-CORS             |
| ---------------- | ---------------------- |
| `origin`         | `origins`              |
| `methods`        | `methods`              |
| `allowedHeaders` | `allow_headers`        |
| `credentials`    | `supports_credentials` |
| `maxAge`         | `max_age`              |

---

## üîß Installing Flask-CORS

```bash
pip install flask-cors
```

---

## üìÅ Our CORS Configuration

### In config.py

```python
class Config:
    # CORS Settings
    CORS_ORIGINS = [
        'http://localhost:3000',     # React dev server
        'http://localhost:5500',     # Flask dev server
        'http://127.0.0.1:3000',
    ]
    CORS_METHODS = ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS']
    CORS_ALLOW_HEADERS = ['Content-Type', 'Authorization', 'X-Requested-With']
    CORS_EXPOSE_HEADERS = ['X-Request-ID']
    CORS_SUPPORTS_CREDENTIALS = True
    CORS_MAX_AGE = 86400  # Cache preflight for 24 hours


class ProductionConfig(Config):
    # Stricter CORS in production - only specific origins
    CORS_ORIGINS = [
        'https://myapp.com',
        'https://www.myapp.com',
    ]
```

### In app/**init**.py

```python
from flask_cors import CORS

def create_app(config_name="default"):
    app = OpenAPI(__name__, info=info)
    app.config.from_object(config_class)

    # Configure CORS using config values
    CORS(
        app,
        origins=config_class.CORS_ORIGINS,
        methods=config_class.CORS_METHODS,
        allow_headers=config_class.CORS_ALLOW_HEADERS,
        expose_headers=config_class.CORS_EXPOSE_HEADERS,
        supports_credentials=config_class.CORS_SUPPORTS_CREDENTIALS,
        max_age=config_class.CORS_MAX_AGE,
    )

    return app
```

---

## üéõÔ∏è CORS Options Explained

### `origins`

Which origins (domains) can access your API:

```python
# Single origin
CORS(app, origins='http://localhost:3000')

# Multiple origins
CORS(app, origins=['http://localhost:3000', 'https://myapp.com'])

# All origins (not recommended for production!)
CORS(app, origins='*')

# Regex pattern
CORS(app, origins=r'https://.*\.myapp\.com')
```

### `methods`

Which HTTP methods are allowed:

```python
# Default: GET, HEAD, POST, OPTIONS, PUT, PATCH, DELETE
CORS(app, methods=['GET', 'POST'])  # Restrictive
```

### `allow_headers`

Which request headers are allowed:

```python
CORS(app, allow_headers=[
    'Content-Type',      # For JSON requests
    'Authorization',     # For JWT tokens
    'X-Requested-With',  # Common AJAX header
])
```

### `expose_headers`

Which response headers the browser can access:

```python
# By default, browsers only expose "simple" headers
# Use this to expose custom headers like:
CORS(app, expose_headers=['X-Request-ID', 'X-RateLimit-Remaining'])
```

### `supports_credentials`

Allow cookies/auth to be sent cross-origin:

```python
CORS(app, supports_credentials=True)

# ‚ö†Ô∏è WARNING: Cannot use origins='*' with credentials!
# Must specify exact origins
```

### `max_age`

How long the browser caches preflight responses:

```python
CORS(app, max_age=86400)  # 24 hours in seconds
# Reduces preflight requests, improving performance
```

---

## üéØ Route-Specific CORS

Sometimes you need different CORS rules for different routes:

```python
from flask_cors import cross_origin

# Global CORS for most routes
CORS(app, origins=['https://myapp.com'])

# But allow any origin for this specific endpoint
@app.route('/public-api')
@cross_origin(origins='*')
def public_api():
    return {'message': 'Anyone can access this'}

# More restrictive for admin routes
@app.route('/admin/data')
@cross_origin(origins=['https://admin.myapp.com'])
def admin_data():
    return {'secret': 'data'}
```

---

## üö´ Common CORS Errors

### Error 1: "No 'Access-Control-Allow-Origin' header"

```
Access to fetch at 'http://localhost:5500/api' from origin
'http://localhost:3000' has been blocked by CORS policy:
No 'Access-Control-Allow-Origin' header is present.
```

**Cause:** Your Flask server isn't sending CORS headers.

**Fix:** Ensure Flask-CORS is properly initialized:

```python
from flask_cors import CORS
CORS(app, origins=['http://localhost:3000'])
```

### Error 2: "Preflight response is not successful"

```
CORS error: Response to preflight request doesn't pass access
control check: It does not have HTTP ok status.
```

**Cause:** Your server is returning an error for OPTIONS requests.

**Fix:** Ensure OPTIONS is in allowed methods:

```python
CORS(app, methods=['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'])
```

### Error 3: "Credentials flag is true, but Access-Control-Allow-Origin is \*"

```
The value of the 'Access-Control-Allow-Credentials' header in the
response is '' which must be 'true' when the request's credentials
mode is 'include'.
```

**Cause:** Using `credentials: 'include'` in fetch with `origins='*'`.

**Fix:** Specify exact origins when using credentials:

```python
# ‚ùå This won't work
CORS(app, origins='*', supports_credentials=True)

# ‚úÖ This works
CORS(app, origins=['http://localhost:3000'], supports_credentials=True)
```

### Error 4: "Request header field X is not allowed"

```
Request header field Authorization is not allowed by
Access-Control-Allow-Headers in preflight response.
```

**Cause:** Your `Authorization` header isn't in `allow_headers`.

**Fix:**

```python
CORS(app, allow_headers=['Content-Type', 'Authorization'])
```

---

## üîç Debugging CORS Issues

### 1. Check Response Headers

Use browser DevTools ‚Üí Network tab ‚Üí Look at response headers:

```
Access-Control-Allow-Origin: http://localhost:3000
Access-Control-Allow-Methods: GET, POST, PUT, DELETE
Access-Control-Allow-Headers: Content-Type, Authorization
Access-Control-Allow-Credentials: true
```

### 2. Check the Preflight Request

Look for an OPTIONS request before your actual request:

```
OPTIONS /api/users/1 - Should return 200 OK
PUT /api/users/1 - Your actual request
```

### 3. Test with curl

```bash
# Test preflight
curl -X OPTIONS http://localhost:5500/api/v1/users \
  -H "Origin: http://localhost:3000" \
  -H "Access-Control-Request-Method: POST" \
  -H "Access-Control-Request-Headers: Content-Type,Authorization" \
  -i

# Check response headers
```

### 4. Temporary: Allow All Origins (Development Only!)

```python
# ‚ö†Ô∏è NEVER do this in production!
CORS(app, origins='*')
```

---

## üåç Environment-Based CORS

Different settings for development vs production:

```python
class Config:
    """Base configuration."""
    CORS_ORIGINS = []
    CORS_SUPPORTS_CREDENTIALS = True


class DevelopmentConfig(Config):
    """Development - more permissive."""
    CORS_ORIGINS = [
        'http://localhost:3000',
        'http://localhost:5173',  # Vite
        'http://127.0.0.1:3000',
    ]


class ProductionConfig(Config):
    """Production - locked down."""
    CORS_ORIGINS = [
        'https://myapp.com',
        'https://www.myapp.com',
    ]

    @classmethod
    def validate(cls) -> list:
        errors = super().validate()
        if not cls.CORS_ORIGINS:
            errors.append("CORS_ORIGINS must be set in production")
        if '*' in cls.CORS_ORIGINS:
            errors.append("CORS_ORIGINS cannot be '*' in production")
        return errors
```

---

## üìã CORS Headers Quick Reference

### Request Headers (sent by browser)

| Header                           | Description                   |
| -------------------------------- | ----------------------------- |
| `Origin`                         | The origin making the request |
| `Access-Control-Request-Method`  | Method for preflight          |
| `Access-Control-Request-Headers` | Headers for preflight         |

### Response Headers (sent by server)

| Header                             | Description              |
| ---------------------------------- | ------------------------ |
| `Access-Control-Allow-Origin`      | Allowed origin           |
| `Access-Control-Allow-Methods`     | Allowed methods          |
| `Access-Control-Allow-Headers`     | Allowed headers          |
| `Access-Control-Expose-Headers`    | Headers browser can read |
| `Access-Control-Allow-Credentials` | Allow cookies            |
| `Access-Control-Max-Age`           | Preflight cache duration |

---

## ‚úÖ CORS Best Practices

### 1. Be Specific with Origins

```python
# ‚ùå Too permissive
CORS(app, origins='*')

# ‚úÖ Explicit list
CORS(app, origins=['https://myapp.com', 'https://admin.myapp.com'])
```

### 2. Use Environment Variables for Origins

```python
import os

CORS_ORIGINS = os.environ.get('CORS_ORIGINS', '').split(',')
# Set in .env: CORS_ORIGINS=https://myapp.com,https://admin.myapp.com
```

### 3. Limit Exposed Headers

Only expose headers that the frontend actually needs:

```python
CORS(app, expose_headers=['X-Request-ID'])  # Only what's needed
```

### 4. Cache Preflight Responses

```python
CORS(app, max_age=86400)  # 24 hours - reduces preflight requests
```

### 5. Handle CORS Errors Gracefully

```python
@app.errorhandler(Exception)
def handle_error(error):
    # CORS headers are still added by Flask-CORS even for error responses
    return jsonify({'error': str(error)}), 500
```

---

## üîú Next Steps

Now you understand CORS. This is essential for any API that's called from a browser.

**Related:**

-   [2.3_configuration.md](./2.3_configuration.md) - See CORS in config
-   [app/**init**.py](../../app/__init__.py) - See CORS initialization
