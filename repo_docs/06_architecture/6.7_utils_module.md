# 6.7 Utils Module

> **Cross-Cutting Concerns and Shared Utilities**

This document explains the `app/utils/` module, which contains shared utilities and cross-cutting concerns used throughout the Flask application. We'll cover each component and how they work together.

---

## Table of Contents

1. [Overview](#overview)
2. [Directory Structure](#directory-structure)
3. [responses.py - Response Utilities](#responsespy---response-utilities)
4. [error_handlers.py - Global Error Handling](#error_handlerspy---global-error-handling)
5. [logging_config.py - Logging System](#logging_configpy---logging-system)
6. [rate_limiter.py - Rate Limiting](#rate_limiterpy---rate-limiting)
7. [Module Exports](#module-exports)
8. [How It All Connects](#how-it-all-connects)

---

## Overview

### What is the Utils Module?

The `utils/` module contains **cross-cutting concerns** - functionality that is used across multiple layers of the application:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Cross-Cutting Concerns                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                         Routes                                   │    │
│  │                                                                  │    │
│  │  Uses: success_response(), error_response()                      │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                           │         │                                    │
│                           ▼         ▼                                    │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                                                                   │  │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────────────┐ │  │
│  │  │  responses.py │  │error_handlers │  │  logging_config.py   │ │  │
│  │  │               │  │     .py       │  │                       │ │  │
│  │  │ • success_    │  │ • Global      │  │ • setup_logging()    │ │  │
│  │  │   response    │  │   handlers    │  │ • get_request_id()   │ │  │
│  │  │ • error_      │  │ • Pydantic    │  │ • Formatters         │ │  │
│  │  │   response    │  │   validation  │  │ • Request middleware │ │  │
│  │  │ • ErrorCode   │  │ • DB errors   │  │                       │ │  │
│  │  └───────────────┘  └───────────────┘  └───────────────────────┘ │  │
│  │                                                                   │  │
│  │  ┌───────────────────────────────────────────────────────────┐   │  │
│  │  │                    rate_limiter.py                         │   │  │
│  │  │                                                            │   │  │
│  │  │  • Flask-Limiter configuration                            │   │  │
│  │  │  • Rate limit storage (Redis/memory)                      │   │  │
│  │  └───────────────────────────────────────────────────────────┘   │  │
│  │                                                                   │  │
│  │                        app/utils/                                 │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Why a Separate Utils Module?

| Benefit             | Description                                   |
| ------------------- | --------------------------------------------- |
| **DRY**             | Don't Repeat Yourself - centralized utilities |
| **Consistency**     | Same patterns used everywhere                 |
| **Maintainability** | Single place to update shared functionality   |
| **Clean imports**   | `from app.utils import success_response`      |

---

## Directory Structure

```
app/
└── utils/
    ├── __init__.py           # Module exports
    ├── responses.py          # Response helpers and schemas
    ├── error_handlers.py     # Global error handlers
    ├── logging_config.py     # Logging configuration
    └── rate_limiter.py       # Rate limiting setup
```

---

## responses.py - Response Utilities

### Purpose

Provides standardized response formatting for all API endpoints.

### Key Components

#### ErrorCode Enum

```python
class ErrorCode(str, Enum):
    """Machine-readable error codes."""

    # General Errors
    INTERNAL_ERROR = "INTERNAL_ERROR"
    BAD_REQUEST = "BAD_REQUEST"
    NOT_FOUND = "NOT_FOUND"
    METHOD_NOT_ALLOWED = "METHOD_NOT_ALLOWED"
    CONFLICT = "CONFLICT"

    # Validation Errors
    VALIDATION_ERROR = "VALIDATION_ERROR"
    INVALID_INPUT = "INVALID_INPUT"
    MISSING_FIELD = "MISSING_FIELD"

    # Authentication Errors
    UNAUTHORIZED = "UNAUTHORIZED"
    FORBIDDEN = "FORBIDDEN"
    INVALID_CREDENTIALS = "INVALID_CREDENTIALS"
    TOKEN_EXPIRED = "TOKEN_EXPIRED"
    TOKEN_INVALID = "TOKEN_INVALID"

    # Resource Errors
    RESOURCE_NOT_FOUND = "RESOURCE_NOT_FOUND"
    RESOURCE_ALREADY_EXISTS = "RESOURCE_ALREADY_EXISTS"

    # Database Errors
    DATABASE_ERROR = "DATABASE_ERROR"

    # Rate Limiting
    RATE_LIMIT_EXCEEDED = "RATE_LIMIT_EXCEEDED"
```

#### success_response()

```python
def success_response(
    data: Optional[Any] = None,
    message: Optional[str] = None,
    meta: Optional[Dict[str, Any]] = None,
    status_code: int = 200,
) -> tuple[Response, int]:
    """
    Create a standardized success response.

    Response format:
    {
        "success": true,
        "data": <payload>,
        "error": null,
        "meta": <metadata or null>
    }
    """
```

**Usage:**

```python
# Simple success
return success_response(data={"id": 1, "name": "John"})

# With message
return success_response(
    data=user.to_dict(),
    message="User created successfully",
    status_code=201
)

# With pagination metadata
return success_response(
    data=users_list,
    meta={"page": 1, "per_page": 10, "total": 100}
)
```

#### error_response()

```python
def error_response(
    code: Union[ErrorCode, str],
    message: str,
    details: Optional[Dict[str, Any]] = None,
    meta: Optional[Dict[str, Any]] = None,
    status_code: int = 400,
) -> tuple[Response, int]:
    """
    Create a standardized error response.

    Response format:
    {
        "success": false,
        "data": null,
        "error": {
            "code": "ERROR_CODE",
            "message": "Human readable message",
            "details": {...} | null
        },
        "meta": null
    }
    """
```

**Usage:**

```python
# Simple error
return error_response(
    code=ErrorCode.NOT_FOUND,
    message="User not found",
    status_code=404
)

# Validation error with details
return error_response(
    code=ErrorCode.VALIDATION_ERROR,
    message="Validation failed",
    details={"email": "Invalid format", "password": "Too short"},
    status_code=422
)
```

#### Response Schemas (for OpenAPI)

```python
class StandardSuccessResponse(BaseModel):
    """Schema for success responses."""
    success: bool = Field(default=True)
    data: Optional[Any] = None
    error: None = None
    meta: Optional[MetaInfo] = None

class StandardErrorResponse(BaseModel):
    """Schema for error responses."""
    success: bool = Field(default=False)
    data: None = None
    error: ErrorDetail
    meta: Optional[MetaInfo] = None
```

---

## error_handlers.py - Global Error Handling

### Purpose

Registers global error handlers to ensure **all** exceptions return standardized responses.

### How It Works

```
┌─────────────────────────────────────────────────────────────────────────┐
│      Exception Raised in Route                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ Flask Error Handler System                                               │
│                                                                          │
│ 1. Match exception type to registered handler                           │
│ 2. Call handler function with exception                                 │
│ 3. Return response from handler                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ Registered Handlers (error_handlers.py)                                 │
│                                                                          │
│ HTTP Errors:                                                            │
│ • 400 → handle_bad_request                                              │
│ • 401 → handle_unauthorized                                             │
│ • 403 → handle_forbidden                                                │
│ • 404 → handle_not_found                                                │
│ • 405 → handle_method_not_allowed                                       │
│ • 409 → handle_conflict                                                 │
│ • 422 → handle_unprocessable_entity                                     │
│ • 429 → handle_rate_limit                                               │
│ • 500 → handle_internal_error                                           │
│                                                                          │
│ Custom Exceptions:                                                       │
│ • HTTPException → handle_http_exception                                 │
│ • ValidationError → handle_pydantic_validation_error                    │
│ • PermissionDeniedError → handle_permission_denied                      │
│ • RoleNotFoundError → handle_role_not_found                             │
│ • IntegrityError → handle_integrity_error                               │
│ • OperationalError → handle_operational_error                           │
│ • ...                                                                    │
└─────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ Standardized Error Response                                             │
│ {"success": false, "data": null, "error": {...}, "meta": null}          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Registration

```python
# app/__init__.py

from app.utils.error_handlers import register_error_handlers

def create_app(config_name="default"):
    app = OpenAPI(__name__, ...)

    # Register global error handlers
    register_error_handlers(app)

    return app
```

### Handler Categories

#### HTTP Error Handlers

```python
@app.errorhandler(404)
def handle_not_found(error):
    return error_response(
        code=ErrorCode.NOT_FOUND,
        message="The requested resource was not found",
        status_code=404
    )
```

#### Pydantic Validation Handler

```python
@app.errorhandler(ValidationError)
def handle_pydantic_validation_error(error: ValidationError):
    details = {}
    for err in error.errors():
        field = ".".join(str(l) for l in err["loc"] if l != "body")
        details[field] = err["msg"]

    return error_response(
        code=ErrorCode.VALIDATION_ERROR,
        message="Validation failed",
        details=details,
        status_code=422
    )
```

#### Database Error Handlers

```python
@app.errorhandler(IntegrityError)
def handle_integrity_error(error: IntegrityError):
    """Handle unique constraint violations, foreign key errors, etc."""
    logger.error("Database IntegrityError", exc_info=True)

    return error_response(
        code=ErrorCode.CONFLICT,
        message="A record with this information already exists",
        status_code=409
    )

@app.errorhandler(OperationalError)
def handle_operational_error(error: OperationalError):
    """Handle database connection errors."""
    logger.critical("Database unavailable", exc_info=True)

    return error_response(
        code=ErrorCode.DATABASE_ERROR,
        message="Service temporarily unavailable",
        status_code=503
    )
```

#### RBAC Error Handlers

```python
@app.errorhandler(PermissionDeniedError)
def handle_permission_denied(error: PermissionDeniedError):
    return error_response(
        code=ErrorCode.FORBIDDEN,
        message=error.message,
        details={"required_permissions": error.required_permissions},
        status_code=403
    )
```

### flask-openapi3 Validation Callback

```python
def pydantic_validation_error_callback(error: ValidationError):
    """
    Custom callback for flask-openapi3's built-in validation.

    flask-openapi3 validates BEFORE the route handler runs.
    This callback ensures validation errors match our format.
    """
    details = {}
    for err in error.errors():
        field = ".".join(str(l) for l in err["loc"] if l != "body")
        details[field] = err["msg"]

    response_body = {
        "success": False,
        "data": None,
        "error": {
            "code": ErrorCode.VALIDATION_ERROR.value,
            "message": "Validation failed",
            "details": details,
        },
        "meta": None,
    }

    return make_response(jsonify(response_body), 422)
```

---

## logging_config.py - Logging System

### Purpose

Provides centralized, structured logging with request correlation.

### Key Components

| Component                        | Purpose                              |
| -------------------------------- | ------------------------------------ |
| `setup_logging(app)`             | Initialize logging system            |
| `get_request_id()`               | Get current request's correlation ID |
| `get_logger(name)`               | Get a configured logger              |
| `mask_sensitive_data(data)`      | Redact sensitive fields              |
| `log_function_call()`            | Decorator for automatic logging      |
| `JSONFormatter`                  | Format logs as JSON                  |
| `ColoredRequestContextFormatter` | Colored console output               |

### Usage

```python
import logging

logger = logging.getLogger(__name__)

logger.info(f"User created: user_id={user.id}")
logger.warning(f"Login failed: user_id={user.id}")
logger.error(f"Database error: {e}", exc_info=True)
```

### Request Middleware

The logging system registers Flask middleware:

```python
@app.before_request
def before_request():
    """Generate/retrieve request ID and log start."""
    g.request_id = request.headers.get("X-Request-ID") or str(uuid.uuid4())[:8]
    g.request_start_time = time.time()
    logger.info("Request started", extra={...})

@app.after_request
def after_request(response):
    """Log completion and add request ID header."""
    duration = time.time() - g.request_start_time
    logger.info("Request completed", extra={"duration_ms": duration * 1000, ...})
    response.headers["X-Request-ID"] = g.request_id
    return response
```

---

## rate_limiter.py - Rate Limiting

### Purpose

Configures Flask-Limiter for API rate limiting.

### Configuration

```python
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address

limiter = Limiter(
    key_func=get_remote_address,
    default_limits=["200 per day", "50 per hour"],
    storage_uri="memory://",  # or "redis://localhost:6379"
)
```

### Initialization

```python
# app/__init__.py
from app.utils.rate_limiter import limiter

def create_app(config_name="default"):
    app = Flask(__name__)
    limiter.init_app(app)
    return app
```

### Usage

```python
from app.utils.rate_limiter import limiter

@bp.route("/login")
@limiter.limit("5 per minute")  # Stricter limit for sensitive endpoints
def login():
    ...
```

### Rate Limit Storage

| Storage | Use Case    | Configuration                     |
| ------- | ----------- | --------------------------------- |
| Memory  | Development | `storage_uri="memory://"`         |
| Redis   | Production  | `storage_uri="redis://host:6379"` |

---

## Module Exports

### \_\_init\_\_.py

```python
"""
Utils Package - Centralized utility functions for the application.

This package contains:
1. Response utilities for standardized API responses
2. Error handlers for global exception handling
3. Logging configuration for centralized, structured logging

The goal is to ensure ALL API endpoints return consistent,
predictable JSON responses following a standard envelope format.
"""

from app.utils.error_handlers import (
    pydantic_validation_error_callback,
    register_error_handlers,
)
from app.utils.logging_config import (
    get_logger,
    get_request_id,
    log_function_call,
    mask_sensitive_data,
    setup_logging,
)
from app.utils.responses import (
    ErrorCode,
    ErrorDetail,
    MetaInfo,
    StandardErrorResponse,
    StandardSuccessResponse,
    error_response,
    success_response,
)

__all__ = [
    # Response utilities
    "success_response",
    "error_response",
    "ErrorCode",
    # Response schemas
    "StandardSuccessResponse",
    "StandardErrorResponse",
    "ErrorDetail",
    "MetaInfo",
    # Error handlers
    "register_error_handlers",
    "pydantic_validation_error_callback",
    # Logging utilities
    "setup_logging",
    "get_logger",
    "get_request_id",
    "mask_sensitive_data",
    "log_function_call",
]
```

### Import Patterns

```python
# Method 1: Import from utils package
from app.utils import success_response, error_response, ErrorCode

# Method 2: Import from specific module
from app.utils.responses import success_response
from app.utils.logging_config import get_request_id

# Method 3: Import everything needed
from app.utils import (
    success_response,
    error_response,
    ErrorCode,
    get_request_id,
)
```

---

## How It All Connects

### Initialization Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│ create_app() in app/__init__.py                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 1. setup_logging(app)                                                    │
│    - Configure loggers                                                  │
│    - Register request middleware (before/after)                         │
└─────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 2. Initialize extensions (db, jwt, limiter)                             │
└─────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 3. register_error_handlers(app)                                         │
│    - Register HTTP error handlers (400, 401, 403, 404, ...)            │
│    - Register exception handlers (ValidationError, IntegrityError, ...) │
└─────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 4. Register blueprints                                                   │
│    - Routes use success_response/error_response                         │
│    - Routes are protected by rate limiter                               │
└─────────────────────────────────────────────────────────────────────────┘
```

### Request Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│ HTTP Request                                                             │
└─────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ Rate Limiter Check                                                       │
│ - OK → Continue                                                          │
│ - Exceeded → 429 via error handler                                      │
└─────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ Logging Middleware (before_request)                                      │
│ - Generate request_id                                                   │
│ - Start timer                                                           │
│ - Log "Request started"                                                 │
└─────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ Pydantic Validation (flask-openapi3)                                    │
│ - Valid → Continue to route                                             │
│ - Invalid → pydantic_validation_error_callback()                        │
└─────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ Route Handler                                                            │
│ - Uses logger for all logging                                           │
│ - Calls services                                                        │
│ - Returns success_response() or error_response()                        │
│ - If exception → Global error handler                                   │
└─────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ Logging Middleware (after_request)                                       │
│ - Calculate duration                                                    │
│ - Log "Request completed"                                               │
│ - Add X-Request-ID header                                               │
└─────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ HTTP Response                                                            │
│ {"success": ..., "data": ..., "error": ..., "meta": ...}                │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Summary

### Utils Module Components

| File                | Purpose                                      |
| ------------------- | -------------------------------------------- |
| `responses.py`      | Standardized response formatting             |
| `error_handlers.py` | Global exception handling                    |
| `logging_config.py` | Centralized logging with request correlation |
| `rate_limiter.py`   | API rate limiting configuration              |
| `__init__.py`       | Clean exports for all utilities              |

### Quick Reference

```python
# Response utilities
from app.utils import success_response, error_response, ErrorCode

# Logging
import logging
logger = logging.getLogger(__name__)

# Request ID
from app.utils import get_request_id
```

---

## Next Steps

This completes the `06_architecture/` documentation. Continue to:

-   **[07_devops/](../07_devops/)** - Docker, CI/CD, deployment
-   **[08_testing/](../08_testing/)** - Testing strategies
-   **[09_reference/](../09_reference/)** - Quick reference guides

---

> **Related Documentation:**
>
> -   [4.10 Response Format](../04_api_design/4.10_response_format.md)
> -   [4.11 Error Handling](../04_api_design/4.11_error_handling.md)
> -   [docs/STANDARDIZED_API_RESPONSES.md](../../docs/STANDARDIZED_API_RESPONSES.md)
