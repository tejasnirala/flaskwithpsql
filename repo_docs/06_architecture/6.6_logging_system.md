# 6.6 Logging System

> **Structured, Production-Ready Logging for Flask**

This document explains the centralized logging system implemented in our Flask application. We'll cover the architecture, configuration, and best practices for logging in a production environment.

---

## Table of Contents

1. [Overview](#overview)
2. [Why Centralized Logging?](#why-centralized-logging)
3. [Architecture](#architecture)
4. [Configuration](#configuration)
5. [Log Levels](#log-levels)
6. [Request Correlation](#request-correlation)
7. [Log Formats](#log-formats)
8. [Sensitive Data Protection](#sensitive-data-protection)
9. [Usage Guide](#usage-guide)
10. [Best Practices](#best-practices)

---

## Overview

Our logging system provides:

| Feature                     | Description                                    |
| --------------------------- | ---------------------------------------------- |
| **Structured JSON Logging** | Machine-parseable logs for aggregation tools   |
| **Request ID Correlation**  | Trace all logs from a single request           |
| **Sensitive Data Masking**  | Automatic redaction of passwords, tokens, etc. |
| **Dual Output**             | Console (human-readable) + File (JSON)         |
| **Daily Rotation**          | New log file each day with automatic cleanup   |
| **Colored Console Output**  | Color-coded log levels for development         |

---

## Why Centralized Logging?

### Before: Scattered Configuration

```python
# Route 1
import logging
logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)

# Route 2
import logging
logging.basicConfig(level=logging.INFO, format='...')  # Different config!
logger = logging.getLogger(__name__)
```

**Problems:**

-   Inconsistent log formats
-   Different levels in different modules
-   No request correlation
-   Sensitive data might be logged

### After: Centralized Configuration

```python
# Any module
import logging
logger = logging.getLogger(__name__)

# Just use it - configuration is handled centrally
logger.info("User created successfully")
```

**Benefits:**

-   Single configuration point
-   Consistent format everywhere
-   Automatic request ID injection
-   Automatic sensitive data masking

---

## Architecture

### Component Overview

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Logging System                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌────────────────────────────┐    ┌────────────────────────────┐      │
│   │     logging_config.py     │    │     Request Middleware      │      │
│   │                            │    │                            │      │
│   │  • setup_logging()         │◄───│  • before_request          │      │
│   │  • JSONFormatter           │    │  • after_request           │      │
│   │  • ColoredFormatter        │    │  • request_id generation   │      │
│   │  • mask_sensitive_data()   │    │  • timing                  │      │
│   └────────────────────────────┘    └────────────────────────────┘      │
│                │                                                         │
│                ▼                                                         │
│   ┌──────────────────────────────────────────────────────────────┐      │
│   │                     Python Logging                            │      │
│   │                                                               │      │
│   │   ┌─────────────────────┐    ┌─────────────────────────────┐ │      │
│   │   │   Console Handler   │    │      File Handler           │ │      │
│   │   │   (StreamHandler)   │    │ (TimedRotatingFileHandler)  │ │      │
│   │   │                     │    │                             │ │      │
│   │   │   stdout            │    │   logs/app.log              │ │      │
│   │   │   Color in dev      │    │   logs/app.log.2026-01-14   │ │      │
│   │   └─────────────────────┘    └─────────────────────────────┘ │      │
│   └──────────────────────────────────────────────────────────────┘      │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### File Structure

```
app/
├── utils/
│   ├── __init__.py           # Exports logging utilities
│   └── logging_config.py     # Main logging configuration
│
logs/
├── app.log                   # Current day's logs (JSON)
├── app.log.2026-01-14        # Yesterday's logs
├── app.log.2026-01-13        # Two days ago
└── ...                       # Retained for LOG_RETENTION_DAYS
```

---

## Configuration

### Environment Variables

| Variable             | Default        | Description                |
| -------------------- | -------------- | -------------------------- |
| `LOG_LEVEL`          | `DEBUG`/`INFO` | Minimum log level          |
| `LOG_RETENTION_DAYS` | `30`           | Days to keep old log files |

### Initialization

```python
# app/__init__.py

from app.utils.logging_config import setup_logging

def create_app(config_name="default"):
    app = OpenAPI(__name__, info=info)
    app.config.from_object(config_class)

    # Initialize logging early (before other extensions)
    setup_logging(app)

    # ... rest of initialization
```

### What `setup_logging()` Does

```python
def setup_logging(app: Flask) -> None:
    """
    Configure centralized logging for the Flask application.

    1. Determine environment (debug vs production)
    2. Create log directory if needed
    3. Configure root logger
    4. Add console handler (colored in dev, JSON in prod)
    5. Add file handler (JSON, rotating daily)
    6. Suppress noisy third-party loggers
    7. Register request lifecycle middleware
    """
```

---

## Log Levels

### Python's Five Levels

```
                          SEVERITY
                              ▲
    ┌─────────────────────────┼─────────────────────────┐
    │                         │                         │
    │  CRITICAL (50) ─────────┼──── Application dying   │
    │       │                 │                         │
    │  ERROR (40) ────────────┼──── Request failed      │
    │       │                 │                         │
    │  WARNING (30) ──────────┼──── Something fishy     │
    │       │                 │                         │
    │  INFO (20) ─────────────┼──── Normal events       │
    │       │                 │                         │
    │  DEBUG (10) ────────────┼──── Developer details   │
    │                         │                         │
    └─────────────────────────┼─────────────────────────┘
                              ▼
                         Less Important
```

### When to Use Each Level

| Level      | Use For                       | Examples                              |
| ---------- | ----------------------------- | ------------------------------------- |
| `DEBUG`    | Internal development details  | Variable values, query results count  |
| `INFO`     | Normal application flow       | User actions, startup, shutdown       |
| `WARNING`  | Unexpected but recoverable    | Auth failures, approaching limits     |
| `ERROR`    | Request failed, app continues | Database errors, API call failures    |
| `CRITICAL` | Application-level failure     | Pool exhausted, required service down |

### Examples

```python
logger = logging.getLogger(__name__)

# DEBUG - Development details
logger.debug(f"Retrieved {len(users)} users from database")
logger.debug(f"Cache key: {cache_key}, hit: {was_hit}")

# INFO - Normal business events
logger.info(f"User registered: user_id={user.id}")
logger.info("Server started on port 5500")
logger.info(f"Request completed: status={status}")

# WARNING - Potentially problematic
logger.warning(f"Login failed for user_id={user.id}")
logger.warning("Rate limit approaching: 90% used")

# ERROR - Request failure
logger.error(f"Database query failed: {error}", exc_info=True)
logger.error("External API timeout")

# CRITICAL - System failure
logger.critical("Database connection pool exhausted!")
logger.critical("Required service unavailable")
```

---

## Request Correlation

### How It Works

Every request gets a unique ID that appears in all related logs:

```
┌─────────────────────────────────────────────────────────────────────────┐
│ Request arrives                                                          │
│ (optionally with X-Request-ID header)                                   │
└─────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ before_request middleware                                                │
│                                                                          │
│ 1. Check for X-Request-ID header (distributed tracing)                  │
│ 2. Generate UUID if none                                                │
│ 3. Store in Flask's g.request_id                                        │
│ 4. Store start time in g.request_start_time                             │
│ 5. Log: "Request started"                                               │
└─────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ Route Handler                                                            │
│                                                                          │
│ All logs automatically include:                                          │
│ [request_id] METHOD PATH | message                                       │
│                                                                          │
│ Example:                                                                 │
│ [abc12345] POST /api/v1/users/register | Creating user: john            │
│ [abc12345] POST /api/v1/users/register | User created: id=42            │
└─────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ after_request middleware                                                 │
│                                                                          │
│ 1. Calculate duration                                                   │
│ 2. Determine log level (2xx=INFO, 4xx=WARNING, 5xx=ERROR)              │
│ 3. Log: "Request completed"                                             │
│ 4. Add X-Request-ID to response headers                                 │
└─────────────────────────────────────────────────────────────────────────┘
```

### Using Request ID

```python
from app.utils.logging_config import get_request_id

def some_function():
    request_id = get_request_id()

    # Pass to external services for tracing
    external_api.call(
        trace_id=request_id,
        # ...
    )
```

### Client-Side Correlation

The request ID is returned in response headers:

```bash
curl -i http://localhost:5500/api/v1/users/1

# Response headers include:
# X-Request-ID: abc12345
```

Clients can include this in bug reports for easier debugging.

---

## Log Formats

### Console Format (Development)

Human-readable with colors:

```
2026-01-15 08:30:45 | INFO     | app.routes.users | [abc12345] POST /api/users | User created
2026-01-15 08:30:46 | WARNING  | app.auth         | [def67890] POST /api/login | Login failed
2026-01-15 08:30:47 | ERROR    | app.services     | [ghi13579] GET /api/users | Database error
```

Format breakdown:

-   `2026-01-15 08:30:45` - Timestamp
-   `INFO` - Log level (padded, colored)
-   `app.routes.users` - Logger name (module path)
-   `[abc12345]` - Request ID
-   `POST /api/users` - HTTP method and path
-   `User created` - Your message

### JSON Format (File & Production Console)

```json
{
    "timestamp": "2026-01-15T08:30:45.123456+00:00",
    "level": "INFO",
    "logger": "app.routes.users",
    "request_id": "abc12345",
    "method": "POST",
    "path": "/api/v1/users/register",
    "message": "User created successfully",
    "extra": {
        "user_id": 42,
        "username": "john_doe"
    }
}
```

### Why JSON for Files?

1. **Parseable** - ELK, Splunk, CloudWatch can parse it
2. **Queryable** - Filter by any field
3. **Structured** - Consistent field names
4. **Extensible** - Add fields without breaking parsers

---

## Sensitive Data Protection

### Automatic Masking

The logging system automatically masks sensitive fields:

```python
SENSITIVE_FIELDS = frozenset([
    "password",
    "password_hash",
    "token",
    "access_token",
    "refresh_token",
    "api_key",
    "secret",
    "secret_key",
    "authorization",
    "credential",
    "private_key",
    "credit_card",
    "cvv",
    "ssn",
])
```

### How It Works

```python
# Before masking
{"username": "john", "password": "secret123", "api_key": "abc123"}

# After masking
{"username": "john", "password": "***REDACTED***", "api_key": "***REDACTED***"}
```

### Token Detection

Strings that look like tokens are also masked:

```python
# Detected and masked:
"Bearer eyJhbGciOiJIUzI1NiIs..." → "***REDACTED***"
"Token sk-abc123..." → "***REDACTED***"
```

### Safe Logging Practices

```python
# ✅ GOOD - Log only non-sensitive identifiers
logger.info(f"User created: user_id={user.id}")
logger.warning(f"Login failed: user_id={user.id}")

# ❌ BAD - Never log sensitive data
logger.info(f"User created: password={password}")  # NEVER!
logger.warning(f"Login failed: email={email}")     # Could enable enumeration
```

---

## Usage Guide

### Basic Usage

```python
import logging

# Create a logger for this module
logger = logging.getLogger(__name__)

def some_function():
    logger.info("Operation started")
    try:
        # ... do something ...
        logger.info("Operation completed successfully")
    except Exception as e:
        logger.error(f"Operation failed: {e}", exc_info=True)
        raise
```

### Adding Extra Context

```python
logger.info(
    "User action completed",
    extra={
        "user_id": user.id,
        "action": "purchase",
        "item_count": 3
    }
)
```

JSON output:

```json
{
    "message": "User action completed",
    "extra": {
        "user_id": 42,
        "action": "purchase",
        "item_count": 3
    }
}
```

### Logging Exceptions

```python
try:
    risky_operation()
except Exception as e:
    # exc_info=True includes the traceback
    logger.error(f"Operation failed: {e}", exc_info=True)
```

### Using `@log_function_call` Decorator

```python
from app.utils.logging_config import log_function_call

@log_function_call()
def process_payment(order_id: int, amount: float):
    """Automatically logs entry and exit."""
    # ...
```

Produces:

```
DEBUG | Entering process_payment(order_id=123, amount=99.99)
DEBUG | Exiting process_payment successfully
```

---

## Best Practices

### DO ✅

1. **Use module-level loggers**

    ```python
    logger = logging.getLogger(__name__)
    ```

2. **Use appropriate log levels**

    ```python
    logger.debug(...)   # Internal details
    logger.info(...)    # Business events
    logger.warning(...) # Recoverable issues
    logger.error(...)   # Failures
    ```

3. **Include identifying information**

    ```python
    logger.info(f"User updated: user_id={user.id}")
    ```

4. **Use `exc_info=True` for exceptions**

    ```python
    logger.error(f"Failed: {e}", exc_info=True)
    ```

5. **Log at function boundaries**
    ```python
    def process_order(order_id):
        logger.info(f"Processing order: order_id={order_id}")
        # ...
        logger.info(f"Order processed: order_id={order_id}")
    ```

### DON'T ❌

1. **Never log sensitive data**

    ```python
    # ❌ BAD
    logger.info(f"Login: password={password}")
    ```

2. **Don't use print**

    ```python
    # ❌ BAD
    print("User created")

    # ✅ GOOD
    logger.info("User created")
    ```

3. **Don't log too much at INFO**

    ```python
    # ❌ BAD - Should be DEBUG
    logger.info(f"Checking if {variable} > 10")
    ```

4. **Don't suppress exceptions silently**

    ```python
    # ❌ BAD
    except Exception:
        pass  # At least log it!

    # ✅ GOOD
    except Exception as e:
        logger.error(f"Error: {e}", exc_info=True)
    ```

---

## Log Rotation

### Configuration

```python
# TimedRotatingFileHandler settings
when = "midnight"          # Rotate at midnight
interval = 1               # Every 1 day
backupCount = 30           # Keep 30 days
utc = True                 # Use UTC time
suffix = "%Y-%m-%d"        # Date format for files
```

### File Structure

```
logs/
├── app.log              # Current day (always this name)
├── app.log.2026-01-14   # Yesterday
├── app.log.2026-01-13   # Two days ago
├── app.log.2026-01-12   # Three days ago
└── ...                  # Up to 30 days
```

### Finding Logs

```bash
# View today's logs
cat logs/app.log

# View logs from specific date
cat logs/app.log.2026-01-14

# Search for errors on a date
grep '"level": "ERROR"' logs/app.log.2026-01-14

# Search for a specific request ID across all logs
grep 'abc12345' logs/app.log*
```

---

## Summary

### Key Components

| Component               | Purpose                              |
| ----------------------- | ------------------------------------ |
| `setup_logging()`       | Initialize logging system            |
| `get_request_id()`      | Get current request's correlation ID |
| `JSONFormatter`         | Format logs as JSON for files        |
| `ColoredFormatter`      | Human-readable console output        |
| `mask_sensitive_data()` | Redact sensitive information         |
| `@log_function_call`    | Decorator for automatic logging      |

### Quick Reference

```python
import logging
logger = logging.getLogger(__name__)

# Use these levels
logger.debug("Internal details")
logger.info("Business events")
logger.warning("Potential issues")
logger.error("Failures", exc_info=True)
logger.critical("System failures")
```

---

## Next Steps

-   **[6.7 Utils Module](./6.7_utils_module.md)** - The complete utils package
-   **[6.1 Architecture Overview](./6.1_architecture_overview.md)** - Overall architecture
-   **[docs/LOGGING_EXPLAINED.md](../../docs/LOGGING_EXPLAINED.md)** - Deep dive into implementation

---

> **Related Documentation:**
>
> -   [app/utils/logging_config.py](../../app/utils/logging_config.py) - Implementation
> -   [docs/LOGGING_SYSTEM.md](../../docs/LOGGING_SYSTEM.md) - Additional details
