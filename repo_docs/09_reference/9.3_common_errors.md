# 9.3 Common Errors

> **Troubleshooting Guide for Frequently Encountered Issues**

This reference document provides solutions for common errors you might encounter while working with this project.

---

## Table of Contents

1. [Database Errors](#database-errors)
2. [Flask Errors](#flask-errors)
3. [Authentication Errors](#authentication-errors)
4. [Docker Errors](#docker-errors)
5. [Testing Errors](#testing-errors)
6. [Pre-commit Errors](#pre-commit-errors)

---

## Database Errors

### Connection Refused

```
sqlalchemy.exc.OperationalError: (psycopg2.OperationalError)
connection refused
    Is the server running on host "localhost" and accepting
    TCP/IP connections on port 5432?
```

**Causes:**

-   PostgreSQL not running
-   Wrong host/port
-   Docker not started

**Solutions:**

```bash
# Check if PostgreSQL is running
pg_isready -h localhost -p 5432

# Start PostgreSQL (macOS)
brew services start postgresql

# If using Docker
docker compose up db
```

---

### Database Does Not Exist

```
sqlalchemy.exc.OperationalError: (psycopg2.OperationalError)
FATAL:  database "flaskwithpsql" does not exist
```

**Solution:**

```bash
# Create the database
createdb flaskwithpsql

# Or using psql
psql -U postgres -c "CREATE DATABASE flaskwithpsql;"
```

---

### Schema Does Not Exist

```
sqlalchemy.exc.ProgrammingError:
(psycopg2.errors.UndefinedTable) relation "users.users" does not exist
```

**Causes:**

-   Migrations not run
-   Schema not created

**Solutions:**

```bash
# Run migrations
flask db upgrade

# Or create schema manually
psql -U postgres -d flaskwithpsql -c "CREATE SCHEMA IF NOT EXISTS users;"
```

---

### Migration Conflict

```
alembic.util.exc.CommandError: Can't locate revision identified by 'abc123'
```

**Causes:**

-   Missing migration file
-   Corrupted migration history

**Solutions:**

```bash
# Option 1: Stamp to current state
flask db stamp head

# Option 2: Reset migrations (loses data!)
flask db downgrade base
rm -rf migrations/versions/*
flask db migrate -m "initial"
flask db upgrade
```

---

### Unique Constraint Violation

```
sqlalchemy.exc.IntegrityError:
(psycopg2.errors.UniqueViolation)
duplicate key value violates unique constraint "users_email_key"
```

**Cause:** Trying to insert duplicate value for unique field

**Solution:** Check your code handles duplicates:

```python
# Before creating
if User.query.filter_by(email=email).first():
    raise UserAlreadyExistsError("email", email)
```

---

## Flask Errors

### Application Not Found

```
Error: Could not locate a Flask application.
```

**Causes:**

-   `FLASK_APP` not set
-   Wrong working directory

**Solutions:**

```bash
# Set FLASK_APP
export FLASK_APP=run.py

# Or run from project root
cd /path/to/flaskwithpsql
flask run
```

---

### Application Context Error

```
RuntimeError: Working outside of application context.
```

**Cause:** Accessing Flask components outside request/app context

**Solutions:**

```python
# Solution 1: Use with statement
with app.app_context():
    user = User.query.first()

# Solution 2: In routes, it's automatic
@app.route("/")
def index():
    user = User.query.first()  # Works fine
```

---

### Blueprint Registration Error

```
AssertionError: The name 'users' is already registered for a different blueprint.
```

**Cause:** Duplicate blueprint registration

**Solution:** Check `app/__init__.py` for duplicate registrations:

```python
# Wrong - registering twice
app.register_blueprint(users_bp)
app.register_blueprint(users_bp)  # Error!

# Correct - register once
app.register_blueprint(users_bp)
```

---

### Import Error

```
ImportError: cannot import name 'User' from 'app.models'
```

**Solutions:**

```python
# Check the import path
from app.models.user import User  # Correct

# Check __init__.py exports
# app/models/__init__.py
from .user import User

# Then you can use:
from app.models import User
```

---

## Authentication Errors

### JWT Token Missing

```json
{
    "msg": "Missing Authorization Header"
}
```

**Cause:** No token provided for protected route

**Solution:**

```bash
# Include token in header
curl -H "Authorization: Bearer YOUR_TOKEN" http://localhost:5500/api/v1/auth/me
```

---

### JWT Token Expired

```json
{
    "msg": "Token has expired"
}
```

**Solution:** Use refresh token to get new access token:

```bash
curl -X POST http://localhost:5500/api/v1/auth/refresh \
  -H "Authorization: Bearer YOUR_REFRESH_TOKEN"
```

---

### JWT Token Invalid

```json
{
    "msg": "Signature verification failed"
}
```

**Causes:**

-   Token was modified
-   Wrong secret key
-   Token from different environment

**Solutions:**

-   Check `JWT_SECRET_KEY` matches
-   Get a fresh token by logging in again

---

### Invalid Credentials

```json
{
    "success": false,
    "error": {
        "code": "INVALID_CREDENTIALS"
    }
}
```

**Cause:** Wrong email or password

**Solution:** Verify credentials, reset password if necessary

---

## Docker Errors

### Container Won't Start

```
Error response from daemon: Ports are not available:
port is already allocated
```

**Solution:**

```bash
# Find what's using the port
lsof -i :5500

# Kill the process or use different port
docker compose down
docker compose up
```

---

### Volume Permission Error

```
PermissionError: [Errno 13] Permission denied
```

**Solutions:**

```bash
# Check volume permissions
ls -la ./

# Fix permissions (Linux/Mac)
chmod -R 755 ./

# Or rebuild without cache
docker compose build --no-cache
```

---

### Database Connection in Docker

```
could not connect to server: Connection refused
    Is the server running on host "localhost"
```

**Cause:** Using `localhost` inside Docker (should use service name)

**Solution:** Use Docker service name:

```yaml
# In docker-compose.yml
DATABASE_URL=postgresql://postgres:postgres@db:5432/flaskwithpsql
#                                             ^^ service name, not localhost
```

---

### Out of Memory

```
Error: No space left on device
```

**Solution:**

```bash
# Clean up Docker
docker system prune -a --volumes

# Check disk space
df -h
```

---

## Testing Errors

### Fixture Not Found

```
fixture 'sample_user' not found
```

**Cause:** Fixture not defined or not in conftest.py

**Solution:** Check `tests/conftest.py` contains the fixture

---

### Database Not Clean Between Tests

```
IntegrityError: duplicate key value violates unique constraint
```

**Cause:** Test data persisting between tests

**Solution:** Ensure `db` fixture drops tables:

```python
@pytest.fixture
def db(app):
    with app.app_context():
        _db.create_all()
        yield _db
        _db.session.remove()
        _db.drop_all()  # This is important!
```

---

### Import Error in Tests

```
ModuleNotFoundError: No module named 'app'
```

**Solutions:**

```bash
# Run from project root
cd /path/to/flaskwithpsql
pytest

# Or install package in dev mode
pip install -e .
```

---

### Coverage Reports Missing Files

```
Coverage report shows 0 files
```

**Solution:**

```bash
# Specify correct source
pytest --cov=app  # Not --cov=./app

# Check .coveragerc or pyproject.toml
```

---

## Pre-commit Errors

### Black Formatting Failed

```
black......................................................Failed
- files were modified by this hook
```

**Solution:** Files were auto-formatted, stage and commit again:

```bash
git add .
git commit -m "your message"
```

---

### Flake8 Errors

```
flake8.....................................................Failed
app/routes/users.py:42:1: F401 'os' imported but unused
```

**Solution:** Fix the issue (remove unused import) and commit again

---

### Hook Installation Failed

```
An error has occurred: GitCommandError
```

**Solutions:**

```bash
# Clean and reinstall
pre-commit clean
pre-commit install

# Update hooks
pre-commit autoupdate
```

---

### Commit Message Rejected

```
conventional-pre-commit...................................Failed
bad commit message: "fixed stuff"
```

**Solution:** Use conventional format:

```bash
git commit -m "fix: resolve login issue"
# or
git commit -m "feat: add user registration"
```

---

## Quick Fixes

### Reset Everything

```bash
# Nuclear option - restart fresh
docker compose down -v          # Stop and remove volumes
rm -rf migrations/versions/*    # Remove migrations
rm -rf __pycache__              # Clear cache
rm -rf .pytest_cache            # Clear test cache

# Restart
docker compose up --build
flask db migrate -m "initial"
flask db upgrade
```

### Check Environment

```bash
# Verify environment variables
echo $DATABASE_URL
echo $FLASK_APP
echo $FLASK_ENV

# Check Python version
python --version

# Check installed packages
pip list | grep Flask
```

### Debug Mode

```python
# Add debug prints
print(f"User: {user}")
print(f"Data: {data}")

# Or use breakpoint
breakpoint()  # Drops into debugger
```

---

## Where to Get Help

1. **Check logs** - `docker compose logs web`
2. **Search errors** - Copy exact error message
3. **Check docs** - See relevant `repo_docs/` section
4. **Flask docs** - https://flask.palletsprojects.com/
5. **SQLAlchemy docs** - https://docs.sqlalchemy.org/

---

> **Related Documentation:**
>
> -   [Command Cheatsheet](./9.1_command_cheatsheet.md)
> -   [File Reference](./9.2_file_quick_reference.md)
