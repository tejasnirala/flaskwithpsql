# =============================================================================
# GitHub Actions CI/CD Pipeline
# =============================================================================
# Runs tests, linting, and security checks on every push and PR
# =============================================================================

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: "3.11"
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  POSTGRES_DB: flaskwithpsql_test

jobs:
  # ===========================================================================
  # Linting and Code Quality
  # ===========================================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black isort flake8 mypy

      - name: Check formatting with Black
        run: black --check --line-length=100 app/ tests/

      - name: Check import sorting with isort
        run: isort --check-only --profile=black --line-length=100 app/ tests/

      - name: Lint with flake8
        run: |
          flake8 app/ tests/ \
            --max-line-length=100 \
            --extend-ignore=E203,W503 \
            --exclude=__pycache__,migrations

      - name: Type check with mypy
        run: mypy app/ --ignore-missing-imports
        continue-on-error: true # Don't fail on type errors for now

  # ===========================================================================
  # Security Scanning
  # ===========================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety

      - name: Run Bandit security scan
        run: bandit -r app/ -x tests/ -ll
        continue-on-error: true

      - name: Check dependencies for vulnerabilities
        run: |
          pip install -r requirements.txt
          safety check --full-report
        continue-on-error: true

  # # ===========================================================================
  # # Unit and Integration Tests
  # # ===========================================================================
  # test:
  #   name: Test (Python ${{ matrix.python-version }})
  #   runs-on: ubuntu-latest

  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       python-version: ["3.9", "3.10", "3.11", "3.12"]

  #   services:
  #     postgres:
  #       image: postgres:15-alpine
  #       env:
  #         POSTGRES_USER: ${{ env.POSTGRES_USER }}
  #         POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
  #         POSTGRES_DB: ${{ env.POSTGRES_DB }}
  #       ports:
  #         - 5432:5432
  #       options: >-
  #         --health-cmd pg_isready
  #         --health-interval 10s
  #         --health-timeout 5s
  #         --health-retries 5

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Set up Python ${{ matrix.python-version }}
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ matrix.python-version }}
  #         cache: "pip"

  #     - name: Install dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install -r requirements.txt
  #         pip install pytest pytest-cov

  #     - name: Create users schema
  #       run: |
  #         PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql \
  #           -h localhost \
  #           -U ${{ env.POSTGRES_USER }} \
  #           -d ${{ env.POSTGRES_DB }} \
  #           -c "CREATE SCHEMA IF NOT EXISTS users;"

  #     - name: Run tests with coverage
  #       env:
  #         FLASK_ENV: testing
  #         TEST_DATABASE_URL: postgresql://${{ env.POSTGRES_USER }}:${{ env.POSTGRES_PASSWORD }}@localhost:5432/${{ env.POSTGRES_DB }}
  #         SECRET_KEY: test-secret-key-for-ci
  #       run: |
  #         pytest --cov=app --cov-report=xml --cov-report=term-missing -v

  #     - name: Upload coverage to Codecov
  #       uses: codecov/codecov-action@v3
  #       with:
  #         files: ./coverage.xml
  #         fail_ci_if_error: false
  #       if: matrix.python-version == '3.11'

  # # ===========================================================================
  # # Build Docker Image
  # # ===========================================================================
  # build:
  #   name: Build Docker Image
  #   runs-on: ubuntu-latest
  #   needs: [lint, test]
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Set up Docker Buildx
  #       uses: docker/setup-buildx-action@v3

  #     - name: Build Docker image
  #       uses: docker/build-push-action@v5
  #       with:
  #         context: .
  #         push: false
  #         target: production
  #         tags: flaskwithpsql:${{ github.sha }}
  #         cache-from: type=gha
  #         cache-to: type=gha,mode=max

  #     - name: Run Trivy vulnerability scanner
  #       uses: aquasecurity/trivy-action@master
  #       with:
  #         image-ref: flaskwithpsql:${{ github.sha }}
  #         format: "table"
  #         exit-code: "0" # Don't fail on vulnerabilities
  #         severity: "CRITICAL,HIGH"
