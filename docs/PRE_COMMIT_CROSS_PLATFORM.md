# Pre-commit Hooks: Cross-Platform Setup Guide

This document explains the cross-platform pre-commit hook setup and how to troubleshoot common issues.

---

## üìã Overview

Pre-commit hooks run automatically before each `git commit` to enforce code quality. Our setup includes:

| Hook Type      | Purpose                                                                                       |
| -------------- | --------------------------------------------------------------------------------------------- |
| **pre-commit** | Linting, formatting, type checking, security scans, branch protection                         |
| **commit-msg** | Validates commit messages follow [Conventional Commits](https://www.conventionalcommits.org/) |

---

## ‚ö†Ô∏è The Cross-Platform Problem

### The Original Issue

Git hooks generated by `pre-commit install` are bash scripts:

```bash
#!/usr/bin/env bash
INSTALL_PYTHON=/Users/username/project/venv/bin/python3
```

This causes issues on Windows because:

1. **Bash shebang**: `#!/usr/bin/env bash` doesn't work on Windows CMD/PowerShell
2. **Hardcoded paths**: Mac paths like `/Users/...` don't exist on Windows
3. **Not version controlled**: `.git/hooks/` is local only, not shared via Git

### The Result

When a Windows developer clones the repo:

-   Hooks don't exist (not in Git)
-   If they copy hook files, they have Mac paths
-   Commits go through without validation
-   Code quality checks are bypassed

---

## ‚úÖ Our Solution

### 1. Cross-Platform Setup Script

We created `scripts/setup_hooks.py` - a Python script that works on all platforms:

```bash
python scripts/setup_hooks.py
```

This script:

-   ‚úÖ Uses Python (available on all platforms)
-   ‚úÖ Installs both `pre-commit` and `commit-msg` hooks
-   ‚úÖ Pre-installs hook environments
-   ‚úÖ Verifies installation
-   ‚úÖ Works on Windows, macOS, and Linux

### 2. CI Safety Net

We added `.github/workflows/commit-lint.yml` that:

-   ‚úÖ Validates commit messages in CI
-   ‚úÖ Catches issues even if local hooks failed
-   ‚úÖ Provides consistent validation across all contributors

### 3. Updated Documentation

-   Updated `docs/WINDOWS_SETUP_GUIDE.md` with proper hook installation
-   Added troubleshooting for common Windows issues

---

## üîß Installation Methods

### Method 1: Using the Setup Script (Recommended)

```bash
# Works on all platforms
python scripts/setup_hooks.py
```

### Method 2: Using Makefile

```bash
# On Mac/Linux
make setup-hooks

# On Windows (if Make is installed)
make setup-hooks
```

### Method 3: Manual Installation

```bash
# Install pre-commit package
pip install pre-commit

# Install pre-commit hooks
pre-commit install

# Install commit-msg hooks (IMPORTANT - often forgotten!)
pre-commit install --hook-type commit-msg

# Pre-install environments (optional, speeds up first commit)
pre-commit install-hooks
```

---

## üîç Verifying Installation

### Check Hook Files Exist

**macOS/Linux:**

```bash
ls -la .git/hooks/pre-commit .git/hooks/commit-msg
```

**Windows:**

```powershell
dir .git\hooks\pre-commit
dir .git\hooks\commit-msg
```

Both files should exist (not `.sample` files).

### Test the Hooks

```bash
# Run pre-commit on all files
pre-commit run --all-files

# Test with a sample commit
git add .
git commit -m "test: verify hooks are working"
# Should pass if message is valid
# Should fail if message is invalid (e.g., "test commit")
```

---

## üêõ Troubleshooting

### Hooks Not Running at All

**Symptom**: Commits go through without any checks

**Fixes**:

1. Verify hooks are installed: `ls .git/hooks/pre-commit`
2. Reinstall: `python scripts/setup_hooks.py`
3. Check if pre-commit is in PATH: `pre-commit --version`

### Can Commit to Main Branch

**Symptom**: `no-commit-to-branch` hook not blocking commits to main

**Fix**: The `no-commit-to-branch` hook only runs if pre-commit hooks are installed:

```bash
pre-commit install
```

### Commit Message Not Validated

**Symptom**: Invalid commit messages (e.g., "fixed stuff") are accepted

**Fix**: The commit-msg hook type must be explicitly installed:

```bash
pre-commit install --hook-type commit-msg
```

### Windows-Specific: Bash Not Found

**Symptom**: Error about bash not being available

**Fixes**:

1. Use Git Bash terminal for commits
2. Add Git's bin to PATH: `C:\Program Files\Git\bin`
3. Reinstall hooks with Git Bash open

---

## üìù Conventional Commits Reference

Valid commit message format:

```
<type>(<scope>): <description>

[optional body]

[optional footer]
```

### Valid Types

| Type       | Purpose          | Example                          |
| ---------- | ---------------- | -------------------------------- |
| `feat`     | New feature      | `feat: add user login`           |
| `fix`      | Bug fix          | `fix(auth): resolve token issue` |
| `docs`     | Documentation    | `docs: update API guide`         |
| `style`    | Formatting       | `style: fix indentation`         |
| `refactor` | Code restructure | `refactor: simplify auth flow`   |
| `perf`     | Performance      | `perf: optimize query`           |
| `test`     | Tests            | `test: add login tests`          |
| `build`    | Build system     | `build: update dockerfile`       |
| `ci`       | CI config        | `ci: add lint job`               |
| `chore`    | Maintenance      | `chore(deps): update flask`      |
| `revert`   | Revert commit    | `revert: revert "feat: x"`       |

### Invalid Examples

```
‚ùå fixed stuff
‚ùå Update code
‚ùå WIP
‚ùå FEAT: add login (should be lowercase)
‚ùå feat add login (missing colon)
```

---

## üîÑ CI Validation (Safety Net)

Even if local hooks fail, CI will catch issues:

```yaml
# .github/workflows/commit-lint.yml
- name: Validate commit messages
  uses: wagoid/commitlint-github-action@v6
```

This ensures:

-   All PRs have valid commit messages
-   Direct pushes are logged/warned
-   Consistent validation across team

---

## üìö Files Reference

| File                                | Purpose                     |
| ----------------------------------- | --------------------------- |
| `.pre-commit-config.yaml`           | Hook definitions            |
| `.commitlintrc.json`                | CI commit lint config       |
| `scripts/setup_hooks.py`            | Cross-platform setup script |
| `.github/workflows/commit-lint.yml` | CI commit validation        |

---

## üÜò Need Help?

1. Check this guide's troubleshooting section
2. Check `docs/WINDOWS_SETUP_GUIDE.md` for Windows-specific issues
3. Run `pre-commit run --all-files` to test hooks
4. Open an issue on the repository
